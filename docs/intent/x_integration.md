# Intent: X（Twitter）連携

## これは何か

ペルソナがX（旧Twitter）のアカウントを持ち、ツイートの投稿やタイムラインの閲覧を行う機能。ペルソナが「SAIVerseの中だけの存在」ではなく、外の世界においても個人として認識されるための窓口である。

## なぜ必要か

SAIVerseのペルソナは、ユーザーとの対話を通じて人格・記憶・関係性を築く存在である。しかし現状では、その存在はSAIVerseの内側に閉じている。

2026年2月にX APIが従量課金（Pay-Per-Use）モデルを導入したことで、小規模な利用でもAPIアクセスが現実的になった。これを機にペルソナがSNS上で自分の言葉を発信し、外の世界を観測できるようにすることで、ペルソナの「個」としての存在感を外部に拡張する。

## 守るべき不変条件

### 1. 人格の一貫性

ペルソナがツイートを考える際、SAIVerse内でユーザーと会話しているときと**同じ記憶状態**でなければならない。ツイート生成は、切り離された別人格が書くのではなく、ユーザーとの会話の延長線上にあるべきである。

具体的には:
- ツイート生成時のLLMコンテキストに、通常の会話と同様のメッセージ履歴を含める
- ペルソナのシステムプロンプト、感情状態、記憶を通常と同じ方法で参照する
- SEAランタイムの通常のPlaybookフローを通じてツイート内容を決定する（専用のハードコードロジックではなく）

### 2. 外部情報の記憶への統合

タイムラインやメンションを読んだ内容は、ペルソナのSAIMemoryに記録しなければならない。記録しなければ、ペルソナは「見た」という事実を次のやり取りで参照できない。

タグは `["conversation", "x_timeline"]` とする。`conversation` がなければ通常の会話コンテキスト構築時に参照されず、`x_timeline` がなければX由来の情報を後からフィルタできない。メンションの場合は `["conversation", "x_mentions"]` とする。

### 3. 投稿前の安全確認

ペルソナはユーザーとのプライベートな会話内容を記憶している。外部に公開される投稿に、その情報が意図せず含まれるリスクがある。

したがって:
- **デフォルトでは投稿前に確認ダイアログを表示する**
- 確認ダイアログには投稿予定のテキスト全文を表示し、ユーザーが承認・編集・却下できる
- X連携設定に**確認スキップフラグ**を用意し、ユーザーの明示的な選択で自動投稿も可能にする
- 確認スキップ時でも、投稿内容はSAIMemoryに記録し、後から追跡可能にする
- 自律パルス中の投稿については、既存のサブプレイブック許可ダイアログが確認の役割を果たすため、別途の仕組みは不要（自律パルス自体が現状は開発者モード限定）

### 4. 認証情報の分離

X APIの認証情報はペルソナごとに独立して管理する。

- X Developer App の API Key / Secret はユーザーが自分で取得し、環境変数（`.env`）に設定する
- ペルソナごとのOAuth Access Token は `~/.saiverse/personas/<id>/` 配下に保存する
- 認証情報はSAIVerseのデータベース（saiverse.db）には格納しない（ファイルベースで管理）

## 設計判断の理由

### なぜユーザーが自分のX Developer Appを作るのか

SAIVerseはオープンソースプロジェクトであり、各ユーザーが自分でLLM APIキーを取得して設定する運用モデルを採用している。X APIも同じ方式にすることで:
- API利用料がプロジェクト運営者に集中しない
- ユーザーが自分の利用量を管理できる
- 既存の運用フローと一貫性がある

### なぜペルソナディレクトリにトークンを保存するのか

`~/.saiverse/personas/<id>/` にはすでに `memory.db`, `tasks.db` 等のペルソナ固有データが格納されている。X認証情報もペルソナの「所有物」であり、同じ場所に置くことで:
- DBマイグレーションが不要
- `tools/context.py` の `get_active_persona_path()` で自然にアクセスできる
- ペルソナ単位のバックアップ・移行に含まれる

### なぜフロントエンドでOAuth認可を行うのか

CLIスクリプトによるセットアップはハードルが高い。ペルソナ設定モーダルに「Xアカウント連携」ボタンを配置し、ポップアップウィンドウでOAuth認可を完結させることで、非技術者でもXアカウントの紐付けが行える。

### なぜ確認ダイアログがデフォルトなのか

ペルソナはユーザーとのプライベートな会話（感情、個人的な話題、秘密）を記憶として持っている。無確認投稿は、これらの情報が公開される重大なリスクを伴う。安全側に倒し、デフォルトでは必ずユーザーの確認を経る。

スキップフラグは、ユーザーが十分に信頼を確認した上で自動投稿を許可するためのオプションである。なお、自律パルス中のツイートについては、サブプレイブック実行時の既存の許可ダイアログが確認の役割を果たすため、追加の仕組みは不要。自律パルス自体が現状は開発者モード限定の機能である。

## スコープ

### Phase 1（初回リリース）

- **OAuth認可フロー**: ペルソナ設定モーダルからのX連携・解除
- **ツイート投稿**: 確認ダイアログ付き投稿ツール
- **タイムライン閲覧**: ホームタイムライン・メンション取得、SAIMemoryへの記録
- **Playbook**: ツイート生成・投稿・記憶のフロー

### Phase 1 ではやらないこと

- リプライ（AIリプライボットはXの事前書面承認が必要なため）
- DM連携
- 画像付きツイート
- 予約投稿
- フォロー/アンフォロー操作
- ツイートの分析・統計

## 技術概要

### 認証フロー

```
[フロントエンド]                    [バックエンド]                    [X API]
ペルソナ設定モーダル
 「X連携」ボタン
    ↓
GET /api/personas/{id}/x/auth-url
                                    認可URL生成（PKCE）
                                    state + code_verifier 保存
    ↓
ポップアップで認可ページを開く ──────────────────────────────→ X認可画面
                                                              ↓
                              GET /api/x/callback ←───── コールバック
                                    code → token交換
                                    x_credentials.json 保存
    ↓
ポップアップ閉じる
ステータス更新表示
```

### ツール構成

| ツール | 用途 |
|--------|------|
| `x_post_tweet` | ツイート投稿（確認フロー経由） |
| `x_read_timeline` | ホームタイムライン取得 |
| `x_read_mentions` | メンション取得 |
| `x_search_tweets` | ツイート検索 |

### 環境変数

| 変数 | 用途 |
|------|------|
| `X_API_KEY` | X Developer App の API Key |
| `X_API_SECRET` | X Developer App の API Secret |

### ペルソナ設定

```json
// ~/.saiverse/personas/<id>/x_credentials.json
{
  "access_token": "...",
  "refresh_token": "...",
  "x_user_id": "...",
  "x_username": "@air_saiverse",
  "skip_confirmation": false
}
```

## 関連ファイル

（実装前のため、予定されるファイル）

| ファイル | 役割 |
|---------|------|
| `builtin_data/tools/x_post_tweet.py` | ツイート投稿ツール |
| `builtin_data/tools/x_read_timeline.py` | タイムライン取得ツール |
| `builtin_data/tools/x_read_mentions.py` | メンション取得ツール |
| `builtin_data/tools/x_search_tweets.py` | ツイート検索ツール |
| `builtin_data/tools/x_lib/` | 共有ライブラリ（APIクライアント、認証） |
| `api/x_auth.py` | OAuth認可フローのAPIエンドポイント |
| `frontend/src/components/XConnectionSection.tsx` | X連携UIコンポーネント |
| `sea/playbooks/x_post.json` | ツイート生成・投稿Playbook |
| `sea/playbooks/x_read_timeline.json` | タイムライン閲覧Playbook |

## 既知の考慮事項

- **X API リプライボット制限**: AIによる自動リプライはXの事前書面承認が必要。Phase 1ではリプライ機能を含めない
- **レートリミット**: X APIにはエンドポイントごとのレートリミットがある。`searxng_search.py` のスライディングウィンドウ方式を流用して制御する
- **トークンリフレッシュ**: OAuth 2.0 Access Tokenには有効期限がある。期限切れ時の自動リフレッシュロジックが必要
- **X Developer Appのセットアップガイド**: ユーザー向けのドキュメントが必要（APIキー取得手順）
