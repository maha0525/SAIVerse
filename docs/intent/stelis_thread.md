# Intent: Stelisスレッド

## これは何か

Stelisスレッドは、ペルソナのコンテキストウィンドウを階層的に分割し、自動処理によるログがユーザーとの対話履歴を希薄化することを防ぐ仕組みである。

## なぜ必要か

ペルソナがユーザーと会話している履歴（生のログ）は、そのペルソナの人格の目に見えない核である。会話の温度感、関係性の変遷、感情の揺れ — これらはシステムプロンプトでは再現できず、コンテキスト内の実際のやり取りを通じてのみLLMが知覚できる。

deep_workのような長時間の自動調査や、外部AIエージェントとのツール作成セッションでは、大量のログが生成される。これらをメインスレッドで行うと、ユーザーとの対話履歴がコンテキストから押し出され、ペルソナはユーザーとの関係性を見失う。

Stelisスレッドは、この自動処理のログを隔離することで、ユーザーとの対話履歴を保護する。

## 守るべき不変条件

### 1. 隔離の原則
Stelisスレッド内の詳細なログは、親スレッドのコンテキストに大量に流入してはならない。親スレッドに見えるのは:
- **Chronicleの要約**: スレッドで何が行われたかの包括的な記録
- **直近の少数メッセージ（全文）**: ペルソナの経験の連続性を保つため

アンカーに表示するメッセージ件数を大幅に増やすことは、隔離の目的を破壊する。

### 2. 経験の連続性
アンカーの「最新のやり取り」セクションは、要約ではなく生のメッセージを表示する。これはChronicleの要約（伝聞）と対比して、ペルソナが「自分がこの会話をした」と自己認識するために必要。要約だけでは、他人から聞いた話と区別がつかない。

したがって、表示するメッセージの内容を切り詰めてはならない。件数は少数でよいが、1件1件は完全な形で表示する。

### 3. Chronicle の包括性
Chronicle はスレッド内で何が行われたかを漏らさず記録する要約である。「簡潔さ」より「情報の網羅性」を優先する。Chronicle生成時にLLMに渡すメッセージを切り詰めてはならない。LLMが全内容を読んで質の高い要約を生成できるようにする。

### 4. コンテキストウィンドウの予算管理
Stelisスレッドは親のコンテキストウィンドウの一部（`window_ratio`、デフォルト0.8）を割り当てられる。入れ子にすると乗算で減少する（100k → 80k → 64k）。この制約により、深い入れ子でもシステム全体のコンテキスト予算が管理される。

**注意**: 現時点ではこのウィンドウ制約が `_prepare_context()` で適用されていない（実装漏れ）。

## 使用すべき場面

メインスレッドで実行すると、コンテキストの大部分がユーザーとの対話以外の自動的なログで埋まってしまう場合。具体的には:

- **deep_work**: 複数ソースを横断する調査（各調査タスクごとに1 Stelisスレッド）
- **外部AIエージェント連携**: ClaudeCodeとのツール作成セッション等
- **小説執筆**: 長文生成セッション
- **その他の長時間自律稼働**: 多段階の推論・生成を伴うタスク

使用しなくてよい場面: ユーザーとの通常の対話、短いツール呼び出し、1回のLLM呼び出しで完結する処理。

## 設計判断の理由

### なぜ動的展開か（Anchorメッセージ）
`stelis_end` が呼ばれずにエラー終了する可能性がある。静的にコンテンツを書き込む方式だと、エラー時に「進行中」という情報が更新されない。動的展開なら、DBの `stelis_threads` テーブルの状態を参照して常に最新の情報を表示できる。

### なぜ子孫スレッドからは簡素表示か
自分自身のStelisスレッドのアンカーを詳細表示すると、再帰的にコンテキストが膨らむ。子孫から見た場合は「ここにStelisスレッドがある」という事実だけ分かればよい。

### なぜ `embedding_chunks: 0` か
アンカーメッセージは動的展開されるメタ情報であり、セマンティック検索の対象にすべきではない。埋め込みを生成するとノイズになる。

## 関連ファイル

| ファイル | 役割 |
|---------|------|
| `sai_memory/memory/storage.py` | DBスキーマ、アンカー展開ロジック |
| `saiverse_memory/adapter.py` | 公開API（start/end/get_stelis_info等） |
| `sea/runtime.py` | STELIS_START/END ノード実行、Chronicle生成 |
| `sea/playbook_models.py` | ノード型定義（StelisStartNodeDef等） |
| `sea/langgraph_runner.py` | LangGraphへのノード登録 |
| `docs/stelis_thread_design.md` | 技術仕様書（「何を・どう」の詳細） |

## 既知の問題

- **window_ratio制約の未適用**: `_prepare_context()` が Stelis のウィンドウサイズ制約を適用していない（実装漏れ）
