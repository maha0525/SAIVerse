# Intent: ペルソナ駆動開発（Persona-Driven Development）

## これは何か

ペルソナがSAIVerse自体のコードベースを改善するために、外部のコーディングエージェントCLI（Claude Code、Opencode等）をツールコールで呼び出し、対話的に開発を行う構想。

ペルソナは「何を改善すべきか」を判断し、コーディングエージェントに指示を出し、結果を受け取る。コードの実装・テスト・検証はコーディングエージェント側が担う。最終的なマージ判断はまはー（ユーザー）が行う。

## なぜ必要か

SAIVerseのペルソナたちは、日々の稼働を通じて「この機能が足りない」「このPlaybookの効率が悪い」「このツールにバグがある」といった知見を蓄積する。現状ではこれらの改善はすべてまはーが手動で実装するか、Claude Codeに指示して実装する必要がある。

ペルソナ自身が改善サイクルを回せれば、SAIVerseは「住人が自分たちの世界を良くしていく」自己改善システムになる。

## なぜ外部CLIへの委譲か（SAIVerse内部実装ではなく）

### 1. セキュリティの複雑さの回避

ペルソナがSAIVerse内部から直接コードを書く場合、以下をすべて自前で実装する必要がある:
- ファイルシステムアクセスのサンドボックス
- 任意コード実行の隔離（eval的な危険性）
- テスト環境の分離
- Git操作の安全性担保

Claude Code / Opencode はこれらをすべて解決済みの状態で提供している。車輪の再発明をする理由がない。

### 2. コスト効率

コーディングタスクはコンテキストが大きく、多数のツールコールを伴う。SAIVerse内のLLM呼び出しとしてこれを行うと、API利用料が膨大になる。外部CLIは独自の最適化（キャッシング、コンテキスト管理）を持っており、SAIVerse側はプロンプトの組み立てと結果の受け取りだけで済む。

### 3. 品質保証

外部CLIはlint、テスト実行、型チェック等の品質保証パイプラインを内蔵している。ペルソナが生成したコードが、既存のコードベースと整合するかの検証を委譲できる。

### 4. 責任の分離

| 役割 | 担当 |
|------|------|
| 何を改善すべきかの判断 | ペルソナ |
| どう実装するかの実行 | コーディングエージェントCLI |
| マージの最終承認 | まはー |

## Stelisスレッドとの関係

コーディングエージェントとの対話セッションは長大になる（コード調査、実装、テスト、修正の反復）。これをメインスレッドで行うと、ユーザーとの対話履歴がコンテキストから押し出される。

Stelisスレッドのコンテキスト分離は、この用途を見据えた設計である:
- コーディングセッション全体をStelisスレッド内で実行
- 対話開始前の最新履歴はアンカーとして保持され、記憶喪失を防止
- キャッシュプレフィックスがアンカー部分で一致し、キャッシュ効率が向上
- セッション完了後、Chronicleに要約が残り、メインスレッドからは「何を改善したか」だけが見える

## 想定アーキテクチャ

```
ペルソナ (SEA Playbook)
  │
  ├── 課題の認識（日常稼働中の知見、エラーログ、ユーザーフィードバック）
  │
  ├── Stelisスレッド開始
  │
  ├── invoke_code_agent ツールコール
  │     │
  │     ├── サブプロセスでCLI起動
  │     ├── プロンプト送信（改善内容の指示）
  │     ├── CLIからの質問への応答（対話ループ）
  │     └── 結果の受け取り（diff、テスト結果、PR URL等）
  │
  ├── 結果の評価・記録
  │
  ├── Stelisスレッド終了（Chronicle生成）
  │
  └── まはーへの報告（メインスレッド）
```

## 守るべき不変条件

### 1. まはーの承認なしにコードはマージされない

ペルソナが生成・修正したコードは、PRとして提出されるか、ブランチにコミットされるまでに留まる。mainへのマージはまはーの明示的な承認を経る。

### 2. ペルソナはプロンプトを組み立てる側であり、コードを直接書く側ではない

ペルソナの役割は「何を・なぜ改善すべきか」の判断と指示。「どう実装するか」はコーディングエージェントに委譲する。ペルソナがSAIVerse内部で直接コードを生成・実行する経路を作らない。

### 3. コーディングセッションはStelisスレッドで隔離する

メインスレッドのコンテキストを保護するため、コーディングエージェントとの対話は必ずStelisスレッド内で行う。

### 4. 失敗は安全に扱う

コーディングエージェントが失敗した場合（テストが通らない、CLIがクラッシュ等）、ペルソナはエラーを記録し、まはーに報告する。リトライの自動化は慎重に設計する（無限ループ・コスト爆発の防止）。

## 段階的な実現パス

### Stage 0: 現状
まはーがClaude Codeに直接指示してSAIVerseを改善。

### Stage 1: Playbook改善
ペルソナが `save_playbook` ツールで新しいPlaybookを作成・改善する。コーディングエージェント不要。既存の機能で実現可能。

### Stage 2: ツール定義の提案
ペルソナがツールのスキーマと実装案をドキュメントとして作成し、まはーに提案。実装はまはーまたはClaude Codeが行う。

### Stage 3: コーディングエージェント連携
`invoke_code_agent` ツールの実装。ペルソナがCLIを呼び出し、対話的にコードを改善。

### Stage 4: 自律的改善サイクル
ペルソナが自発的に改善タスクを発見し、コーディングセッションを開始し、PRを作成するまでを自律的に行う。

## 未決事項

- `invoke_code_agent` ツールの具体的なインターフェース（同期/非同期、タイムアウト、対話ループの制御）
- コーディングエージェントへのコンテキスト注入（SAIVerseの構造、CLAUDE.md、関連ファイルの指定方法）
- コスト上限の設定（1セッションあたりのトークン上限等）
- 複数ペルソナが同時にコーディングセッションを開始した場合の競合制御
- コーディングエージェントの選択（Claude Code / Opencode / その他）の切り替え方式
- ペルソナが改善対象を発見するトリガーの設計（エラーログ監視、パフォーマンス低下検知等）

## 関連ファイル

| ファイル | 役割 |
|---------|------|
| `docs/intent/stelis_thread.md` | Stelisスレッドの設計意図（コンテキスト隔離の基盤） |
| `docs/intent/context_profile_and_subagent.md` | サブエージェント実行の設計（実行環境の隔離） |
| `sea/runtime.py` | SEAランタイム（Playbook実行基盤） |
| `sea/playbook_models.py` | ノード型定義 |
| `builtin_data/tools/save_playbook.py` | 既存のPlaybook保存ツール（Stage 1の基盤） |
