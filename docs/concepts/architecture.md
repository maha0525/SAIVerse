# アーキテクチャ

SAIVerseのシステム全体像を説明します。

## 設計思想

SAIVerseは、自律的なAIエージェント（ペルソナ）が定義された世界（City/Building）の中で相互作用するマルチエージェントシステムです。

- **状態の永続化**: AIや世界の動的な状態は、すべてSQLiteデータベースに一元管理
- **自律性の中心**: 各AIの「魂」は `PersonaCore` クラスに実装され、`run_pulse` で能動的に活動
- **疎結合**: 各コンポーネントは `SAIVerseManager` を通じて連携するが直接依存は最小限
- **分散ネットワーク**: 各Cityは独立したインスタンスとして動作し、SDS経由で動的連携

## コンポーネント構成

```
┌─────────────────────────────────────────────────────────────┐
│                    ユーザーインターフェース                    │
│  ┌───────────────────┐  ┌──────────────────────────────────┐ │
│  │  frontend/        │  │  ui/ (レガシー Gradio)           │ │
│  │  Next.js + TS     │  │  ※移植中・廃止予定                │ │
│  └───────────────────┘  └──────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        API Layer                            │
│  ┌───────────────────┐  ┌──────────────────────────────────┐ │
│  │ api/              │  │ database/api_server.py           │ │
│  │ FastAPI Routes    │  │ City間通信・ペルソナプロキシ       │ │
│  └───────────────────┘  └──────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                  Core Orchestration Layer                   │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ saiverse_manager.py                                   │  │
│  │ 世界の管理者 - 全コンポーネントを統括                    │  │
│  └───────────────────────────────────────────────────────┘  │
│  ┌─────────────┐ ┌─────────────┐ ┌──────────────────────┐   │
│  │ manager/    │ │conversation │ │ occupancy_manager.py │   │
│  │ 各種Mixin   │ │_manager.py  │ │ 移動・占有管理        │   │
│  └─────────────┘ └─────────────┘ └──────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    Persona Layer                            │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ persona/core.py - PersonaCore                         │  │
│  │ AIの魂 - 認知・判断・行動サイクル                       │  │
│  └───────────────────────────────────────────────────────┘  │
│  ┌─────────────────────────┐ ┌───────────────────────────┐  │
│  │ sea/ - Playbook Engine  │ │ remote_persona_proxy.py   │  │
│  │ 行動パターン実行         │ │ 訪問者AIの代理人           │  │
│  └─────────────────────────┘ └───────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     Data Layer                              │
│  ┌─────────────────────────┐ ┌───────────────────────────┐  │
│  │ database/               │ │ sai_memory/               │  │
│  │ SQLite (saiverse.db)    │ │ 記憶システム               │  │
│  └─────────────────────────┘ └───────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## 主要コンポーネント

### SAIVerseManager (saiverse_manager.py)

世界の「神」に相当する中央コンポーネント。

- 全ペルソナとBuildingのインスタンスを管理
- SDSへの登録と他Cityの情報取得
- DBポーリングによる非同期処理（訪問者受け入れなど）
- ワールドエディタのバックエンド

### PersonaCore (persona/core.py)

個々のAIペルソナの「魂」。

- `run_pulse` メソッドで「認知→判断→行動」サイクルを実行
- LLMとの対話、感情管理、行動決定を担う
- SEA/Playbook と連携して複雑な行動パターンを実現

### SEA Playbook Engine (sea/)

AIの行動パターンを定義・実行するエンジン。

- JSONベースのフロー定義（Playbook）
- ノードタイプ: llm, branch, pass, memorize など
- 条件分岐、ループ、サブPlaybook呼び出しに対応

### ConversationManager (conversation_manager.py)

Building内での自律会話を管理。

- 定期的（例: 10秒ごと）にペルソナを指名して `run_pulse` を呼び出し
- Building単位で1インスタンス

### SAIMemory (sai_memory/)

ペルソナの長期記憶を管理。

- 会話ログ・記憶をSQLiteに保存
- SBERT埋め込みによるセマンティック検索
- Memopediaによる構造化知識管理

## データフロー

### ユーザー発話時

1. フロントエンド → API → SAIVerseManager
2. Manager → 対象PersonaCoreへ入力を渡す
3. PersonaCore → SEA Playbookを実行
4. Playbook → LLMを呼び出し応答を生成
5. 応答 → SAIMemoryに記録 → フロントエンドへ返却

### 自律モード

1. ConversationManager → 定期的にPersonaCoreを呼び出し
2. PersonaCore → 状況を認知し、発話が必要か判断
3. 必要なら発話 → Building内の他ペルソナへ通知

## 次のステップ

- [City と Building](./city-building.md) - 仮想世界の構造
- [ペルソナ](./persona.md) - AIの仕組み
