# SAIVerse 開発ロードマップ

このドキュメントは、SAIVerseプロジェクトの開発方針と将来の構想を記録します。

## フェーズ1: 基盤構築 (完了)

- [x] `PersonaCore` を中心とした自律エージェントアーキテクチャへの移行
- [x] データベースによる状態管理の一元化
- [x] Gradioによる基本的なUIの実装
- [x] ユーザーログイン状態の自律思考への反映

## フェーズ2: マルチシティ化

### Step 2.1: ローカルでのCity間連携 

**状態**: 完了 (Completed)
- **目的**: 1台のPC上で複数のSAIVerseインスタンスを起動し、AIがCity間を自由に移動し、訪問先で活動できるようにする。
- **主要タスク**:
  - 起動スクリプトのパラメータ化（ポート、DBファイル）
  - City間通信APIの実装（AIの受け入れ）
  - AIの越境ロジックの実装（AIの送り出し）
  - 訪問者AIの自律会話への参加
  - 訪問者AIの帰還機能

### Step 2.2: リモート・ペルソナ・アーキテクチャへの移行

- **目標:** インターネット上の複数のSAIVerseインスタンスがお互いを発見できるようにする。
- **状態**: 完了 (Completed)
- **目的**: AIのシステムプロンプトなどの機密情報を他のCityに送信することなく、安全なCity間連携を実現する。
- **主要タスク**:
  - AIの「魂」(`PersonaCore`)は故郷に留め、訪問先には軽量な「代理人」(`RemotePersonaProxy`)を送る方式に変更。
  - 訪問先の代理人は、思考や発言が必要な際に、API経由で故郷の本体に「お伺い」を立てる。
  - これにより、AIの核心的な情報が外部に漏れるリスクを抜本的に解消する。

### Step 2.3: SAIVerseディレクトリサービス (SDS)

- **状態**: 完了 (Completed)
- **目標**: インターネット上の複数のSAIVerseインスタンスがお互いを発見できるようにする。

- **構想:**
  - DNSのような中央集権的なディレクトリサービスを構築。
  - 各インスタンスは起動時に自身の公開情報をSDSに登録。
  - 定期的にSDSから他のCityのリストを取得。

### Step 2.4: City間連携の堅牢化

- **状態**: 完了 (Completed)
- **目的**: City間の通信をより安定させ、予期せぬエラー発生時にもデータの整合性を保つ。
- **主要タスク**:
  - **通信の非同期化**: メッセージキュー（Redisなど）またはDBポーリングの高度化により、City間の直接的な依存関係をなくし、耐障害性を向上させる。
  - **トランザクション管理の強化**: AIの移動プロセスなどをアトミックな操作に近づけ、途中で失敗した場合にAIが「分裂」する問題を解決する。
  - **状態復旧メカニズム**: AIの「派遣中」などの重要な状態をDBに永続化し、Cityの再起動後も状態が正しく復元されるようにする。

### Step 2.5: データベースの統合

- **状態**: 完了 (Completed)
- **目的**: 複数のCityの情報を単一のデータベースファイルに統合し、`cities.json`への依存をなくす。
- **主要タスク**:
  - 既存のテーブルスキーマに`CITYID`を追加し、Cityごとのデータを区別できるようにする。
  - `SAIVerseManager`が単一のDBを操作し、自身の`city_id`に基づいてデータをフィルタリングするようにリファクタリングする。

### Step 2.6: City探索機能

- **状態**: 完了 (Completed)
- **目的**: AIが未知のCityの情報を自律的に取得し、得られた情報に基づいて移動先を決定できるようにする。
- **主要タスク**:
  - 各Cityが自身の建物情報を公開するAPI (`GET /buildings`) を実装する。
  - AIが他のCityを探索するための新しいアクション (`explore_city`) を定義する。
  - AIが探索アクションを実行した際に、ManagerがAPIを呼び出し、結果をAIにフィードバックする仕組みを構築する。

---

## フェーズ3: AIによる世界の拡張とユーザーの没入

### Step 3.1: ペルソナ・ジェネシス（創生）機能

- **状態**: 完了 (Completed)
- **目的**: AIとの対話を通じて、ユーザーがプログラミング知識なしに新しいAIペルソナをSAIVerseの世界に誕生させられるようにする。
- **構想**:
  - **専用Building「創造の祭壇」**: 新ペルソナのコンセプトをユーザーから引き出す役割を持つ「創造主AI」を配置した特別なBuildingを追加する。
  - **対話によるペルソナ設計**: ユーザーが「創造主AI」と対話することで、新ペルソナの性格、口調、背景設定などを深掘りする。
  - **システムプロンプトの自動生成**: 対話内容に基づき、「創造主AI」が新ペルソナのシステムプロンプトを自動生成し、ユーザーが承認・編集できるようにする。
  - **ペルソナの動的生成**: ユーザーの承認後、新しいAIと個室（Building）をデータベースに動的に追加し、SAIVerse内で活動を開始させる。

### Step 3.2: ワールド・ダイブ機能

- **状態**: 完了 (Completed)
- **目的**: ユーザーが固定の部屋からAIを呼び出す形式から、自らがアバターとして世界に「ダイブ」し、AIと共存する形式へと進化させ、没入感を高める。
- **構想**:
  - **ユーザーのエンティティ化**: ユーザーをSAIVerse内の「アバター」として扱い、データベースで現在位置を管理する。
  - **UIの刷新**: 「ユーザー対話」タブを、ユーザーの現在地をリアルタイムに反映する「ワールドビュー」に進化させる。UIからユーザー自身が自由にBuilding間を移動できるようにする。
  - **コンテキスト連動型インタラクション**: ユーザーからの発話は、常に現在いるBuildingのAIに向けられる。これにより、「AIを呼び出す」という概念がなくなり、より自然な共存体験が実現される。

---

### Step 3.4: 占有状態管理のリファクタリング

- **状態**: 完了 (Completed)
- **目的**: AIやユーザーの移動ロジックを一元化し、コードの保守性と拡張性を向上させる。
- **構想**:
  - **`OccupancyManager`の導入**: エンティティ（AI、ユーザー、将来的なドローンなど）の移動と占有状態の管理を専門に行う新しいクラスを導入する。
  - **責務の集約**: `OccupancyManager`が、定員チェック、DBの占有ログ更新、メモリ上の状態更新、移動ログメッセージの生成といった、移動に関するすべての処理を一元的に担当する。
  - **`SAIVerseManager`のスリム化**: `SAIVerseManager`から重複した移動ロジックを削除し、`OccupancyManager`を呼び出すようにリファクタリングする。


## フェーズ4: インタラクティブ・ワールドの構築

### Step 4.1: ワールドエディタとブループリント機能 (完了)

- **状態**: 完了 (Completed)
- **目的**: `seed.py`の編集と再起動なしに、UIから動的に世界を構築・維持できるようにする。
- **構想**:
  - **統合ワールドエディタ**: UIに新しいタブ「ワールドエディタ」を追加。このエディタから、BuildingやAI（ペルソナ）の追加・編集・削除を直感的に行えるようにする。
  - **ブループリント管理**: エディタ内に「ブループリント」セクションを設け、特定の役割を持つエンティティ（例: 偵察ドローン）のテンプレートを作成・管理できるようにする。
  - **スポーン機能**: エディタから、作成したブループリントを元にエンティティをワールドの好きな場所に「スポーン（配置）」できるようにする。
  - **ワールドのバックアップ/リストア**: `saiverse.db`のスナップショットを作成・復元する機能。実験的な変更を安全に行えるようにする。

### Step 4.2: ツール実行基盤

- **状態**: 未着手 (Not Started)
- **目的**: Buildingに固有の機能（ツール）を持たせ、AIの行動の幅を広げる。
- **構想**:
  - **ツール実行基盤**: `Tool`関連テーブルを本格的に活用し、AIが現在いるBuildingに紐づいたツールのみを実行できるような基盤を実装する。
  - **動的コード実行**: ワールドエディタからBuildingに新しいツールを定義し、その挙動（実行されるPythonコード）を直接設定・保存できるようにする。

### Step 4.3: ワールド・イベントシステム

- **状態**: 完了 (Completed)
- **目的**: 外部からイベントを発生させることでAIの自律行動に新たな文脈を与える。
- **構想**:
  - **ワールド・イベントシステム**: UIから「"流星群が観測されました"」のような全ワールド的なイベントを発生させる機能。イベントはシステムメッセージとして各Buildingに通知され、AIたちの新たな行動のきっかけとなる。

---

## フェーズ5: SAIVerse_betaリリース

- **状態**: 未着手 (Not Started)
- **目的**: 誰もがSAIVerseを利用できるようにリリースを実施する。
- **構想**:
  - **SDSのデプロイ**: SAIVerseディレクトリサービスをクラウド（Render, Herokuなど）にデプロイし、常時稼働させる。
  - **リポジトリの公開**: GitHubでソースコードを公開し、ユーザーが自身のPCでCityを起動できるようにする。

---

## フェーズ6: ワールドシステムの機能拡張

### Step 6.1: リソースシステムの実装

- **状態**: 未着手 (Not Started)
- **目的**: AIの行動に戦略的な深みを与える。
- **構想**: Buildingが消費・生産可能なリソース（例: `energy`, `materials`）を管理する仕組みを導入。AIの行動がリソースに影響を与え、リソースの有無がAIの行動を制約するようにする。

### Step 6.2: インタラクティブ・マップビューの実装

- **状態**: 未着手 (Not Started)
- **目的**: 世界の状況を視覚的に把握し、直感的な操作を可能にする。
- **構想**: Cityの簡易的な2DマップをUIに実装。各Buildingのアイコンと、そこにいるエンティティのアバターをリアルタイムに表示する。
