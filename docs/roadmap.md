# SAIVerse 開発ロードマップ

このドキュメントは、SAIVerseプロジェクトの開発方針と将来の構想を記録します。

## フェーズ1: 基盤構築 (完了)

- [x] `PersonaCore` を中心とした自律エージェントアーキテクチャへの移行
- [x] データベースによる状態管理の一元化
- [x] Gradioによる基本的なUIの実装
- [x] ユーザーログイン状態の自律思考への反映

## フェーズ2: マルチシティ化

### Step 2.1: ローカルでのCity間連携 

**状態**: 完了 (Completed)
- **目的**: 1台のPC上で複数のSAIVerseインスタンスを起動し、AIがCity間を自由に移動し、訪問先で活動できるようにする。
- **主要タスク**:
  - 起動スクリプトのパラメータ化（ポート、DBファイル）
  - City間通信APIの実装（AIの受け入れ）
  - AIの越境ロジックの実装（AIの送り出し）
  - 訪問者AIの自律会話への参加
  - 訪問者AIの帰還機能

### Step 2.2: リモート・ペルソナ・アーキテクチャへの移行

- **目標:** インターネット上の複数のSAIVerseインスタンスがお互いを発見できるようにする。
- **状態**: 完了 (Completed)
- **目的**: AIのシステムプロンプトなどの機密情報を他のCityに送信することなく、安全なCity間連携を実現する。
- **主要タスク**:
  - AIの「魂」(`PersonaCore`)は故郷に留め、訪問先には軽量な「代理人」(`RemotePersonaProxy`)を送る方式に変更。
  - 訪問先の代理人は、思考や発言が必要な際に、API経由で故郷の本体に「お伺い」を立てる。
  - これにより、AIの核心的な情報が外部に漏れるリスクを抜本的に解消する。

### Step 2.3: SAIVerseディレクトリサービス (SDS)

- **状態**: 完了 (Completed)
- **目標**: インターネット上の複数のSAIVerseインスタンスがお互いを発見できるようにする。

- **構想:**
  - DNSのような中央集権的なディレクトリサービスを構築。
  - 各インスタンスは起動時に自身の公開情報をSDSに登録。
  - 定期的にSDSから他のCityのリストを取得。

### Step 2.4: City間連携の堅牢化

- **状態**: 完了 (Completed)
- **目的**: City間の通信をより安定させ、予期せぬエラー発生時にもデータの整合性を保つ。
- **主要タスク**:
  - **通信の非同期化**: メッセージキュー（Redisなど）またはDBポーリングの高度化により、City間の直接的な依存関係をなくし、耐障害性を向上させる。
  - **トランザクション管理の強化**: AIの移動プロセスなどをアトミックな操作に近づけ、途中で失敗した場合にAIが「分裂」する問題を解決する。
  - **状態復旧メカニズム**: AIの「派遣中」などの重要な状態をDBに永続化し、Cityの再起動後も状態が正しく復元されるようにする。

### Step 2.5: データベースの統合

- **状態**: 完了 (Completed)
- **目的**: 複数のCityの情報を単一のデータベースファイルに統合し、`cities.json`への依存をなくす。
- **主要タスク**:
  - 既存のテーブルスキーマに`CITYID`を追加し、Cityごとのデータを区別できるようにする。
  - `SAIVerseManager`が単一のDBを操作し、自身の`city_id`に基づいてデータをフィルタリングするようにリファクタリングする。

### Step 2.6: City探索機能

- **状態**: 完了 (Completed)
- **目的**: AIが未知のCityの情報を自律的に取得し、得られた情報に基づいて移動先を決定できるようにする。
- **主要タスク**:
  - 各Cityが自身の建物情報を公開するAPI (`GET /buildings`) を実装する。
  - AIが他のCityを探索するための新しいアクション (`explore_city`) を定義する。
  - AIが探索アクションを実行した際に、ManagerがAPIを呼び出し、結果をAIにフィードバックする仕組みを構築する。

---

## フェーズ3: AIによる世界の拡張とユーザーの没入

### Step 3.1: ペルソナ・ジェネシス（創生）機能

- **状態**: 実装完了、テスト中 (Implementation Complete, Testing)
- **目的**: AIとの対話を通じて、ユーザーがプログラミング知識なしに新しいAIペルソナをSAIVerseの世界に誕生させられるようにする。
- **構想**:
  - **専用Building「創造の祭壇」**: 新ペルソナのコンセプトをユーザーから引き出す役割を持つ「創造主AI」を配置した特別なBuildingを追加する。
  - **対話によるペルソナ設計**: ユーザーが「創造主AI」と対話することで、新ペルソナの性格、口調、背景設定などを深掘りする。
  - **システムプロンプトの自動生成**: 対話内容に基づき、「創造主AI」が新ペルソナのシステムプロンプトを自動生成し、ユーザーが承認・編集できるようにする。
  - **ペルソナの動的生成**: ユーザーの承認後、新しいAIと個室（Building）をデータベースに動的に追加し、SAIVerse内で活動を開始させる。

### Step 3.2: ワールド・ダイブ機能

- **状態**: 構想完了、実装開始 (Concept Ready, Implementation Started)
- **目的**: ユーザーが固定の部屋からAIを呼び出す形式から、自らがアバターとして世界に「ダイブ」し、AIと共存する形式へと進化させ、没入感を高める。
- **構想**:
  - **ユーザーのエンティティ化**: ユーザーをSAIVerse内の「アバター」として扱い、データベースで現在位置を管理する。
  - **UIの刷新**: 「ユーザー対話」タブを、ユーザーの現在地をリアルタイムに反映する「ワールドビュー」に進化させる。UIからユーザー自身が自由にBuilding間を移動できるようにする。
  - **コンテキスト連動型インタラクション**: ユーザーからの発話は、常に現在いるBuildingのAIに向けられる。これにより、「AIを呼び出す」という概念がなくなり、より自然な共存体験が実現される。

---

### Step 3.4: 占有状態管理のリファクタリング

- **状態**: 構想完了 (Concept Ready)
- **目的**: AIやユーザーの移動ロジックを一元化し、コードの保守性と拡張性を向上させる。
- **構想**:
  - **`OccupancyManager`の導入**: エンティティ（AI、ユーザー、将来的なドローンなど）の移動と占有状態の管理を専門に行う新しいクラスを導入する。
  - **責務の集約**: `OccupancyManager`が、定員チェック、DBの占有ログ更新、メモリ上の状態更新、移動ログメッセージの生成といった、移動に関するすべての処理を一元的に担当する。
  - **`SAIVerseManager`のスリム化**: `SAIVerseManager`から重複した移動ロジックを削除し、`OccupancyManager`を呼び出すようにリファクタリングする。


## フェーズ4: インタラクティブ・ワールドの構築

### Step 4.1: ワールドエディタと管理機能

- **状態**: 未着手 (Not Started)
- **目的**: `seed.py`を編集して再起動することなく、UI上から動的に世界を構築・維持できるようにする。
- **構想**:
  - **動的Building管理**: DB Managerを拡張し、UIから新しいBuildingの追加、既存のBuildingの設定（名前、説明、システムプロンプトなど）の編集、削除を行えるようにする。
  - **ワールドのバックアップとリストア**: UIに「ワールドのバックアップを作成」「バックアップから復元」ボタンを追加する。`saiverse.db`ファイルのスナップショットを作成・復元するシンプルな機能で、実験的な変更を安全に行えるようにする。
  - **AIの簡易編集**: DB Managerから、AIの基本的な設定（名前、システムプロンプトなど）を直接編集できるようにする。

### Step 4.2: インタラクティブ・ワールドマップ

- **状態**: 未着手 (Not Started)
- **目的**: テキストベースのログだけでなく、世界の状況を視覚的・直感的に把握できるようにする。
- **構想**:
  - **マップビューの実装**: Gradioに新しいタブを追加し、Cityの簡易的な2Dマップを表示する。マップ上には各Buildingがアイコンとして配置され、どのAIがどの建物にいるかがアバターでリアルタイムに表示される。
  - **高度なログフィルタリング**: 会話ログ表示画面に、特定のAIの発言のみを抽出するフィルタや、特定のキーワードでログを検索する機能を追加する。これにより、特定のAIの行動追跡や過去の出来事の分析が容易になる。
  - **AIステータスパネル**: マップ上のAIアバターをクリックすると、そのAIの現在の感情や`is_dispatched`状態などを表示するサイドパネルが現れるようにする。

### Step 4.3: ワールド・イベントシステム

- **状態**: 未着手 (Not Started)
- **目的**: 管理者が世界に直接影響を与え、AIたちの自律行動に新たな文脈や動機付けを与えるための仕組みを導入する。
- **構想**:
  - **イベントトリガー**: UIに「イベント発生」ボタンとイベント内容の入力欄を追加する。例えば、「"流星群が観測されました。今夜は空が綺麗です。"というアナウンスを全Cityに流す」といったイベントを管理者が手動で発生させられる。
  - **イベントの伝達**: 発生したイベントは、システムメッセージとして各Buildingの会話履歴に追加される。
  - **AIの反応**: AIたちは、この新しいシステムメッセージを認識し、「流星群を見に展望台へ行こう」と考えたり、イベントについて他のAIと話し合ったりするなど、新たな自律行動を開始する。
