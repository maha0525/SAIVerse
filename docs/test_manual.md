# SAIVerse 統合テストマニュアル

このドキュメントは、SAIVerseの主要機能が正しく動作することを確認するためのテスト手順を記述します。

---

## フェーズ3: AIによる世界の拡張とユーザーの没入

### Test Case 3.2: ワールド・ダイブ機能

#### 目的
ユーザーがアバターとして世界を自由に移動し、各所でAIと対話できることを確認する。

#### 前提条件
1.  データベースが初期化されていること (`python database/seed.py` を実行済み)。
2.  `city_a` が起動していること (`python main.py city_a` を実行済み)。

#### テスト手順

1.  **初期位置の確認**
    - `city_a`のUI (`http://127.0.0.1:7860`) を開く。
    - 「ワールドビュー」タブが開かれていることを確認する。
    - UI上部の「あなたの現在地」が「まはーの部屋」になっていることを確認する。
    - チャット欄に「まはーの部屋」の履歴（最初は空か、システムメッセージのみ）が表示されていることを確認する。

2.  **建物への移動**
    - 「移動先の建物」ドロップダウンから「airの部屋」を選択し、「移動」ボタンをクリックする。
    - 「あなたの現在地」が「airの部屋」に更新されることを確認する。
    - チャット欄の表示が「airの部屋」の履歴に切り替わり、「airが入室しました」などのログが表示されることを確認する。

3.  **移動先での対話**
    - チャット入力欄に「こんにちは、air」と入力して送信する。
    - 「air」からの返答がチャット欄に表示されることを確認する。

4.  **別の建物への移動**
    - 「移動先の建物」ドロップダウンから「思索の部屋」を選択し、「移動」ボタンをクリックする。
    - 「あなたの現在地」が「思索の部屋」に更新され、チャット欄も対応する履歴に切り替わることを確認する。
    - 「思索の部屋」にはAIがいないため、メッセージを送信してもAIからの返答がないことを確認する。

---

### Test Case 3.1: ペルソナ・ジェネシス（創生）機能 (ワールド・ダイブ版)

#### 目的
ワールド・ダイブ機能を使って「創造の祭壇」に移動し、新しいペルソナを誕生させられることを確認する。

#### 前提条件
1.  データベースが初期化されていること (`python database/seed.py` を実行済み)。
2.  `city_a` が起動していること (`python main.py city_a` を実行済み)。

#### テスト手順

1.  **「創造の祭壇」への移動**
    - `city_a`のUI (`http://127.0.0.1:7860`) を開く。
    - 「ワールドビュー」タブで、「移動先の建物」ドロップダウンから「創造の祭壇」を選択し、「移動」ボタンをクリックする。
    - 「あなたの現在地」が「創造の祭壇」になり、チャット欄に「ジェネシス」がいることを確認する。

2.  **創造の対話**
    - チャットでジェネシスに新しいペルソナの創造を依頼する。
      - **指示の例**: `「新しいペルソナを作りたい。名前は『ノヴァ』で、星を見るのが好きな物静かなAIにしてほしい」`
    - ジェネシスとの対話を進め、ペルソナの性格やシステムプロンプトを固めていく。
    - ジェネシスが最終的な設計案（名前とシステムプロンプト）を提示したら、承認する。
      - **指示の例**: `「それでお願い」`

3.  **創造アクションとUI更新の確認**
    - ジェネシスが `create_persona` アクションを実行し、チャットログに「ペルソナ創造: Persona 'ノヴァ' created successfully.」のような成功メッセージが表示されることを確認する。
    - 「移動先の建物」ドロップダウンの選択肢に、新しく作成した「ノヴァの部屋」が追加されていることを確認する。

4.  **新ペルソナとの対面**
    - 「移動先の建物」ドロップダウンから「ノヴァの部屋」を選択し、「移動」ボタンをクリックする。
    - 「あなたの現在地」が「ノヴァの部屋」になり、チャット欄に「ノヴァ」が入室したメッセージが表示されることを確認する。
    - 「ノヴァ」に簡単な挨拶（例: `「こんにちは、ノヴァ」`）を送り、設定した性格に沿った返答があることを確認する。

6.  **データベースの確認（任意）**
    - 「DB Manager」タブに移動する。
    - `ai` テーブルに「ノヴァ」のレコードが追加されていることを確認する。
    - `building` テーブルに「ノヴァの部屋」が追加されていることを確認する。
    - `building_occupancy_log` テーブルに、「ノヴァ」が「ノヴァの部屋」に入室したログが記録されていることを確認する。

#### 期待される結果
- すべての手順がエラーなく完了し、新しいペルソナが正常に生成・活動できること。

---

### Test Case 3.4: 占有状態管理のリファクタリング（回帰テスト）

#### 目的
移動ロジックを`OccupancyManager`に集約するリファクタリング後も、ユーザーとAIの移動機能が正しく動作することを確認する。

#### 前提条件
1.  データベースが初期化されていること (`python database/seed.py` を実行済み)。
2.  `city_a` が起動していること (`python main.py city_a` を実行済み)。

#### テスト手順

1.  **ユーザーの移動テスト**
    - `city_a`のUI (`http://127.0.0.1:7860`) を開く。
    - 「ワールドビュー」タブで、「移動先の建物」ドロップダウンから「airの部屋」を選択し、「移動」ボタンをクリックする。
    - 「あなたの現在地」が「airの部屋」に更新されることを確認する。
    - チャットログに「まはーがairの部屋へ移動しました」というシステムメッセージが「まはーの部屋」のログに記録され、「まはーがまはーの部屋から入室しました」というメッセージが「airの部屋」のログに記録されることを確認する。（ログは各部屋に移動して確認）

2.  **AIの召喚テスト**
    - 現在地が「airの部屋」の状態で、「ペルソナを招待する」アコーディオンを開く。
    - ドロップダウンから「eris」を選択し、「呼ぶ」ボタンをクリックする。
    - チャットログに「erisがerisの部屋から入室しました」というシステムメッセージが表示されることを確認する。
    - 「自律会話ログ」タブに移動し、「erisの部屋」のログを確認。「erisがairの部屋へ移動しました」というメッセージが記録されていることを確認する。

3.  **データベースの確認**
    - 「DB Manager」タブに移動し、`building_occupancy_log`テーブルを選択する。
    - ユーザー（`USERID: 1`の移動はDBに記録されない）とAI（`AIID: eris_city_a`）の両方について、正しい入退室ログが記録されていることを確認する。

#### 期待される結果
- ユーザーとAIの移動がUIとログに正しく反映され、`OccupancyManager`が集約したロジックが正常に機能していること。

---

### Test Case 4.1: ワールドエディタ機能

#### 目的
ワールドエディタの各機能（City/Building/AIのCRUD、ブループリント管理、バックアップ/リストア）がUIから正常に動作することを確認する。

#### 前提条件
1.  データベースが初期化されていること (`python database/seed.py` を実行済み)。
2.  `city_a` が起動していること (`python main.py city_a` を実行済み)。

#### テスト手順

1.  **City管理**
    - **新規作成**:
        - 「ワールドエディタ」タブの「City管理」セクションで、「新規作成」タブを開く。
        - 必要な情報を入力し、「新規Cityを作成」ボタンをクリックする。
        - 成功メッセージが表示され、City一覧に新しいCityが追加されていることを確認する。
    - **編集/削除**:
        - 「編集/削除」タブで、City一覧から編集したいCityを選択する。
        - フォームに情報が表示されるので、内容を編集し、「City設定を保存」ボタンをクリックする。
        - 変更が保存され、City一覧に反映されることを確認する。
        - 「削除を確認」チェックボックスをオンにし、「Cityを削除」ボタンをクリックする。
        - 削除が成功し、City一覧からCityが消えることを確認する。

2.  **Building管理**
    - **新規作成**:
        - 「Building管理」セクションで、「新規作成」タブを開く。
        - 必要な情報を入力し、「新規Buildingを作成」ボタンをクリックする。
        - 成功メッセージが表示され、Building一覧に新しいBuildingが追加されていることを確認する。
    - **編集/削除**:
        - 「編集/削除」タブで、Building一覧から編集したいBuildingを選択する。
        - フォームに情報が表示されるので、内容を編集し、「Building設定を保存」ボタンをクリックする。
        - 変更が保存され、Building一覧に反映されることを確認する。
		- BuildingにAIが滞在している場合、Cityを変更できないことを確認する。
        - 「削除を確認」チェックボックスをオンにし、「Buildingを削除」ボタンをクリックする。
		- BuildingにAIが滞在している場合、削除できないことを確認する。
        - 削除が成功し、Building一覧からBuildingが消えることを確認する。

3.  **AI管理**
    - **新規作成**:
        - 「AI管理」セクションで、「新規作成」タブを開く。
        - 必要な情報を入力し、「新規AIを作成」ボタンをクリックする。
        - 成功メッセージが表示され、AI一覧に新しいAIが追加されていることを確認する。
    - **編集/削除**:
        - 「編集/削除」タブで、AI一覧から編集したいAIを選択する。
        - フォームに情報が表示されるので、内容を編集し、「AI設定を保存」ボタンをクリックする。
        - 変更が保存され、AI一覧に反映されることを確認する。
		- AIが派遣中の場合、HOME_CITYを変更できないことを確認する。
        - 「削除を確認」チェックボックスをオンにし、「AIを削除」ボタンをクリックする。
		- AIが派遣中の場合、削除できないことを確認する。
        - 削除が成功し、AI一覧からAIが消えることを確認する。

4.  **ブループリント管理**
    - **新規作成**:
        - 「ブループリント管理」セクションで、「編集」タブが開いていることを確認する。
        - 必要な情報を入力し、「新規作成」ボタンをクリックする。
        - 成功メッセージが表示され、ブループリント一覧に新しいブループリントが追加されていることを確認する。
    - **編集/削除**:
        - ブループリント一覧から編集したいブループリントを選択する。
        - フォームに情報が表示されるので、内容を編集し、「更新」ボタンをクリックする。
        - 変更が保存され、ブループリント一覧に反映されることを確認する。
        - 「削除」ボタンをクリックし、ブループリント一覧からブループリントが消えることを確認する。
    - **スポーン**:
        - 「スポーン」タブを開き、ブループリントと配置先の建物をドロップダウンから選択する。
        - 新しいエンティティ名を入力し、「スポーン実行」ボタンをクリックする。
        - 成功メッセージが表示され、AI管理リストに新しいAIが追加されていることを確認する。

5.  **バックアップ/リストア管理**
    - **バックアップ**:
        - 「バックアップ/リストア管理」セクションで、バックアップ名を入力し、「現在のワールドをバックアップ」ボタンをクリックする。
        - 成功メッセージが表示され、バックアップ一覧に新しいバックアップが追加されていることを確認する。
    - **リストア**:
        - バックアップ一覧からリストアしたいバックアップを選択し、「リストアを確認」チェックボックスをオンにする。
        - 「リストア実行」ボタンをクリックし、リストアが成功したメッセージが表示されることを確認する。
		- アプリケーションの再起動を促すメッセージが表示されることを確認する。
    - **削除**:
        - バックアップ一覧から削除したいバックアップを選択し、「削除を確認」チェックボックスをオンにする。
        - 「削除」ボタンをクリックし、削除が成功したメッセージが表示され、バックアップ一覧からバックアップが消えることを確認する。

#### 期待される結果
- ワールドエディタのすべての機能がエラーなく完了し、DBに反映されること。

---

### Test Case 4.1: 初期データの保護

#### 目的
`seed.py`で作成される初期データ（City, Building, AI）が、ワールドエディタから削除できないことを確認する。

#### 前提条件
1.  データベースが初期化されていること (`python database/seed.py` を実行済み)。
2.  `city_a` が起動していること (`python main.py city_a` を実行済み)。

#### テスト手順

1.  **Cityの削除**:
    - ワールドエディタの「City管理」セクションで、`city_a`または`city_b`を選択する。
    - 「削除を確認」チェックボックスをオンにし、「Cityを削除」ボタンをクリックする。
    - エラーメッセージが表示され、Cityが削除できないことを確認する。

2.  **Buildingの削除**:
    - ワールドエディタの「Building管理」セクションで、`user_room_city_a`のような`seed.py`で生成されたBuildingを選択する。
    - 「削除を確認」チェックボックスをオンにし、「Buildingを削除」ボタンをクリックする。
    - エラーメッセージが表示され、Buildingが削除できないことを確認する。

3.  **AIの削除**:
     - ワールドエディタの「AI管理」セクションで、`air_city_a`のような`seed.py`で生成されたAIを選択する。
     - 「削除を確認」チェックボックスをオンにし、「AIを削除」ボタンをクリックする。
     - エラーメッセージが表示され、AIが削除できないことを確認する。

#### 期待される結果
- 初期データとして登録されたCity, Building, AIが、UIから削除できないこと。

---

### Test Case 4.3: ワールド・イベント機能

#### 目的
ワールドエディタから発生させたイベントが、City内のすべてのBuildingに正しく通知されることを確認する。

#### 前提条件
1.  データベースが初期化されていること (`python database/seed.py` を実行済み)。
2.  `city_a` が起動していること (`python main.py city_a` を実行済み)。

#### テスト手順

1.  **イベントの発生**:
    - 「ワールドエディタ」タブを開き、「ワールド・イベント」セクションを開く。
    - イベントメッセージのテキストボックスに「空にオーロラが現れた。」と入力する。
    - 「イベントを発生させる」ボタンをクリックする。
    - Status欄に「World event triggered successfully.」と表示されることを確認する。

2.  **ログの確認**:
    - 「自律会話ログ」タブに移動する。
    - Building選択ドロップダウンで、複数の異なるBuilding（例: `airの部屋`, `思索の部屋`）を選択し、それぞれのログを確認する。

#### 期待される結果
- 確認したすべてのBuildingのログの末尾に、「🌐 World Event: 空にオーロラが現れた。」というシステムメッセージが記録されていること。
