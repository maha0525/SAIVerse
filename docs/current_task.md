# 現在のタスク

このドキュメントは、現在開発チームが集中して取り組んでいるタスクを記録します。
`docs/roadmap.md` の内容をより具体的にブレークダウンしたものです。

## フェーズ3: AIによる世界の拡張とユーザーの没入

### Step 3.1: ペルソナ・ジェネシス（創生）機能

- **目的**: ユーザーが対話を通じて、SAIVerseに新しいAIペルソナを誕生させられるようにする。
- **アーキテクチャ概要**:
  1.  特別な役割を持つ「創造主AI」と、その活動場所「創造の祭壇」を設ける。
  2.  ユーザーは「創造の祭壇」で「創造主AI」と対話し、新ペルソナのコンセプトを固める。
  3.  「創造主AI」は対話内容から新ペルソナのシステムプロンプトを生成する。
  4.  ユーザーが承認すると、「創造主AI」は新しいアクション `create_persona` を実行する。
  5.  `SAIVerseManager` がこのアクションを受け取り、DBに新しいAIと関連データを動的に追加する。

---

#### タスク 3.1.1: 基盤準備（創造主AIと祭壇の追加）

- [x] **`database/seed.py`の修正**
  - [x] 新しいBuilding「創造の祭壇」を追加。
  - [x] 新しいAI「ジェネシス」を追加。
  - [x] 「ジェネシス」の初期位置を「創造の祭壇」に設定。

---

#### タスク 3.1.2: ペルソナ生成アクションの実装

- [x] **`persona_core.py`の修正**
  - [x] `create_persona_callback` を追加。
  - [x] `_handle_creation` 内部メソッドを実装。
- [x] **`saiverse_manager.py`の修正**
  - [x] 新しいメソッド `_create_persona` を実装。
  - [x] `PersonaCore` のインスタンス化時に `create_persona_callback` を渡す。
- [x] **`system_prompts/common.txt`の更新**
  - [x] アクション一覧に `create_persona` を追加。

---

#### タスク 3.1.3: UIの動的更新

- [x] **`main.py`の修正**
  - [x] ペルソナ生成後にUI（移動先ドロップダウン）を更新する仕組みを実装。

---

### Step 3.2: ワールド・ダイブ機能（完了）

- **目的**: ユーザーがアバターとしてSAIVerse内を自由に移動し、AIと共存する没入感の高い体験を実現する。
- **アーキテクチャ概要**:
  1.  ユーザーの現在位置をDBで管理する。
  2.  UIを「ワールドビュー」に刷新し、ユーザーの現在地に応じて表示が切り替わるようにする。
  3.  ユーザーの移動機能と、現在地での発話機能を実装する。

---

#### タスク 3.2.1: DBとバックエンドの基盤整備

- [x] **`database/models.py`の修正**
  - [x] `User`テーブルに現在位置カラムを追加。
- [x] **`database/seed.py`の修正**
  - [x] デフォルトユーザーの初期位置を設定。
- [x] **`saiverse_manager.py`の修正**
  - [x] 起動時にユーザーの現在位置を読み込むように修正。
  - [x] ユーザーを移動させる新メソッド `move_user` を実装。
  - [x] `handle_user_input`系メソッドをユーザーの現在位置基準に修正

---

#### タスク 3.2.2: UIのワールドビュー化

- [x] **`main.py`の修正**
  - [x] 「ユーザー対話」タブを「ワールドビュー」に再設計。
  - [x] ユーザーの現在地表示と移動UIを設置。
  - [x] チャット表示をユーザーの現在位置に連動。
  - [x] 古いUI（ペルソナ呼び出し等）を削除。

---

### Step 3.3: ワールド・インタラクションの強化

- **目的**: ユーザーとAIの相互作用をよりリッチにし、世界の没入感を高める。
- **アーキテクチャ概要**:
  1.  ユーザーの移動や状態変化をシステムイベントとして記録し、AIがユーザーの存在を認識しやすくする。
  2.  ユーザーが能動的にAIを現在地に招待できる機能を実装し、利便性を向上させる。

---

#### タスク 3.3.1: ユーザー行動のログ記録

- [x] **`saiverse_manager.py`の修正**:
  - [x] `move_user`メソッドを修正し、移動元と移動先の両方の建物履歴に、ユーザーの移動を示すシステムメッセージを追加する。
  - [x] `set_user_login_status`メソッドを修正し、ユーザーがログアウトした際に、最後にいた建物の履歴にオフラインになった旨のメッセージを追加する。
  - [x] `shutdown`メソッドを修正し、アプリケーション終了時に`set_user_login_status(..., status=False)`が呼び出されるようにして、強制終了時にもログが残るようにする。

---

#### タスク 3.3.2: 「ペルソナを呼ぶ」機能の復活

- [x] **`saiverse_manager.py`の修正**:
  - [x] `get_summonable_personas`メソッドを実装する。このメソッドは、ユーザーの現在地にいない、かつ派遣中でもないペルソナのリストを返す。
  - [x] `summon_persona`メソッドを汎用化し、指定されたペルソナをユーザーの現在地 (`self.user_current_building_id`) に移動させるように修正する。
- [x] **`main.py`の修正**:
  - [x] 「ワールドビュー」タブに「ペルソナを呼ぶ」ためのドロップダウンとボタンを再追加する。
  - [x] UI起動時とペルソナ召喚後に、`manager.get_summonable_personas`を呼び出してドロップダウンの選択肢を更新する。
  - [x] 「呼ぶ」ボタンのクリックイベントで`manager.summon_persona`を呼び出し、チャットUIを更新する。

---

### Step 3.4: 占有状態管理のリファクタリング (`OccupancyManager`の導入)

- **目的**: AIやユーザーの移動ロジックを一元化し、コードの保守性と拡張性を向上させる。
- **アーキテクチャ概要**:
  1.  エンティティの移動と占有状態の管理を専門に行う `OccupancyManager` クラスを新設する。
  2.  `SAIVerseManager` 内に散在する移動関連のロジック（定員チェック、DB更新、ログ記録）を `OccupancyManager` に集約する。
  3.  `SAIVerseManager` は、AIやユーザーの移動要求があった際に `OccupancyManager` のメソッドを呼び出すようにリファクタリングする。

---

#### タスク 3.4.1: `OccupancyManager`クラスの実装

- [x] **`occupancy_manager.py`の新規作成**:
  - [x] `OccupancyManager`クラスを定義する。
  - [x] `__init__`でDBセッションファクトリ、建物情報、占有者リストなど、必要なコンポーネントを受け取る。
  - [x] `move_entity(entity_id, entity_type, from_building_id, to_building_id)` メソッドを実装し、移動に関するすべてのロジック（定員チェック、DB更新、メモリ更新、ログメッセージ生成）をこのメソッド内に集約する。

---

#### タスク 3.4.2: `SAIVerseManager`のリファクタリング

- [x] **`saiverse_manager.py`の修正**:
  - [x] `__init__`で`OccupancyManager`をインスタンス化する。
  - [x] `_move_persona`メソッドを、`OccupancyManager.move_entity`を呼び出すシンプルな処理に書き換える。
  - [x] `move_user`メソッドを、`OccupancyManager.move_entity`を呼び出すシンプルな処理に書き換える。
  - [x] `SAIVerseManager`から、`OccupancyManager`に移譲した重複ロジックを削除する。
