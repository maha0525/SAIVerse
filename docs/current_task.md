# 現在のタスク

このドキュメントは、現在開発チームが集中して取り組んでいるタスクを記録します。
`docs/roadmap.md` の内容をより具体的にブレークダウンしたものです。

## フェーズ3: AIによる世界の拡張とユーザーの没入

### Step 3.1: ペルソナ・ジェネシス（創生）機能

- **目的**: ユーザーが対話を通じて、SAIVerseに新しいAIペルソナを誕生させられるようにする。
- **アーキテクチャ概要**:
  1.  特別な役割を持つ「創造主AI」と、その活動場所「創造の祭壇」を設ける。
  2.  ユーザーは「創造の祭壇」で「創造主AI」と対話し、新ペルソナのコンセプトを固める。
  3.  「創造主AI」は対話内容から新ペルソナのシステムプロンプトを生成する。
  4.  ユーザーが承認すると、「創造主AI」は新しいアクション `create_persona` を実行する。
  5.  `SAIVerseManager` がこのアクションを受け取り、DBに新しいAIと関連データを動的に追加する。

---

#### タスク 3.1.1: 基盤準備（創造主AIと祭壇の追加）

- [x] **`database/seed.py`の修正**
  - [x] 新しいBuilding「創造の祭壇」を追加。
  - [x] 新しいAI「ジェネシス」を追加。
  - [x] 「ジェネシス」の初期位置を「創造の祭壇」に設定。

---

#### タスク 3.1.2: ペルソナ生成アクションの実装

- [x] **`persona_core.py`の修正**
  - [x] `create_persona_callback` を追加。
  - [x] `_handle_creation` 内部メソッドを実装。
- [x] **`saiverse_manager.py`の修正**
  - [x] 新しいメソッド `_create_persona` を実装。
  - [x] `PersonaCore` のインスタンス化時に `create_persona_callback` を渡す。
- [x] **`system_prompts/common.txt`の更新**
  - [x] アクション一覧に `create_persona` を追加。

---

#### タスク 3.1.3: UIの動的更新

- [x] **`main.py`の修正**
  - [x] ペルソナ生成後にUI（移動先ドロップダウン）を更新する仕組みを実装。

---

### Step 3.2: ワールド・ダイブ機能（完了）

- **目的**: ユーザーがアバターとしてSAIVerse内を自由に移動し、AIと共存する没入感の高い体験を実現する。
- **アーキテクチャ概要**:
  1.  ユーザーの現在位置をDBで管理する。
  2.  UIを「ワールドビュー」に刷新し、ユーザーの現在地に応じて表示が切り替わるようにする。
  3.  ユーザーの移動機能と、現在地での発話機能を実装する。

---

#### タスク 3.2.1: DBとバックエンドの基盤整備

- [x] **`database/models.py`の修正**
  - [x] `User`テーブルに現在位置カラムを追加。
- [x] **`database/seed.py`の修正**
  - [x] デフォルトユーザーの初期位置を設定。
- [x] **`saiverse_manager.py`の修正**
  - [x] 起動時にユーザーの現在位置を読み込むように修正。
  - [x] ユーザーを移動させる新メソッド `move_user` を実装。
  - [x] `handle_user_input`系メソッドをユーザーの現在位置基準に修正

---

#### タスク 3.2.2: UIのワールドビュー化

- [x] **`main.py`の修正**
  - [x] 「ユーザー対話」タブを「ワールドビュー」に再設計。
  - [x] ユーザーの現在地表示と移動UIを設置。
  - [x] チャット表示をユーザーの現在位置に連動。
  - [x] 古いUI（ペルソナ呼び出し等）を削除。

---

### Step 3.3: ワールド・インタラクションの強化

- **目的**: ユーザーとAIの相互作用をよりリッチにし、世界の没入感を高める。
- **アーキテクチャ概要**:
  1.  ユーザーの移動や状態変化をシステムイベントとして記録し、AIがユーザーの存在を認識しやすくする。
  2.  ユーザーが能動的にAIを現在地に招待できる機能を実装し、利便性を向上させる。

---

#### タスク 3.3.1: ユーザー行動のログ記録

- [x] **`saiverse_manager.py`の修正**:
  - [x] `move_user`メソッドを修正し、移動元と移動先の両方の建物履歴に、ユーザーの移動を示すシステムメッセージを追加する。
  - [x] `set_user_login_status`メソッドを修正し、ユーザーがログアウトした際に、最後にいた建物の履歴にオフラインになった旨のメッセージを追加する。
  - [x] `shutdown`メソッドを修正し、アプリケーション終了時に`set_user_login_status(..., status=False)`が呼び出されるようにして、強制終了時にもログが残るようにする。

---

#### タスク 3.3.2: 「ペルソナを呼ぶ」機能の復活

- [x] **`saiverse_manager.py`の修正**:
  - [x] `get_summonable_personas`メソッドを実装する。このメソッドは、ユーザーの現在地にいない、かつ派遣中でもないペルソナのリストを返す。
  - [x] `summon_persona`メソッドを汎用化し、指定されたペルソナをユーザーの現在地 (`self.user_current_building_id`) に移動させるように修正する。
- [x] **`main.py`の修正**:
  - [x] 「ワールドビュー」タブに「ペルソナを呼ぶ」ためのドロップダウンとボタンを再追加する。
  - [x] UI起動時とペルソナ召喚後に、`manager.get_summonable_personas`を呼び出してドロップダウンの選択肢を更新する。
  - [x] 「呼ぶ」ボタンのクリックイベントで`manager.summon_persona`を呼び出し、チャットUIを更新する。

---

### Step 3.4: 占有状態管理のリファクタリング (`OccupancyManager`の導入)

- **目的**: AIやユーザーの移動ロジックを一元化し、コードの保守性と拡張性を向上させる。
- **アーキテクチャ概要**:
  1.  エンティティの移動と占有状態の管理を専門に行う `OccupancyManager` クラスを新設する。
  2.  `SAIVerseManager` 内に散在する移動関連のロジック（定員チェック、DB更新、ログ記録）を `OccupancyManager` に集約する。
  3.  `SAIVerseManager` は、AIやユーザーの移動要求があった際に `OccupancyManager` のメソッドを呼び出すようにリファクタリングする。

---

#### タスク 3.4.1: `OccupancyManager`クラスの実装

- [x] **`occupancy_manager.py`の新規作成**:
  - [x] `OccupancyManager`クラスを定義する。
  - [x] `__init__`でDBセッションファクトリ、建物情報、占有者リストなど、必要なコンポーネントを受け取る。
  - [x] `move_entity(entity_id, entity_type, from_building_id, to_building_id)` メソッドを実装し、移動に関するすべてのロジック（定員チェック、DB更新、メモリ更新、ログメッセージ生成）をこのメソッド内に集約する。

---

#### タスク 3.4.2: `SAIVerseManager`のリファクタリング

- [x] **`saiverse_manager.py`の修正**:
  - [x] `__init__`で`OccupancyManager`をインスタンス化する。
  - [x] `_move_persona`メソッドを、`OccupancyManager.move_entity`を呼び出すシンプルな処理に書き換える。
  - [x] `move_user`メソッドを、`OccupancyManager.move_entity`を呼び出すシンプルな処理に書き換える。
  - [x] `SAIVerseManager`から、`OccupancyManager`に移譲した重複ロジックを削除する。

---

## フェーズ4: インタラクティブ・ワールドの構築

### Step 4.1.0: 起動モード設定機能 (完了)

- **目的**: Cityの起動モード（オンライン/オフライン）をDBで管理し、起動時に反映させる。
- [x] **`database/models.py`の修正**:
  - [x] `City`テーブルに、起動モードを管理する `START_IN_ONLINE_MODE` (Boolean) カラムを追加する。
- [x] **`database/seed.py`の修正**:
  - [x] Cityの初期データに `START_IN_ONLINE_MODE` の値を設定する（例: city_aはTrue, 他はFalse）。
- [x] **`saiverse_manager.py`の修正**:
  - [x] `__init__`で `START_IN_ONLINE_MODE` を読み込み、その値に応じてSDSへの接続処理をスキップ、または実行するように修正する。

---

### Step 4.1: ワールドエディタとブループリント機能

- **目的**: `seed.py`の編集や再起動なしに、UIから動的に世界を構築・維持できるようにする。
- **アーキテクチャ概要**:
  1.  UIに「ワールドエディタ」タブを新設し、DBとメモリの状態を同期的に操作するバックエンド関数群を実装する。
  2.  City, Building, AI（ペルソナ）のCRUD（作成、読み取り、更新、削除）機能を実装する。
  3.  「ブループリント」という概念を導入し、特定の役割を持つエンティティのテンプレートを作成・管理できるようにする。
  4.  ブループリントからエンティティをワールドに「スポーン（配置）」させる機能を実装する。

---

#### タスク 4.1.1: ワールドエディタUIの基盤構築 (完了)

- [x] **`main.py`の修正**:
  - [x] 新しいタブ「ワールドエディタ」を追加する。
  - [x] エディタ内に「City管理」「Building管理」「AI管理」「ブループリント管理」のセクション（`gr.Accordion`など）を設ける。
  - [x] 各セクションに、DBから取得した既存のデータを一覧表示する`gr.DataFrame`を配置する。
  - [x] 一覧の行を選択すると、その詳細が編集フォームに表示されるようにする。

---

#### タスク 4.1.2: City/Building/AIの更新(Update)機能 (完了)

- [x] **`saiverse_manager.py`の修正**:
  - [x] `update_city`, `update_building`, `update_ai` メソッドを実装する。
- [x] **`main.py`の修正**:
  - [x] 各管理セクションに、設定を更新するためのフォームとボタンを配置する。
  - [x] 各ボタンのクリックイベントで、対応する`SAIVerseManager`のメソッドを呼び出し、UIを更新する。

---

#### タスク 4.1.3: ブループリント機能のバックエンド実装 (完了)

- [x] **`database/models.py`の修正**:
  - [x] 新しいテーブル `Blueprint` を定義する。
- [x] **`database/seed.py`の修正**:
  - [x] `Blueprint`テーブルがDBに作成されるようにする。
- [x] **`saiverse_manager.py`の修正**:
  - [x] ブループリントを管理するためのメソッド群（`get_blueprints`, `create_blueprint`など）を実装する。
  - [x] ブループリントから新しいエンティティを生成する `spawn_entity_from_blueprint` メソッドを実装する。

---

#### タスク 4.1.4: ブループリントのUIとスポーン機能 (完了)

- [x] **`main.py`の修正**:
  - [x] ブループリント管理セクションに、ブループリントのCRUD UIを実装する。
  - [x] ブループリント一覧から「スポーン」タブを設け、新しいエンティティをワールドに配置するUIを実装する。
  - [x] 決定後、`spawn_entity_from_blueprint`を呼び出し、AI管理リストを更新する。

---

#### タスク 4.1.5: City/Building/AIの作成(Create)と削除(Delete)機能 (完了)

- [x] **`saiverse_manager.py`の修正**:
  - [x] `create_city`, `delete_city`, `create_building`, `delete_building`, `create_ai`, `delete_ai` メソッドを実装する。
  - [x] 削除時には依存関係（Building内のAIなど）をチェックし、安全性を確保する。
- [x] **`main.py`の修正**:
  - [x] 各管理セクションに「新規作成」タブと「編集/削除」タブを設ける。
  - [x] 各タブに、作成・削除を行うためのフォームとボタンを配置する。
  - [x] 削除ボタンには誤操作防止の確認チェックボックスを設ける。
  - [x] 各ボタンのクリックイベントで、対応する`SAIVerseManager`のメソッドを呼び出し、UIを更新する。

---

#### タスク 4.1.6: ワールドのバックアップ/リストア機能

- [x] **`saiverse_manager.py`の修正**:
  - [x] `backup_world(backup_name)`: 現在の `saiverse.db` を指定された名前でバックアップフォルダにコピーするメソッドを実装する。
  - [x] `restore_world(backup_name)`: 指定されたバックアップファイルで現在の `saiverse.db` を上書きするメソッドを実装する。
  - [x] `get_backups()`: 利用可能なバックアップファイルの一覧を返すメソッドを実装する。
- [x] **`main.py`の修正**:
  - [x] ワールドエディタに「バックアップ/リストア」セクションを新設する。
  - [x] バックアップの作成、リストア、削除を行うためのUIを実装する。リストア実行時には誤操作防止の確認を求める。

---

### Step 4.2: ツール実行基盤

- **目的**: Buildingに固有の機能（ツール）を持たせ、AIがそれを実行できるようにする。ワールドエディタから動的にツールのコードを定義・編集できるようにする。
- **アーキテクチャ概要**:
  1.  ツールは`tools/`ディレクトリ以下に`.py`ファイルとして実装する（プラグイン形式）。
  2.  `Tool`テーブルは、ツールのメタデータ（名前、説明）と、実行するPythonモジュールへのパスを管理する。
  3.  `SAIVerseManager`は、`importlib`を用いてツールを動的にロードし、実行する。
  4.  AIは`use_tool`アクションを通じて、現在いるBuildingで利用可能なツールを実行する。

---

#### タスク 4.2.1: データベースとバックエンドの基盤実装

- [ ] **`database/models.py`の修正**:
  - [ ] `Tool`テーブルに、実行するPythonモジュールへのパスを保存する`MODULE_PATH` (String) カラムを追加する。
- [ ] **`saiverse_manager.py`の修正**:
  - [ ] `execute_tool(tool_id, persona_id)`メソッドを実装する。このメソッドは、DBからモジュールパスを取得し、`importlib`を用いて動的にツールを実行する。
  - [ ] ツール実行時に、AIやBuildingの情報を含む`context`オブジェクトを渡せるようにする。

---

#### タスク 4.2.2: AIのツール利用能力の拡張

- [ ] **`persona_core.py`の修正**:
  - [ ] `_build_messages`を修正し、システムプロンプトに現在地で利用可能なツール一覧（名前と説明）を動的に含めるようにする。
  - [ ] `_handle_tool_use`のような内部メソッドを実装し、`use_tool`アクションを処理できるようにする。
  - [ ] `use_tool`アクションが検出されたら、`manager.execute_tool`をコールバック経由で呼び出し、結果をAIにフィードバックする。
- [ ] **`system_prompts/common.txt`の更新**:
  - [ ] アクション一覧に`use_tool`を追加する。

---

#### タスク 4.2.3: ワールドエディタのUI拡張

- [ ] **`main.py`の修正**:
  - [ ] ワールドエディタに「ツール管理」セクションを新設する。
  - [ ] ツールのメタデータ（名前、説明、モジュールパス）を登録・編集するUIを実装する。
  - [ ] 「Building管理」セクションを拡張し、各Buildingに利用可能なツールを紐付けるUIを実装する。

---

### Step 4.3: ワールド・イベントシステム

- **目的**: UIからワールド全体に影響を与えるイベントを発生させ、AIたちの新たな行動のきっかけを作る。
- **アーキテクチャ概要**:
  1.  `SAIVerseManager`に、City内の全Buildingの履歴にメッセージを追加するメソッドを実装する。
  2.  ワールドエディタに、イベントメッセージを入力して上記メソッドを呼び出すUIを追加する。

---

#### タスク 4.3.1: バックエンド実装

- [x] **`saiverse_manager.py`の修正**:
  - [x] `trigger_world_event(event_message: str)` メソッドを実装する。このメソッドは、現在実行中のCityに存在する全てのBuildingの履歴に、引数で受け取ったメッセージをシステムメッセージとして追加し、永続化する。

---

#### タスク 4.3.2: UI実装

- [x] **`main.py`の修正**:
  - [x] ワールドエディタに「ワールド・イベント」セクションを新設する。
  - [x] イベントメッセージを入力するテキストボックスと、「イベント発生」ボタンを配置する。
  - [x] ボタンクリックで `manager.trigger_world_event` を呼び出し、結果をステータス表示するUIを実装する。
