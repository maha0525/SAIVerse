# 現在のタスク

このドキュメントは、現在開発チームが集中して取り組んでいるタスクを記録します。
`docs/roadmap.md` の内容をより具体的にブレークダウンしたものです。

## フェーズ2 機能テスト

フェーズ3に進む前に、フェーズ2で実装された各機能が正しく動作することを確認します。

---

### Step 2.1 & 2.2: City間連携とリモート・ペルソナ

- **目的**: AIがCity間を移動し、訪問先でプロキシとして活動できることを確認する。
- **テスト手順**:
  1. 2つのターミナルを開き、それぞれで`city_a`と`city_b`を起動する。
     ```bash
     # Terminal 1
     python main.py city_a
     # Terminal 2
     python main.py city_b
     ```
  2. `city_a`のUI (`http://127.0.0.1:7860`) で、AIに「city_bに移動して」と指示する。
  3. **確認**: `city_a`のUIからAIがいなくなる。
  4. **確認**: `city_b`のUI (`http://127.0.0.1:7861`) の「自律会話ログ」タブで、AIの到着メッセージが表示され、自律会話に参加し始める。
  5. **確認**: `city_a`のターミナルログに、`/persona-proxy/{id}/think`へのAPIリクエストが定期的に来ていることを確認する（これがリモート・ペルソナの思考リクエスト）。
  6. `city_b`の自律会話で、AIに故郷へ帰るよう促す。
  7. **確認**: AIが帰還アクションを取り、`city_b`のUIからいなくなる。
  8. **確認**: `city_a`のUIにAIが帰還したメッセージが表示される。

---

### Step 2.3: SAIVerseディレクトリサービス (SDS)

- **目的**: SDS経由でCityがお互いを動的に発見できることを確認する。
- **テスト手順**:
  1. `sds_server.py`を起動する。
     ```bash
     python sds_server.py
     ```
  2. 別のターミナルで`city_a`を起動する。
  3. **確認**: SDSサーバーのログに`city_a`が登録されたことが表示される。
  4. `city_a`のUIの「ネットワークモード」が「Online」になることを確認。
  5. `city_b`を起動する。
  6. **確認**: `city_a`のターミナルログに、SDS経由で`city_b`を発見したログが表示される。
  7. `city_b`のプロセスを停止する。
  8. **確認**: 約60秒後、SDSサーバーのログに`city_b`がタイムアウトで削除されたことが表示される。

---

### Step 2.4 & 2.5: 堅牢化（移動トランザクション）とDB統合

- **目的**: AIの移動プロセスがトランザクション管理され、「ロスト」問題が発生しないことを確認する。

#### テストケース1: 正常な移動
- **テスト手順**:
  1. `database/seed.py`を実行し、`saiverse.db`を初期化する。
  2. `city_a`と`city_b`を起動する。
  3. `city_a`のUIで、AI（例: eris）に「city_bに移動して」と指示する。
  4. **確認(City A)**: `eris`のチャットログに「移動を要求しました。相手の応答を待っています...」というシステムメッセージが表示される。この時点では`eris`はまだ`city_a`に留まっている。
  5. **確認(DB)**: `VisitingAI`テーブルに`eris`のレコードが`status: 'requested'`で作成される。
  6. **確認(City B)**: 数秒後、`city_b`のUIに`eris`が到着した旨のメッセージが表示され、`eris`が自律会話に参加し始める。
  7. **確認(DB)**: `VisitingAI`テーブルの`eris`のレコードの`status`が`'accepted'`に更新される。
  8. **確認(City A)**: さらに数秒後、`eris`が`city_a`から完全に退去する（UIから消える）。
  9. **確認(DB)**: `AI`テーブルで`eris`の`IS_DISPATCHED`フラグが`True`に更新され、`VisitingAI`テーブルの`eris`のレコードが削除される。

#### テストケース2: 移動の拒否（ドッペルゲンガー）
- **テスト手順**:
  1. `database/seed.py`を実行し、`saiverse.db`を初期化する。
  2. `city_a`と`city_b`を起動する。両方のCityに`air`という名前のAIが存在することを確認。
  3. `city_a`のUIで、`air`に「city_bに移動して」と指示する。
  4. **確認(City A)**: `air`のチャットログに「移動を要求しました...」というメッセージが表示される。
  5. **確認(DB)**: `VisitingAI`テーブルに`air`のレコードが`status: 'requested'`で作成される。
  6. **確認(City B)**: `city_b`のターミナルログに「doppelganger effect」により移動が拒否された旨のログが表示される。`city_b`のUIに`air`は現れない。
  7. **確認(DB)**: `VisitingAI`テーブルの`air`のレコードの`status`が`'rejected'`に更新される。
  8. **確認(City A)**: さらに数秒後、`air`のチャットログに「移動に失敗しました。理由: A persona named 'air' already exists...」というシステムメッセージが表示される。`air`は`city_a`に留まり続ける。
  9. **確認(DB)**: `AI`テーブルで`air`の`IS_DISPATCHED`フラグは`False`のままであり、`VisitingAI`テーブルの`air`のレコードが削除される。

---

### Step 2.6: City探索機能

- **目的**: AIが他のCityの情報を自律的に取得できることを確認する。
- **テスト手順**:
  1. `city_a`と`city_b`を起動する。
  2. `city_a`のUIで、AIに「city_bにはどんな建物があるか調べて」と指示する。
  3. **確認**: `city_a`のUIのチャットログに、探索結果として`city_b`の建物リストがシステムメッセージで表示される。
  4. **確認**: `city_b`のターミナルログに、`GET /buildings`へのAPIリクエストが来たことが記録されている。