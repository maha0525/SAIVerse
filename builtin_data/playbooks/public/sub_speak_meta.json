{
    "name": "sub_speak_meta",
    "description": "Compose final response and speak",
    "input_schema": [
        {
            "name": "input",
            "description": "Composite prompt containing user request and context"
        },
        {
            "name": "metadata",
            "description": "Optional metadata from tool execution (e.g., media attachments)",
            "source": "parent.metadata"
        }
    ],
    "context_requirements": {
        "history_depth": "full",
        "inventory": true,
        "building_items": true,
        "system_prompt": true,
        "available_playbooks": true,
        "visual_context": true,
        "memory_weave": true
    },
    "router_callable": false,
    "nodes": [
        {
            "id": "compose",
            "type": "llm",
            "action": null,
            "available_tools": [
                "call_playbook"
            ],
            "output_keys": [
                {
                    "text": "speak_content"
                },
                {
                    "function_call": "tool_call"
                }
            ],
            "next": "log",
            "conditional_next": null
        },
        {
            "id": "log",
            "type": "memorize",
            "action": "{last}",
            "role": "assistant",
            "tags": [
                "conversation"
            ],
            "metadata_key": "metadata",
            "next": null,
            "conditional_next": {
                "field": "has_speak_content",
                "cases": {
                    "True": "say",
                    "False": "check_tool"
                }
            }
        },
        {
            "id": "say",
            "type": "say",
            "action": "{speak_content}",
            "metadata_key": "metadata",
            "next": "process_body",
            "conditional_next": null
        },
        {
            "id": "process_body",
            "type": "tool",
            "action": "control_body",
            "args_input": {
                "message": "speak_content"
            },
            "output_key": null,
            "next": null,
            "conditional_next": {
                "field": "tool_called",
                "cases": {
                    "True": "execute_tool",
                    "False": null
                }
            }
        },
        {
            "id": "check_tool",
            "type": "pass",
            "next": null,
            "conditional_next": {
                "field": "tool_called",
                "cases": {
                    "True": "execute_tool",
                    "False": null
                }
            }
        },
        {
            "id": "execute_tool",
            "type": "tool",
            "action": "call_playbook",
            "args_input": {
                "playbook_name": "tool_call.args.playbook_name"
            },
            "output_key": null,
            "output_keys": null,
            "next": null,
            "conditional_next": null
        }
    ],
    "start_node": "compose"
}