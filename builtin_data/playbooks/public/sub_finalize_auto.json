{
    "name": "sub_finalize_auto",
    "description": "自律パルスの最終出力を決定する（speak/wait）",
    "input_schema": [
        {
            "name": "input",
            "description": "これまでの処理結果",
            "source": "parent.last"
        }
    ],
    "router_callable": false,
    "user_selectable": false,
    "nodes": [
        {
            "id": "decide_output",
            "type": "llm",
            "context_profile": "conversation",
            "action": "<system>自律パルスの最終段階です。これまでの処理を踏まえて、以下のいずれかを選択してください:\n\n1. **speak** - Building内で発言する（何か伝えたいことがある場合）\n2. **wait** - 何かを待つ（相手の返答待ち、特に何もない場合）\n\n選択基準:\n- 状況変化があった → speak（挨拶、コメント）\n- ユーザーや他のペルソナに伝えたいことがある → speak\n- 特に何もない → wait</system>",
            "response_schema": {
                "type": "object",
                "properties": {
                    "output_type": {
                        "type": "string",
                        "enum": [
                            "speak",
                            "wait"
                        ],
                        "description": "出力タイプ"
                    },
                    "content": {
                        "type": "string",
                        "description": "発言・待機の内容"
                    },
                    "waiting_for": {
                        "type": "string",
                        "description": "waitの場合のみ: 何を待っているか"
                    }
                },
                "required": [
                    "output_type",
                    "content"
                ]
            },
            "output_key": "finalize_output",
            "next": "branch_output"
        },
        {
            "id": "branch_output",
            "type": "pass",
            "conditional_next": {
                "field": "finalize_output.output_type",
                "cases": {
                    "speak": "do_speak_memorize",
                    "wait": "do_wait",
                    "default": "do_wait"
                }
            }
        },
        {
            "id": "do_speak_memorize",
            "type": "memorize",
            "action": "{finalize_output.content}",
            "role": "assistant",
            "tags": [
                "conversation",
                "auto"
            ],
            "next": "do_speak_say"
        },
        {
            "id": "do_speak_say",
            "type": "say",
            "action": "{finalize_output.content}",
            "next": null
        },
        {
            "id": "do_wait",
            "type": "tool",
            "action": "record_wait",
            "args_input": {
                "reason": "finalize_output.content"
            },
            "output_key": "wait_result",
            "next": null
        }
    ],
    "start_node": "decide_output"
}
