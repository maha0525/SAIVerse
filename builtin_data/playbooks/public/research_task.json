{
    "name": "research_task",
    "description": "統一リサーチ実行器。objectiveとcontext_refsを受け取り、適切なソースを判定してsource_*プレイブックを実行し、統一フォーマットで結果を返す。",
    "input_schema": [
        {
            "name": "objective",
            "param_type": "string",
            "source": "parent.objective",
            "description": "調査目的"
        },
        {
            "name": "context_refs",
            "param_type": "string",
            "source": "parent.context_refs",
            "description": "コンマ区切りのSAIVerse URI群（手がかり情報）"
        },
        {
            "name": "depth",
            "param_type": "string",
            "source": "parent.depth",
            "description": "調査深度: shallow/normal/deep"
        },
        {
            "name": "task_index",
            "param_type": "number",
            "source": "parent.task_index",
            "description": "タスク番号"
        }
    ],
    "output_schema": [
        "research_result"
    ],
    "router_callable": false,
    "user_selectable": false,
    "nodes": [
        {
            "id": "resolve_context",
            "type": "tool",
            "action": "resolve_uri",
            "args_input": {
                "uris": "context_refs",
                "max_total_chars": 6000
            },
            "output_key": "resolved_context",
            "next": "calc_max_iterations"
        },
        {
            "id": "calc_max_iterations",
            "type": "set",
            "assignments": {
                "max_iterations_value": 2
            },
            "next": "route",
            "conditional_next": {
                "field": "depth",
                "operator": "eq",
                "cases": {
                    "shallow": "set_shallow",
                    "deep": "set_deep",
                    "default": "route"
                }
            }
        },
        {
            "id": "set_shallow",
            "type": "set",
            "assignments": {
                "max_iterations_value": 1
            },
            "next": "route"
        },
        {
            "id": "set_deep",
            "type": "set",
            "assignments": {
                "max_iterations_value": 4
            },
            "next": "route"
        },
        {
            "id": "route",
            "type": "llm",
            "model_type": "lightweight",
            "context_profile": "worker_light",
            "action": "あなたはリサーチタスクのソースルーターです。以下の調査目的と手がかり情報から、最適な情報ソースを1つ選んでください。\n\n## 調査目的\n{objective}\n\n## 手がかり情報\n{resolved_context}\n\n## context_refs (URI)\n{context_refs}\n\n## 選択可能なソース\n- messagelog: 過去の会話ログを意味検索で探す。「あのとき話した」「言ってた」など過去の発言を探す場合。\n- memopedia: 知識ベースのページを検索する。人物・用語・概念の定義や情報を探す場合。\n- chronicle: あらすじ（時系列の出来事サマリー）を検索する。「いつ何があった」「時期ごとの出来事」を探す場合。\n- web: Webを検索する。外部の情報が必要な場合。\n- document: ドキュメントアイテムを検索する。特定のドキュメントの内容を探す場合。context_refsにsaiverse://item/やsaiverse://document/が含まれている場合。\n- pdf: PDFアイテムを読む。context_refsにPDFアイテムのURIが含まれている場合。\n\n## 判断のヒント\n- context_refsのURIスキーム（messagelog, memopedia, chronicle等）はソース選択の手がかりになる\n- 手がかり情報の内容もどのソースが適切かの判断材料\n- 迷った場合はmessagelogが最も汎用的",
            "response_schema": {
                "type": "object",
                "properties": {
                    "source": {
                        "type": "string",
                        "enum": [
                            "messagelog",
                            "memopedia",
                            "chronicle",
                            "web",
                            "document",
                            "pdf"
                        ],
                        "description": "選択するソースタイプ"
                    },
                    "rationale": {
                        "type": "string",
                        "description": "選択理由の簡潔な説明"
                    }
                },
                "required": [
                    "source",
                    "rationale"
                ]
            },
            "output_key": "route_result",
            "next": "prepare_exec"
        },
        {
            "id": "prepare_exec",
            "type": "set",
            "assignments": {
                "selected_playbook": "source_{route_result.source}",
                "max_iterations": "{max_iterations_value}",
                "context_text": "{resolved_context}"
            },
            "next": "exec_source"
        },
        {
            "id": "exec_source",
            "type": "exec",
            "playbook_source": "selected_playbook",
            "next": "check_result"
        },
        {
            "id": "check_result",
            "type": "pass",
            "next": "done",
            "conditional_next": {
                "field": "research_result.status",
                "operator": "eq",
                "cases": {
                    "found": "done",
                    "partial": "done",
                    "not_found": "fallback_check",
                    "default": "done"
                }
            }
        },
        {
            "id": "fallback_check",
            "type": "llm",
            "model_type": "lightweight",
            "context_profile": "worker_light",
            "action": "リサーチ結果が見つかりませんでした。別のソースで再検索するべきか判断してください。\n\n## 調査目的\n{objective}\n\n## 使用したソース\n{route_result.source}\n\n## 結果\n{research_result}\n\n別のソースで検索する必要がありますか？",
            "response_schema": {
                "type": "object",
                "properties": {
                    "should_retry": {
                        "type": "string",
                        "enum": [
                            "yes",
                            "no"
                        ],
                        "description": "別ソースで再検索するか"
                    },
                    "alternative_source": {
                        "type": "string",
                        "enum": [
                            "messagelog",
                            "memopedia",
                            "chronicle",
                            "web",
                            "document",
                            "pdf"
                        ],
                        "description": "再検索する場合のソース"
                    }
                },
                "required": [
                    "should_retry"
                ]
            },
            "output_key": "fallback_decision",
            "next": "route_fallback"
        },
        {
            "id": "route_fallback",
            "type": "pass",
            "next": "done",
            "conditional_next": {
                "field": "fallback_decision.should_retry",
                "operator": "eq",
                "cases": {
                    "yes": "apply_fallback",
                    "default": "done"
                }
            }
        },
        {
            "id": "apply_fallback",
            "type": "set",
            "assignments": {
                "selected_playbook": "source_{fallback_decision.alternative_source}"
            },
            "next": "exec_source"
        },
        {
            "id": "done",
            "type": "pass",
            "next": null
        }
    ],
    "start_node": "resolve_context"
}
