{
    "name": "source_document",
    "description": "ドキュメントアイテム内をパターン検索し、目的に関連する内容を構造化された調査結果として返す",
    "input_schema": [
        {
            "name": "objective",
            "param_type": "string",
            "source": "parent.objective",
            "description": "What to find"
        },
        {
            "name": "context_text",
            "param_type": "string",
            "source": "parent.context_text",
            "description": "Pre-resolved context from URIs"
        },
        {
            "name": "depth",
            "param_type": "string",
            "source": "parent.depth",
            "description": "shallow/normal/deep"
        },
        {
            "name": "max_iterations",
            "param_type": "number",
            "source": "parent.max_iterations",
            "description": "Max search iterations"
        }
    ],
    "output_schema": [
        "research_result"
    ],
    "context_requirements": {
        "history_depth": "5messages",
        "history_balanced": false,
        "include_internal": false,
        "system_prompt": true,
        "memory_weave": true,
        "working_memory": false,
        "inventory": false,
        "building_items": false,
        "available_playbooks": false,
        "visual_context": false,
        "realtime_context": true
    },
    "router_callable": false,
    "user_selectable": false,
    "nodes": [
        {
            "id": "init",
            "type": "set",
            "assignments": {
                "iterations": 0,
                "accumulated_info": ""
            },
            "next": "generate_params"
        },
        {
            "id": "generate_params",
            "type": "llm",
            "model_type": "lightweight",
            "action": "ドキュメント検索のパラメータを生成してください。\n\n## 調査目的\n{objective}\n\n## 補足コンテキスト（URIから解決済みの情報。item_idが含まれている場合があります）\n{context_text}\n\n## これまでに収集した情報\n{accumulated_info}\n\n## 現在のイテレーション\n{iterations} / {max_iterations}\n\nコンテキストからドキュメントのitem_idを特定し、目的に合った検索パターン（正規表現可）を生成してください。\nイテレーションが2回目以降の場合、前回と異なるパターンを試してください。",
            "response_schema": {
                "type": "object",
                "properties": {
                    "item_id": {
                        "type": "string",
                        "description": "Document item ID"
                    },
                    "pattern": {
                        "type": "string",
                        "description": "Search pattern (regex supported)"
                    },
                    "context_lines": {
                        "type": "integer",
                        "description": "Context lines around each match (default: 3)"
                    }
                },
                "required": [
                    "item_id",
                    "pattern"
                ]
            },
            "output_key": "search_params",
            "next": "search"
        },
        {
            "id": "search",
            "type": "tool",
            "action": "document_search",
            "args_input": {
                "item_id": "search_params.item_id",
                "pattern": "search_params.pattern",
                "context_lines": "search_params.context_lines",
                "max_matches": 10
            },
            "output_key": "search_results",
            "next": "extract_lines"
        },
        {
            "id": "extract_lines",
            "type": "llm",
            "model_type": "lightweight",
            "action": "検索結果から、調査目的「{objective}」に最も関連する箇所を特定し、その行範囲を返してください。\n\n検索結果:\n{search_results}\n\n最も関連性の高い箇所の行番号範囲を指定してください。関連する箇所がない場合はstart_lineを0にしてください。",
            "response_schema": {
                "type": "object",
                "properties": {
                    "start_line": {
                        "type": "integer",
                        "description": "Start line to read (1-based, 0 if nothing relevant)"
                    },
                    "end_line": {
                        "type": "integer",
                        "description": "End line to read (1-based)"
                    }
                },
                "required": [
                    "start_line"
                ]
            },
            "output_key": "line_selection",
            "next": "check_lines"
        },
        {
            "id": "check_lines",
            "type": "pass",
            "conditional_next": {
                "field": "line_selection.start_line",
                "operator": "gte",
                "cases": {
                    "1": "read_lines",
                    "default": "evaluate"
                }
            }
        },
        {
            "id": "read_lines",
            "type": "tool",
            "action": "document_read",
            "args_input": {
                "item_id": "search_params.item_id",
                "start_line": "line_selection.start_line",
                "end_line": "line_selection.end_line",
                "limit": 100
            },
            "output_key": "read_content",
            "next": "accumulate"
        },
        {
            "id": "accumulate",
            "type": "set",
            "assignments": {
                "accumulated_info": "{accumulated_info}\n\n---\nPattern: {search_params.pattern}\nLines {line_selection.start_line}-{line_selection.end_line}:\n{read_content}"
            },
            "next": "evaluate"
        },
        {
            "id": "evaluate",
            "type": "llm",
            "action": "調査目的に対して、ドキュメント検索から収集した情報を評価し、構造化された調査結果を生成してください。\n\n## 調査目的\n{objective}\n\n## 検索結果\n{search_results}\n\n## 読み込んだ内容\n{accumulated_info}\n\n## 評価基準\n- status: 目的に合致する情報が見つかったか（found/partial/not_found）\n- summary: 発見内容の簡潔なまとめ\n- findings: 各発見の詳細（source_refはsaiverse://self/document/<item_id>#L<line>形式）\n- confidence: 結果の確信度\n\nドキュメント内で見つかった情報を目的と照合し、正確に評価してください。",
            "response_schema": {
                "type": "object",
                "properties": {
                    "status": {
                        "type": "string",
                        "enum": [
                            "found",
                            "partial",
                            "not_found"
                        ]
                    },
                    "summary": {
                        "type": "string",
                        "description": "Concise summary of findings"
                    },
                    "findings": {
                        "type": "array",
                        "items": {
                            "type": "object",
                            "properties": {
                                "source_ref": {
                                    "type": "string",
                                    "description": "SAIVerse URI of the source"
                                },
                                "excerpt": {
                                    "type": "string",
                                    "description": "Relevant excerpt"
                                },
                                "relevance": {
                                    "type": "string",
                                    "enum": [
                                        "high",
                                        "medium",
                                        "low"
                                    ]
                                }
                            },
                            "required": [
                                "source_ref",
                                "excerpt",
                                "relevance"
                            ]
                        }
                    },
                    "confidence": {
                        "type": "string",
                        "enum": [
                            "high",
                            "medium",
                            "low"
                        ]
                    }
                },
                "required": [
                    "status",
                    "summary",
                    "findings",
                    "confidence"
                ]
            },
            "memorize": {
                "tags": [
                    "internal",
                    "research"
                ]
            },
            "output_key": "research_result",
            "next": "check_done"
        },
        {
            "id": "check_done",
            "type": "pass",
            "conditional_next": {
                "field": "research_result.status",
                "operator": "eq",
                "cases": {
                    "found": "done",
                    "default": "check_iterations"
                }
            }
        },
        {
            "id": "check_iterations",
            "type": "pass",
            "conditional_next": {
                "field": "iterations",
                "operator": "gte",
                "cases": {
                    "{max_iterations}": "done",
                    "default": "inc"
                }
            }
        },
        {
            "id": "inc",
            "type": "set",
            "assignments": {
                "iterations": "={iterations} + 1"
            },
            "next": "generate_params"
        },
        {
            "id": "done",
            "type": "pass",
            "next": null
        }
    ],
    "start_node": "init"
}
