{
    "name": "web_search_step",
    "description": "Web検索ループ。クエリ生成→検索→ページ読み→要約→記録→十分か判定を繰り返し、最終的に全結果を構造化して返す。サブエージェントで実行されることを想定。",
    "input_schema": [
        {
            "name": "input",
            "description": "調査トピック"
        }
    ],
    "output_schema": [
        "research_findings"
    ],
    "router_callable": false,
    "user_selectable": false,
    "nodes": [
        {
            "id": "init",
            "type": "set",
            "assignments": {
                "iterations": 0,
                "max_iterations": 5,
                "known_sources": "",
                "accumulated_findings": ""
            },
            "next": "build_query"
        },
        {
            "id": "build_query",
            "type": "llm",
            "context_profile": "worker_light",
            "action": "以下の調査トピックについてWeb検索クエリを生成してください。\n\n## 調査トピック\n{input}\n\nイテレーション: {iterations}/{max_iterations}\n\n情報がまだない場合は基本的な検索から、既にある場合は不足している観点を補う検索を行ってください。",
            "response_schema": {
                "type": "object",
                "properties": {
                    "query": {
                        "type": "string",
                        "description": "検索クエリ"
                    },
                    "max_results": {
                        "type": "integer",
                        "description": "取得件数（3-10）"
                    }
                },
                "required": [
                    "query"
                ]
            },
            "memorize": {
                "tags": [
                    "internal",
                    "research"
                ]
            },
            "output_key": "search_args",
            "next": "search"
        },
        {
            "id": "search",
            "type": "tool",
            "action": "searxng_search",
            "args_input": {
                "query": "search_args.query",
                "max_results": "search_args.max_results"
            },
            "output_key": "search_results",
            "next": "select_page"
        },
        {
            "id": "select_page",
            "type": "llm",
            "context_profile": "worker_light",
            "action": "検索結果から、調査トピックに最も関連する有用なページを1件選んでください。既に調べたソースは避けてください。\n\n## 調査トピック\n{input}\n\n## 検索結果\n{search_results}",
            "response_schema": {
                "type": "object",
                "properties": {
                    "url": {
                        "type": "string",
                        "description": "読み込むURL"
                    },
                    "title": {
                        "type": "string",
                        "description": "ページタイトル"
                    }
                },
                "required": [
                    "url"
                ]
            },
            "output_key": "selected_page",
            "memorize": {
                "tags": [
                    "internal",
                    "research"
                ]
            },
            "next": "read_page"
        },
        {
            "id": "read_page",
            "type": "tool",
            "action": "read_url_content",
            "args_input": {
                "url": "selected_page.url",
                "max_chars": 8000
            },
            "output_key": "page_content",
            "next": "summarize"
        },
        {
            "id": "summarize",
            "type": "llm",
            "context_profile": "worker_light",
            "action": "以下のページ内容から、調査トピックに関連する重要な情報を要約してください。事実と数字を優先的に抽出すること。\n\n## 調査トピック\n{input}\n\n## ページ情報\nURL: {selected_page.url}\nタイトル: {selected_page.title}\n\n## ページ内容\n{page_content}",
            "response_schema": {
                "type": "object",
                "properties": {
                    "summary": {
                        "type": "string",
                        "description": "ページの要約"
                    },
                    "key_facts": {
                        "type": "array",
                        "items": {
                            "type": "string"
                        },
                        "description": "重要な事実のリスト"
                    },
                    "source_url": {
                        "type": "string",
                        "description": "情報源URL"
                    }
                },
                "required": [
                    "summary",
                    "key_facts",
                    "source_url"
                ]
            },
            "output_key": "step_summary",
            "memorize": {
                "tags": [
                    "internal",
                    "research"
                ]
            },
            "next": "track_source"
        },
        {
            "id": "track_source",
            "type": "set",
            "assignments": {
                "known_sources": "{known_sources}\n{step_summary.source_url}",
                "iterations": "={iterations} + 1",
                "accumulated_findings": "{accumulated_findings}\n\n---\nソース: {step_summary.source_url}\n要約: {step_summary.summary}\n重要事実: {step_summary.key_facts}"
            },
            "next": "check_done"
        },
        {
            "id": "check_done",
            "type": "llm",
            "context_profile": "worker_light",
            "action": "これまでの検索で得られた情報が十分かどうか判断してください。\n\n## 調査トピック\n{input}\n\nイテレーション: {iterations}/{max_iterations}\n\n以下を考慮して判断:\n- トピックの主要な側面がカバーされているか\n- 信頼できる情報源から情報が得られているか\n- レポートを書くのに十分な具体的情報があるか",
            "response_schema": {
                "type": "object",
                "properties": {
                    "is_sufficient": {
                        "type": "string",
                        "enum": [
                            "true",
                            "false"
                        ],
                        "description": "情報が十分かどうか"
                    },
                    "missing_aspects": {
                        "type": "string",
                        "description": "不足している観点（あれば）"
                    }
                },
                "required": [
                    "is_sufficient"
                ]
            },
            "output_key": "sufficiency_check",
            "memorize": {
                "tags": [
                    "internal",
                    "research"
                ]
            },
            "next": "decide_continue"
        },
        {
            "id": "decide_continue",
            "type": "pass",
            "conditional_next": {
                "field": "sufficiency_check.is_sufficient",
                "operator": "eq",
                "cases": {
                    "true": "finalize",
                    "default": "check_loop_limit"
                }
            }
        },
        {
            "id": "check_loop_limit",
            "type": "pass",
            "conditional_next": {
                "field": "iterations",
                "operator": "gte",
                "cases": {
                    "{max_iterations}": "finalize",
                    "default": "build_query"
                }
            }
        },
        {
            "id": "finalize",
            "type": "set",
            "assignments": {
                "research_findings": "## 調査トピック: {input}\nイテレーション: {iterations}回\n調査済みソース: {known_sources}\n{accumulated_findings}"
            },
            "next": null
        }
    ],
    "start_node": "init"
}