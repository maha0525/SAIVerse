{
    "name": "deep_research",
    "display_name": "深い調査",
    "description": "トピックについて深く調査し、複数の情報源から情報を収集してレポートドキュメントを作成する。各検索イテレーションをサブエージェントで実行し、Chronicleで結果を蓄積する。",
    "input_schema": [
        {
            "name": "input",
            "description": "調査したいトピックや質問"
        }
    ],
    "context_requirements": {
        "history_depth": "10messages",
        "history_balanced": false,
        "include_internal": false,
        "system_prompt": true,
        "memory_weave": true,
        "working_memory": false,
        "inventory": false,
        "building_items": true,
        "available_playbooks": false,
        "visual_context": false,
        "realtime_context": true
    },
    "router_callable": true,
    "nodes": [
        {
            "id": "init",
            "type": "set",
            "assignments": {
                "loop_count": 0,
                "max_loops": 5,
                "all_findings": "",
                "known_sources": "",
                "research_topic": "{input}"
            },
            "next": "exec_search"
        },
        {
            "id": "exec_search",
            "type": "subplay",
            "playbook": "web_search_step",
            "input_template": "{research_topic}",
            "propagate_output": false,
            "execution": "subagent",
            "subagent_chronicle": true,
            "next": "accumulate"
        },
        {
            "id": "accumulate",
            "type": "set",
            "assignments": {
                "all_findings": "{all_findings}\n\n---\n### 検索イテレーション {loop_count}\n{_subagent_chronicle}",
                "known_sources": "{known_sources}\n{step_summary.source_url}",
                "loop_count": "={loop_count} + 1"
            },
            "next": "check_done"
        },
        {
            "id": "check_done",
            "type": "llm",
            "context_profile": "worker_light",
            "action": "調査トピック「{research_topic}」について、収集した情報が十分かどうか判断してください。\n\n収集済み情報:\n{all_findings}\n\nループ回数: {loop_count}/{max_loops}\n\n以下を考慮して判断:\n- トピックの主要な側面がカバーされているか\n- 信頼できる情報源から情報が得られているか\n- レポートを書くのに十分な具体的情報があるか",
            "response_schema": {
                "type": "object",
                "properties": {
                    "is_sufficient": {
                        "type": "string",
                        "enum": [
                            "true",
                            "false"
                        ],
                        "description": "情報が十分かどうか"
                    },
                    "missing_aspects": {
                        "type": "string",
                        "description": "不足している観点（あれば）"
                    }
                },
                "required": [
                    "is_sufficient"
                ]
            },
            "output_key": "sufficiency_check",
            "next": "decide_continue"
        },
        {
            "id": "decide_continue",
            "type": "pass",
            "conditional_next": {
                "field": "sufficiency_check.is_sufficient",
                "operator": "eq",
                "cases": {
                    "true": "generate_report",
                    "default": "check_loop_limit"
                }
            }
        },
        {
            "id": "check_loop_limit",
            "type": "pass",
            "conditional_next": {
                "field": "loop_count",
                "operator": "gte",
                "cases": {
                    "{max_loops}": "generate_report",
                    "default": "exec_search"
                }
            }
        },
        {
            "id": "generate_report",
            "type": "llm",
            "context_profile": "worker",
            "action": "調査トピック「{research_topic}」について、収集した情報を基に包括的なレポートを作成してください。\n\n収集済み情報:\n{all_findings}\n\nレポート要件:\n- 明確な構成（概要、本文、結論）\n- 情報源の明記\n- 事実に基づいた客観的な記述\n- 読みやすいMarkdown形式",
            "response_schema": {
                "type": "object",
                "properties": {
                    "title": {
                        "type": "string",
                        "description": "レポートのタイトル"
                    },
                    "content": {
                        "type": "string",
                        "description": "レポート本文（Markdown形式）"
                    },
                    "summary": {
                        "type": "string",
                        "description": "レポートの要約（1-2文）"
                    }
                },
                "required": [
                    "title",
                    "content",
                    "summary"
                ]
            },
            "output_key": "report",
            "next": "create_document"
        },
        {
            "id": "create_document",
            "type": "tool",
            "action": "document_create",
            "args_input": {
                "name": "report.title",
                "description": "report.summary",
                "content": "report.content"
            },
            "output_key": "doc_result",
            "next": "notify_complete"
        },
        {
            "id": "notify_complete",
            "type": "memorize",
            "action": "<system>ディープリサーチ完了\n\nトピック: {research_topic}\nドキュメント: 「{report.title}」を作成しました。\n調査ループ: {loop_count}回\n調査済みソース: {known_sources}\n\n結果: {doc_result}</system>",
            "role": "user",
            "tags": [
                "tool",
                "deep_research",
                "complete"
            ],
            "next": null
        }
    ],
    "start_node": "init"
}
