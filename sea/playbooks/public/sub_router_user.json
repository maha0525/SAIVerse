{
  "name": "sub_router_user",
  "description": "Route user input to appropriate playbook",
  "input_schema": [
    {
      "name": "input",
      "description": "User input"
    },
    {
      "name": "available_playbooks",
      "description": "JSON list of available playbooks",
      "source": "parent.available_playbooks"
    },
    {
      "name": "meta_playbook_name",
      "description": "Name of the current meta playbook being executed",
      "source": "parent.meta_playbook_name"
    },
    {
      "name": "meta_playbook_description",
      "description": "Description of the current meta playbook",
      "source": "parent.meta_playbook_description"
    },
    {
      "name": "executed_playbooks",
      "description": "List of playbooks already executed in this meta playbook run",
      "source": "parent.executed_playbooks"
    }
  ],
  "output_schema": ["selected_playbook", "selected_args"],
  "context_requirements": {
    "history_depth": "full",
    "inventory": true,
    "building_items": true,
    "system_prompt": true
  },
  "router_callable": false,
  "nodes": [
    {
      "id": "decide",
      "type": "llm",
      "model_type": "lightweight",
      "action": "You are the SEA router. Choose the best playbook for the user's request.\n\n## Current Execution Context\nMeta playbook: {meta_playbook_name}\nDescription: {meta_playbook_description}\nPlaybooks already executed in this run: {executed_playbooks}\n\n## Available Playbooks (MUST select from this list)\n{available_playbooks}\n\n## Instructions\n- If the user's request has been fulfilled by previously executed playbooks, select 'basic_chat' to respond.\n- Do NOT re-select a playbook that has already been executed unless explicitly necessary.\n- The 'playbook' field MUST be exactly one of the names from the available playbooks list above.\n\nRespond ONLY with JSON per the schema.",
      "response_schema": {
        "type": "object",
        "properties": {
          "reason": {
            "type": "string",
            "description": "Brief reason for choosing this playbook"
          },
          "playbook": {
            "type": "string",
            "description": "Playbook name to execute (must be one of the available playbooks)"
          }
        },
        "required": [
          "reason",
          "playbook"
        ]
      },
      "output_key": "decision",
      "output_mapping": {
        "playbook": "selected_playbook"
      },
      "conditional_next": {
        "field": "decision.playbook",
        "cases": {
          "basic_chat": null,
          "default": "log"
        }
      }
    },
    {
      "id": "log",
      "type": "memorize",
      "action": "{last}",
      "role": "assistant",
      "tags": [
        "router"
      ],
      "next": null
    }
  ],
  "start_node": "decide"
}
