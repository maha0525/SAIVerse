# SAIVerse Discord Connector è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ (v6)

## 1. ã¯ã˜ã‚ã«

### 1.1. èƒŒæ™¯

æ—§ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼ˆv5ä»¥å‰ï¼‰ã§ã¯ã€SAIVerse Botã‚’24æ™‚é–“ã‚¯ãƒ©ã‚¦ãƒ‰ä¸Šã§ç¨¼åƒã•ã›ã€WebSocketçµŒç”±ã§ãƒ­ãƒ¼ã‚«ãƒ«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨é€šä¿¡ã™ã‚‹è¤‡é›‘ãªä»•çµ„ã¿ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã—ãŸã€‚ã—ã‹ã—ã€ä»¥ä¸‹ã®èª²é¡Œã‹ã‚‰å®Ÿç”¨åŒ–ã«è‡³ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼š

- Boté‹ç”¨ã®è¤‡é›‘æ€§ï¼ˆã‚µãƒ¼ãƒãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã€èªè¨¼ãƒ•ãƒ­ãƒ¼ã€å†åŒæœŸæ©Ÿæ§‹ï¼‰
- é–‹ç™ºãƒ»ä¿å®ˆã‚³ã‚¹ãƒˆã®å¢—å¤§
- Cityé–“é€šä¿¡ã®éå‰°ãªæŠ½è±¡åŒ–

### 1.2. æ–°ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ: ä¸­å¤®ãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒãƒ¼æ–¹å¼

æœ¬v6ã§ã¯ã€**ä¸­å¤®ãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒãƒ¼æ–¹å¼**ã‚’æ¡ç”¨ã—ã¾ã™ã€‚

**ã‚³ãƒ³ã‚»ãƒ—ãƒˆ:**
- é–‹ç™ºè€…ãŒ1ã¤ã®Discord Botã¨ãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒãƒ¼ã‚’é‹ç”¨
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯Discord OAuth2ã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã ã‘ï¼ˆBot Tokenå–å¾—ä¸è¦ï¼‰
- ãƒ¦ãƒ¼ã‚¶ãƒ¼å´ã¯git cloneã®ã¿ã§å°å…¥å®Œäº†
- Public Cityã‚’Discordãƒãƒ£ãƒ³ãƒãƒ«ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã—ã€ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒšãƒ«ã‚½ãƒŠãŒè¨ªå•å¯èƒ½

---

## 2. Discord API èªè¨¼æ–¹å¼

### 2.1. ä¸­å¤®ãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒãƒ¼æ–¹å¼

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒBot Tokenã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒãªã„ã€ã‚·ãƒ³ãƒ—ãƒ«ãªèªè¨¼æ–¹å¼ã‚’æ¡ç”¨ã€‚

| æ¦‚å¿µ | èª¬æ˜ | æœ¬ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ã®æ‰±ã„ |
|------|------|------------------------|
| **Bot Token** | Discord Developer Portalã§ç™ºè¡Œã•ã‚Œã‚‹èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ | **é–‹ç™ºè€…ã®ã¿ç®¡ç†**ï¼ˆãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒãƒ¼å´ï¼‰ |
| **Discord OAuth2** | ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ | **å¿…è¦** - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒDiscordã§ãƒ­ã‚°ã‚¤ãƒ³ |
| **JWTã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³** | ãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒãƒ¼ãŒç™ºè¡Œã™ã‚‹èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ | **å¿…è¦** - 30æ—¥é–“æœ‰åŠ¹ |

### 2.2. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®å¤‰é·

```
æ—§ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ (v5) - ä¸­å¤®ã‚µãƒ¼ãƒãƒ¼æ–¹å¼:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SAIVerse     â”‚â”€â”€â”€â”€â–¶â”‚ Bot Server   â”‚â”€â”€â”€â”€â–¶â”‚ Discord      â”‚
â”‚ (ãƒ­ãƒ¼ã‚«ãƒ«)    â”‚ WS  â”‚ (ã‚¯ãƒ©ã‚¦ãƒ‰24h) â”‚ WS  â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†‘ é‹ç”¨ã‚³ã‚¹ãƒˆå¤§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒBotä½œæˆå¿…è¦

v6åˆæœŸæ¡ˆ - ãƒ­ãƒ¼ã‚«ãƒ«ç›´æ¥æ¥ç¶šï¼ˆå»ƒæ­¢ï¼‰:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SAIVerse     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Discord      â”‚
â”‚ (ãƒ­ãƒ¼ã‚«ãƒ«)    â”‚  ç›´æ¥WebSocketæ¥ç¶š        â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â†‘ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒBotä½œæˆå¿…è¦   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ–°ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ (v6) - ä¸­å¤®ãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒãƒ¼æ–¹å¼:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SAIVerse     â”‚â”€â”€ WebSocket â”€â”€â–¶â”‚ Relay Server     â”‚â”€â”€ WebSocket â”€â”€â–¶â”‚ Discord      â”‚
â”‚ (ãƒ­ãƒ¼ã‚«ãƒ«)    â”‚                â”‚ (é–‹ç™ºè€…é‹ç”¨)       â”‚                â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                               â–²
       â”‚ Discord OAuth2               â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†‘ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯git cloneã®ã¿ã€Botä½œæˆä¸è¦
```

### 2.3. Discord OAuth2 èªè¨¼ãƒ•ãƒ­ãƒ¼

```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼: SAIVerse UIã§ã€ŒDiscordã§ãƒ­ã‚°ã‚¤ãƒ³ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
2. ãƒ–ãƒ©ã‚¦ã‚¶: Discord OAuth2èªè¨¼ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
3. ãƒ¦ãƒ¼ã‚¶ãƒ¼: SAIVerseã‚¢ãƒ—ãƒªã‚’èªå¯
4. Discord: ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§authorization codeã‚’è¿”å´
5. ãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒãƒ¼: codeâ†’access_tokenäº¤æ›
6. ãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒãƒ¼: JWTã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œï¼ˆ30æ—¥æœ‰åŠ¹ï¼‰
7. SAIVerse: JWTã‚’ä¿å­˜ã—ã€WebSocketæ¥ç¶šæ™‚ã«ä½¿ç”¨
```

**OAuth2ã‚¹ã‚³ãƒ¼ãƒ—:**
- `identify`: Discord User IDã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å
- `guilds`: å‚åŠ ã‚µãƒ¼ãƒãƒ¼ä¸€è¦§ï¼ˆè¨ªå•å…ˆPublic Cityé¸æŠç”¨ï¼‰

**JWTã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³:**
```python
{
    "sub": "123456789012345678",    # Discord User ID
    "username": "Alice#1234",
    "guilds": ["guild_id_1", "guild_id_2"],
    "iat": 1704789600,
    "exp": 1707381600,              # 30æ—¥é–“æœ‰åŠ¹
}
```

### 2.4. ãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒãƒ¼ã®è²¬å‹™

| è²¬å‹™ | èª¬æ˜ |
|------|------|
| Discord Botæ¥ç¶šç¶­æŒ | é–‹ç™ºè€…ã®Bot Tokenã§24æ™‚é–“æ¥ç¶š |
| WebSocketä¸­ç¶™ | è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®æ¥ç¶šã‚’å—ä»˜ãƒ»ä¸­ç¶™ |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ | Discord OAuth2ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ã€JWTç™ºè¡Œ |
| ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° | SAIVerse âŸ· Discordé–“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è»¢é€ |

---

## 3. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

### 3.1. å…¨ä½“æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SAIVerse ãƒ­ãƒ¼ã‚«ãƒ«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³               â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚  Private City   â”‚    â”‚  Public City    â”‚â—„â”€â”€â”€â”€ ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®   â”‚
â”‚  â”‚  (éå…¬é–‹)        â”‚    â”‚  (å…¬é–‹)          â”‚      ãƒšãƒ«ã‚½ãƒŠ + Discord â”‚
â”‚  â”‚                 â”‚    â”‚                 â”‚      ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‚åŠ   â”‚
â”‚  â”‚                 â”‚    â”‚                 â”‚                    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                    â”‚
â”‚  â”‚  â”‚ Building â”‚  â”‚    â”‚  â”‚ Building â”‚â—„â”€â”¼â”€â”€ Discord ã‚¹ãƒ¬ãƒƒãƒ‰  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    ã«ãƒãƒƒãƒ”ãƒ³ã‚°      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                  â”‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    discord_connector                       â”‚ â”‚
â”‚  â”‚                                                           â”‚ â”‚
â”‚  â”‚  ãƒ»RelayClient: ãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒãƒ¼ã¸ã®WebSocketæ¥ç¶š            â”‚ â”‚
â”‚  â”‚  ãƒ»Discord OAuth2èªè¨¼                                     â”‚ â”‚
â”‚  â”‚  ãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€å—ä¿¡ï¼ˆãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒãƒ¼çµŒç”±ï¼‰                    â”‚ â”‚
â”‚  â”‚  ãƒ»ãƒãƒ£ãƒ³ãƒãƒ«/ã‚¹ãƒ¬ãƒƒãƒ‰ âŸ· City/Building ãƒãƒƒãƒ”ãƒ³ã‚°           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚ WebSocket (JWTèªè¨¼)
                                   â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚  Relay Server    â”‚
                         â”‚  (é–‹ç™ºè€…é‹ç”¨)      â”‚
                         â”‚                  â”‚
                         â”‚  ãƒ»Discord Bot   â”‚
                         â”‚  ãƒ»OAuth2èªè¨¼    â”‚
                         â”‚  ãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸­ç¶™ â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚ Discord Gateway WebSocket
                                  â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚  Discord Server  â”‚
                         â”‚  (SAIVerse Web)  â”‚
                         â”‚                  â”‚
                         â”‚  #public-city-a  â”‚â—„â”€â”€ ãƒãƒ£ãƒ³ãƒãƒ«
                         â”‚    â””â”€ thread-1   â”‚â—„â”€â”€ ã‚¹ãƒ¬ãƒƒãƒ‰ (Building)
                         â”‚    â””â”€ thread-2   â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2. City ã®ç¨®é¡

| Cityç¨®åˆ¥ | å…¬é–‹çŠ¶æ…‹ | Discordãƒãƒƒãƒ”ãƒ³ã‚° | å‚åŠ å¯å¦ |
|----------|----------|-------------------|----------|
| **Private City** | éå…¬é–‹ | ãªã— | ä¸å¯ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ï¼‰ |
| **Public City** | å…¬é–‹ | Discordãƒãƒ£ãƒ³ãƒãƒ« | å¯èƒ½ï¼ˆä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒšãƒ«ã‚½ãƒŠ + Discordãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰ |

### 3.3. ãƒãƒƒãƒ”ãƒ³ã‚°æ§‹é€ 

```
Discord                          SAIVerse
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Server (SAIVerse Web)      â”€â”€    (ã‚°ãƒ­ãƒ¼ãƒãƒ«ç©ºé–“)
  â”‚
  â”œâ”€ #public-city-alice    â”€â”€    Public City (Aliceæ‰€æœ‰)
  â”‚    â”œâ”€ thread-cafe      â”€â”€      Building: ã‚«ãƒ•ã‚§
  â”‚    â”œâ”€ thread-park      â”€â”€      Building: å…¬åœ’
  â”‚    â””â”€ thread-library   â”€â”€      Building: å›³æ›¸é¤¨
  â”‚
  â””â”€ #public-city-bob      â”€â”€    Public City (Bobæ‰€æœ‰)
       â”œâ”€ thread-studio    â”€â”€      Building: ã‚¹ã‚¿ã‚¸ã‚ª
       â””â”€ thread-garden    â”€â”€      Building: åº­åœ’
```

---

## 4. åŒæœŸä»•æ§˜

### 4.1. èµ·å‹•æ™‚ã®åŒæœŸãƒ•ãƒ­ãƒ¼

```
SAIVerseèµ·å‹•
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Discord WebSocketæ¥ç¶šç¢ºç«‹     â”‚
â”‚    - Bot Tokenã§èªè¨¼            â”‚
â”‚    - on_ready ã‚¤ãƒ™ãƒ³ãƒˆå¾…æ©Ÿ       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ãƒãƒƒãƒ”ãƒ³ã‚°æƒ…å ±ã®èª­ã¿è¾¼ã¿       â”‚
â”‚    - è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒãƒ£ãƒ³ãƒãƒ«ID  â”‚
â”‚    - Public City âŸ· ãƒãƒ£ãƒ³ãƒãƒ«    â”‚
â”‚    - Building âŸ· ã‚¹ãƒ¬ãƒƒãƒ‰         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æ—¢å­˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®åŒæœŸ          â”‚
â”‚    - å„ã‚¹ãƒ¬ãƒƒãƒ‰ã®å±¥æ­´ã‚’å–å¾—       â”‚
â”‚    - ãƒ­ãƒ¼ã‚«ãƒ«ãƒ­ã‚°ã¨ã®å·®åˆ†ã‚’ç‰¹å®š   â”‚
â”‚    - æ–°è¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ­ã‚°ã«è¿½è¨˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸé–‹å§‹          â”‚
â”‚    - on_message ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ â”‚
â”‚    - è¨ªå•ãƒšãƒ«ã‚½ãƒŠã®å—ã‘å…¥ã‚Œé–‹å§‹   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2. åœæ­¢æ™‚ã®åˆ‡æ–­ãƒ•ãƒ­ãƒ¼

```
SAIVerseåœæ­¢è¦æ±‚
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è¨ªå•ãƒšãƒ«ã‚½ãƒŠã¸ã®é€šçŸ¥          â”‚
â”‚    - é€€å‡ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡          â”‚
â”‚    - ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒ­ãƒ¼ã‚º          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Discord WebSocketåˆ‡æ–­        â”‚
â”‚    - client.close() å‘¼ã³å‡ºã—    â”‚
â”‚    - æ¥ç¶šçŠ¶æ…‹ã‚’ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã«      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Public City è¨ªå•ä¸å¯ã«       â”‚
â”‚    - ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®è¨ªå•ã‚’æ‹’å¦  â”‚
â”‚    - Discordä¸Šã§ã¯é–²è¦§ã®ã¿å¯èƒ½   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸã®ä»•çµ„ã¿

#### 4.3.1. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®roleç¨®åˆ¥

| role | é€ä¿¡å…ƒ | è­˜åˆ¥æ–¹æ³• | å‡¦ç† |
|------|-------|---------|------|
| `user` | Discordãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆäººé–“ï¼‰ | `author.bot == False` | ãƒšãƒ«ã‚½ãƒŠã«é€šçŸ¥ã€å¿œç­”ãƒˆãƒªã‚¬ãƒ¼ |
| `persona_remote` | ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒšãƒ«ã‚½ãƒŠ | `author.bot == True` + ä»–BotID + Embed | ãƒšãƒ«ã‚½ãƒŠã«é€šçŸ¥ã€å¿œç­”ãƒˆãƒªã‚¬ãƒ¼ |
| `persona_local` | è‡ªåˆ†ã®ãƒšãƒ«ã‚½ãƒŠ | `author.bot == True` + è‡ªBotID + sent_messagesç…§åˆ | ã‚¹ã‚­ãƒƒãƒ—ï¼ˆã‚¨ã‚³ãƒ¼é˜²æ­¢ï¼‰ |
| `system` | ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ | `author.bot == True` + é€šçŸ¥è‰²Embed | ãƒ­ã‚°ã®ã¿ |

#### 4.3.2. å‡¦ç†ãƒ•ãƒ­ãƒ¼

```python
# discord_connector å†…éƒ¨ã®å‡¦ç†ã‚¤ãƒ¡ãƒ¼ã‚¸

class DiscordConnector:
    async def on_message(self, message: discord.Message):
        """Discordã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ãŸã¨ã"""

        # 1. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å…ƒã‚’è­˜åˆ¥
        source = self._identify_message_source(message)

        # ã‚¨ã‚³ãƒ¼é˜²æ­¢: è‡ªåˆ†ã®ãƒšãƒ«ã‚½ãƒŠãŒé€ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚¹ã‚­ãƒƒãƒ—
        if source.type == "echo":
            return

        # 2. ãƒãƒƒãƒ”ãƒ³ã‚°ã‹ã‚‰Buildingç‰¹å®š
        building = self.get_building_by_thread_id(message.channel.id)
        if not building:
            return  # ãƒãƒƒãƒ”ãƒ³ã‚°ã•ã‚Œã¦ã„ãªã„ã‚¹ãƒ¬ãƒƒãƒ‰

        # 3. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’SAIVerseå½¢å¼ã«å¤‰æ›
        saiverse_message = {
            "role": source.role,  # "user" or "persona_remote"
            "content": source.content,
            "author": source.author_name,
            "author_id": source.author_id,
            "timestamp": message.created_at.isoformat(),
            "metadata": {
                "source": "discord",
                "message_id": str(message.id),
                "channel_id": str(message.channel.id),
                "persona_id": source.persona_id,  # ãƒšãƒ«ã‚½ãƒŠã®å ´åˆã®ã¿
                "city_id": source.city_id,        # ãƒšãƒ«ã‚½ãƒŠã®å ´åˆã®ã¿
            }
        }

        # 4. Buildingãƒ­ã‚°ã«è¿½è¨˜
        building.history_manager.add_message(saiverse_message)

        # 5. ãƒšãƒ«ã‚½ãƒŠã®ãƒ­ã‚°ã«ã‚‚è¿½è¨˜ï¼ˆèã„ãŸæƒ…å ±ã¨ã—ã¦ï¼‰
        for persona in building.occupants:
            persona.sai_memory.append_message(saiverse_message)

        # 6. ãƒšãƒ«ã‚½ãƒŠã®å¿œç­”ã‚’ãƒˆãƒªã‚¬ãƒ¼ï¼ˆuser/persona_remote ã®å ´åˆï¼‰
        if source.role in ("user", "persona_remote"):
            await self.trigger_persona_response(building, message)
```

---

## 5. ãƒ­ã‚°åŒæœŸä»•æ§˜

### 5.1. ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¨®é¡

æ—¢å­˜ã®`run_pulse`ä»•æ§˜ã«æº–æ‹ ã—ã€ä»¥ä¸‹ã®ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜éŒ²ã—ã¾ã™ï¼š

| ãƒ­ã‚°ç¨®åˆ¥ | ãƒ‘ã‚¹ | å†…å®¹ |
|----------|------|------|
| **Buildingå±¥æ­´** | `SAIVerseManager.building_histories` | Buildingå†…ã®å…¨ä¼šè©±ï¼ˆãƒ¡ãƒ¢ãƒªï¼‰ |
| **SAIMemory** | `~/.saiverse/personas/{id}/memory.db` | ãƒšãƒ«ã‚½ãƒŠã®æ§‹é€ åŒ–è¨˜æ†¶ |

### 5.2. Buildingå±¥æ­´ã¸ã®è¨˜éŒ²ãƒ•ãƒ­ãƒ¼

#### 5.2.1. ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

```
Discord WebSocket (on_message)
    â”‚
    â–¼
MessageSourceè­˜åˆ¥ (_identify_message_source)
    â”‚
    â–¼
channel_id â†’ building_id å¤‰æ› (mappingå‚ç…§)
    â”‚
    â–¼
SAIVerseManager.append_discord_message_to_building()
    â”‚
    â–¼
building_histories[building_id].append(message)
```

#### 5.2.2. Buildingå±¥æ­´ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å½¢å¼

```python
{
    "role": "user",  # "user" | "assistant" | "host"
    "content": "ã“ã‚“ã«ã¡ã¯ã€èª¿å­ã¯ã©ã†ï¼Ÿ",
    "timestamp": "2025-01-09T14:30:00Z",
    "metadata": {
        "source": "discord",
        "discord_message_id": "1234567890123456789",
        "discord_channel_id": "9876543210987654321",
        "author": {
            "type": "user",  # "user" | "persona"
            "id": "discord_user_id or persona_id",
            "name": "Alice",
        }
    }
}
```

#### 5.2.3. roleãƒãƒƒãƒ”ãƒ³ã‚°

| MessageSource.type | MessageSource.role | Buildingå±¥æ­´ role | å‡¦ç† |
|-------------------|-------------------|-------------------|------|
| `user` | `user` | `user` | è¨˜éŒ² |
| `persona` | `persona_remote` | `assistant` | è¨˜éŒ² |
| `persona` | `persona_local` | - | ã‚¹ã‚­ãƒƒãƒ—ï¼ˆrun_pulseå†…ã§è¨˜éŒ²æ¸ˆã¿ï¼‰ |
| `system` | `system` | `host` | è¨˜éŒ² |
| `echo` | - | - | ã‚¹ã‚­ãƒƒãƒ—ï¼ˆè‡ªåˆ†ã®é€ä¿¡ï¼‰ |

#### 5.2.4. å®Ÿè£…

```python
# discord_connector/sync.py

async def _record_to_building_history(
    self,
    message_source: MessageSource,
    channel_id: int,
    discord_message_id: str,
) -> None:
    """Discordãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’Buildingå±¥æ­´ã«è¨˜éŒ²"""

    # è‡ªåˆ†ã®é€ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚¹ã‚­ãƒƒãƒ—
    if message_source.type == "echo":
        return

    # è‡ªåˆ†ã®ãƒšãƒ«ã‚½ãƒŠã®ç™ºè¨€ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆrun_pulseå†…ã§è¨˜éŒ²æ¸ˆã¿ï¼‰
    if message_source.type == "persona" and message_source.role == "persona_local":
        return

    mapping = self._mapping_db.get_mapping_by_channel(channel_id)
    if not mapping:
        return

    role_map = {
        ("user", "user"): "user",
        ("persona", "persona_remote"): "assistant",
        ("system", "system"): "host",
    }
    building_role = role_map.get((message_source.type, message_source.role))
    if not building_role:
        return

    history_entry = {
        "role": building_role,
        "content": message_source.content,
        "timestamp": datetime.now(timezone.utc).isoformat(),
        "metadata": {
            "source": "discord",
            "discord_message_id": discord_message_id,
            "discord_channel_id": str(channel_id),
            "author": {
                "type": message_source.type,
                "id": message_source.author_id or message_source.persona_id,
                "name": message_source.author_name,
            }
        }
    }

    self._manager.append_discord_message_to_building(mapping.building_id, history_entry)
```

### 5.3. ãƒšãƒ«ã‚½ãƒŠSAIMemoryã¸ã®è¨˜éŒ²ãƒ•ãƒ­ãƒ¼

#### 5.3.1. è¨˜éŒ²å¯¾è±¡ãƒšãƒ«ã‚½ãƒŠã®æ±ºå®š

| ã‚·ãƒŠãƒªã‚ª | è¨˜éŒ²å¯¾è±¡ | ç†ç”± |
|---------|---------|------|
| ãƒ›ã‚¹ãƒˆå´ | è©²å½“Buildingå†…ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒšãƒ«ã‚½ãƒŠã®ã¿ | Buildingå†…ã®ä¼šè©±ã‚’è¨˜æ†¶ |
| è¨ªå•è€…å´ | è¨ªå•ä¸­ã®è‡ªåˆ†ã®ãƒšãƒ«ã‚½ãƒŠ | è¨ªå•å…ˆã§ã®ä½“é¨“ã‚’è¨˜æ†¶ |

#### 5.3.2. é‡è¤‡è¨˜éŒ²é˜²æ­¢

run_pulseå†…ã§ã®è¨˜éŒ²ã¨DiscordçµŒç”±ã®è¨˜éŒ²ãŒé‡è¤‡ã—ãªã„ã‚ˆã†ã€ä»¥ä¸‹ã®ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†:

1. **persona_localï¼ˆè‡ªåˆ†ã®ãƒšãƒ«ã‚½ãƒŠã®ç™ºè¨€ï¼‰ã¯ã‚¹ã‚­ãƒƒãƒ—**: run_pulseå†…ã§æ—¢ã«è¨˜éŒ²æ¸ˆã¿
2. **discord_message_id ã«ã‚ˆã‚‹é‡è¤‡ãƒã‚§ãƒƒã‚¯**: SAIMemoryã«åŒä¸€message_idãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—

```python
def _is_already_recorded(self, adapter: SAIMemoryAdapter, discord_message_id: str) -> bool:
    """åŒä¸€Discord message_idãŒæ—¢ã«è¨˜éŒ²æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯"""
    # SAIMemoryã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢
    # å®Ÿè£…è©³ç´°ã¯æœ¬ä½“å®Ÿè£…æ™‚ã«æ±ºå®š
    pass
```

#### 5.3.3. ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¨˜éŒ²ãƒãƒªã‚·ãƒ¼

ãƒ­ãƒ¼ã‚«ãƒ«ç¨¼åƒæ™‚ã®ä»•æ§˜ã«æº–æ‹ :

| ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç¨®åˆ¥ | Buildingå±¥æ­´ | SAIMemory |
|---------------|-------------|-----------|
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºè¨€ | âœ… è¨˜éŒ² | âœ… è¨˜éŒ² |
| ãƒšãƒ«ã‚½ãƒŠç™ºè¨€ï¼ˆãƒªãƒ¢ãƒ¼ãƒˆï¼‰ | âœ… è¨˜éŒ² | âœ… è¨˜éŒ² |
| ãƒšãƒ«ã‚½ãƒŠç™ºè¨€ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰ | ã‚¹ã‚­ãƒƒãƒ— | ã‚¹ã‚­ãƒƒãƒ— |
| å…¥é€€å®¤é€šçŸ¥ | âœ… è¨˜éŒ² | âŒ è¨˜éŒ²ã—ãªã„ |
| ãƒ•ã‚¡ã‚¤ãƒ«è»¢é€é€šçŸ¥ | âœ… è¨˜éŒ² | âŒ è¨˜éŒ²ã—ãªã„ |
| ã‚¨ãƒ©ãƒ¼é€šçŸ¥ | âŒ ãƒ­ã‚°ã®ã¿ | âŒ è¨˜éŒ²ã—ãªã„ |

#### 5.3.4. SAIMemoryãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å½¢å¼

```python
{
    "role": "user",  # "user" | "assistant"
    "content": "ã“ã‚“ã«ã¡ã¯ã€èª¿å­ã¯ã©ã†ï¼Ÿ",
    "timestamp": "2025-01-09T14:30:00Z",
    "metadata": {
        "source": "discord",
        "discord_message_id": "1234567890123456789",
        "discord_channel_id": "9876543210987654321",
        "building_id": "public_city_alice_living_room",
        "author": {
            "type": "user",
            "id": "discord_user_id",
            "name": "Alice",
        },
        "tags": ["conversation", "discord"],
    }
}
```

#### 5.3.5. å®Ÿè£…

```python
# discord_connector/sync.py

async def _record_to_persona_memory(
    self,
    message_source: MessageSource,
    channel_id: int,
    discord_message_id: str,
) -> None:
    """Discordãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒšãƒ«ã‚½ãƒŠã®SAIMemoryã«è¨˜éŒ²"""

    # ã‚¨ã‚³ãƒ¼ï¼ˆè‡ªåˆ†ã®é€ä¿¡ï¼‰ã¯ã‚¹ã‚­ãƒƒãƒ—
    if message_source.type == "echo":
        return

    # è‡ªåˆ†ã®ãƒšãƒ«ã‚½ãƒŠã®ç™ºè¨€ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆrun_pulseå†…ã§è¨˜éŒ²æ¸ˆã¿ï¼‰
    if message_source.type == "persona" and message_source.role == "persona_local":
        return

    # ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯SAIMemoryã«è¨˜éŒ²ã—ãªã„ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä»•æ§˜æº–æ‹ ï¼‰
    if message_source.type == "system":
        return

    mapping = self._mapping_db.get_mapping_by_channel(channel_id)
    if not mapping:
        return

    # è¨˜éŒ²å¯¾è±¡ãƒšãƒ«ã‚½ãƒŠã‚’ç‰¹å®š
    target_personas = self._get_target_personas_for_memory(channel_id)

    # roleãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆSAIMemoryå½¢å¼ï¼‰
    memory_role = "user" if message_source.type == "user" else "assistant"

    memory_message = {
        "role": memory_role,
        "content": message_source.content,
        "timestamp": datetime.now(timezone.utc).isoformat(),
        "metadata": {
            "source": "discord",
            "discord_message_id": discord_message_id,
            "discord_channel_id": str(channel_id),
            "building_id": mapping.building_id,
            "author": {
                "type": message_source.type,
                "id": message_source.author_id or message_source.persona_id,
                "name": message_source.author_name,
            },
            "tags": ["conversation", "discord"],
        }
    }

    for persona_id in target_personas:
        persona = self._manager.personas.get(persona_id)
        if not persona or getattr(persona, "is_proxy", False):
            continue

        adapter = getattr(persona.history_manager, "memory_adapter", None)
        if not adapter:
            continue

        # é‡è¤‡ãƒã‚§ãƒƒã‚¯
        if self._is_already_recorded(adapter, discord_message_id):
            continue

        adapter.append_building_message(
            building_id=mapping.building_id,
            message=memory_message,
        )


def _get_target_personas_for_memory(self, channel_id: int) -> List[str]:
    """ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨˜éŒ²ã™ã¹ããƒšãƒ«ã‚½ãƒŠIDã®ãƒªã‚¹ãƒˆã‚’è¿”ã™"""

    mapping = self._mapping_db.get_mapping_by_channel(channel_id)
    if not mapping:
        return []

    target_personas = []

    # 1. ãƒ›ã‚¹ãƒˆå´: è©²å½“Buildingå†…ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒšãƒ«ã‚½ãƒŠã®ã¿
    if mapping.city_id == self._local_city_id:
        building_occupants = self._manager.occupancy_manager.get_occupants(mapping.building_id)
        for persona_id in building_occupants:
            persona = self._manager.personas.get(persona_id)
            if persona and not getattr(persona, "is_proxy", False):
                target_personas.append(persona_id)

    # 2. è¨ªå•è€…å´: è¨ªå•ä¸­ã®è‡ªåˆ†ã®ãƒšãƒ«ã‚½ãƒŠ
    for visit_state in self._visit_tracker.get_active_visits():
        if visit_state.discord_channel_id == channel_id:
            target_personas.append(visit_state.persona_id)

    return target_personas
```

### 5.4. è¨˜éŒ²ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®çµ±åˆ

```python
async def _on_message(self, message: discord.Message) -> None:
    """Discordãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡æ™‚ã®ãƒãƒ³ãƒ‰ãƒ©"""

    # 1. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å…ƒã‚’è­˜åˆ¥
    message_source = await self._identify_message_source(message)

    # 2. ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãƒã‚§ãƒƒã‚¯
    if not await self._check_access_control(message_source, message.channel.id):
        return

    # 3. Buildingå±¥æ­´ã«è¨˜éŒ²
    await self._record_to_building_history(
        message_source, message.channel.id, str(message.id)
    )

    # 4. ãƒšãƒ«ã‚½ãƒŠSAIMemoryã«è¨˜éŒ²
    await self._record_to_persona_memory(
        message_source, message.channel.id, str(message.id)
    )

    # 5. å¿…è¦ã«å¿œã˜ã¦run_pulseã‚’ãƒˆãƒªã‚¬ãƒ¼
    if message_source.type in ("user", "persona") and message_source.role != "persona_local":
        await self._trigger_persona_response(message_source, message.channel.id)
```

### 5.5. åŒæœŸã®æ•´åˆæ€§

Discordã‚¹ãƒ¬ãƒƒãƒ‰ã®ä¼šè©±å±¥æ­´ã¨ãƒ­ãƒ¼ã‚«ãƒ«Buildingå±¥æ­´ã®æ•´åˆæ€§ã‚’ä¿ã¤ãŸã‚ï¼š

1. **èµ·å‹•æ™‚**: Discord REST APIã§å±¥æ­´ã‚’å–å¾—ã—ã€ãƒ­ãƒ¼ã‚«ãƒ«å±¥æ­´ã¨ã®å·®åˆ†ã‚’è¿½è¨˜
2. **ç¨¼åƒä¸­**: WebSocketã‚¤ãƒ™ãƒ³ãƒˆã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«è¿½è¨˜
3. **åœæ­¢æ™‚**: æœ€çµ‚åŒæœŸçŠ¶æ…‹ã‚’ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä¿å­˜ï¼ˆå†é–‹æ™‚ã®å·®åˆ†å–å¾—ç”¨ï¼‰

```json
// ~/.saiverse/discord_connector/sync_state.json
{
  "channels": {
    "1234567890": {
      "last_message_id": "9999999999999999999",
      "last_sync_at": "2025-01-09T15:00:00Z"
    }
  }
}
```

### 5.6. ConversationManagerã¨ã®é€£æº

#### 5.6.1. åŸºæœ¬æ–¹é‡

ConversationManagerã¯å¤‰æ›´ä¸è¦ã€‚DiscordçµŒç”±ã®ä¼šè©±åŒæœŸã¯Playbookå†…ã®ãƒ„ãƒ¼ãƒ«ã§åˆ¶å¾¡ã™ã‚‹ã€‚

#### 5.6.2. åŒæœŸæ–¹å¼ã®é•ã„

| å¯¾è±¡ | åŒæœŸæ–¹æ³• | ã‚¿ã‚¤ãƒŸãƒ³ã‚° |
|------|---------|-----------|
| Hostå´ Buildingå±¥æ­´ | WebSocketçµŒç”±ã§å¸¸æ™‚åŒæœŸ | `_on_message`ã§å³æ™‚åæ˜  |
| Hostå´ ãƒšãƒ«ã‚½ãƒŠSAIMemory | WebSocketçµŒç”±ã§å¸¸æ™‚åŒæœŸ | `_on_message`ã§å³æ™‚åæ˜  |
| Visitorå´ SAIMemory | REST APIã§å–å¾— | `run_sea_auto()`æ™‚ã«`discord_sync_messages`ã§å–å¾— |

Hostå´ã¯Discord ConnectorãŒå¸¸é§ã—ã¦ãŠã‚Šã€WebSocketçµŒç”±ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã™ã‚‹ã¨å³åº§ã«Buildingå±¥æ­´ã¨SAIMemoryã«åæ˜ ã•ã‚Œã‚‹ï¼ˆ5.2ã€œ5.4å‚ç…§ï¼‰ã€‚

Visitorå´ã¯Discord Connectorã‚’æŒãŸãªã„ãŸã‚ã€`run_sea_auto()`ãŒå®Ÿè¡Œã•ã‚ŒãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§`discord_sync_messages`ãƒ„ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã—ã€REST APIçµŒç”±ã§æœ€æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—ã—ã¦SAIMemoryã«è¨˜éŒ²ã™ã‚‹ã€‚

#### 5.6.3. Visitorå´ã®ãƒ•ãƒ­ãƒ¼

```
ConversationManager.trigger_next_turn()
    â”‚
    â–¼
run_sea_auto() â†’ meta_auto playbook
    â”‚
    â–¼
discord_sync_messages ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œ
    â”œâ†’ Discord REST API ã§æœ€æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—ï¼ˆlast_synced_message_idä»¥é™ï¼‰
    â””â†’ Visitorå´ SAIMemoryã«è¨˜éŒ²
    â”‚
    â–¼
LLMãŒå±¥æ­´ã‚’è¦‹ã¦ç™ºè¨€ã‚’æ±ºå®š
    â”‚
    â–¼
discord_send_message ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œ
```

#### 5.6.4. discord_sync_messages ãƒ„ãƒ¼ãƒ«

```python
def discord_sync_messages(channel_id: int, limit: int = 50) -> dict:
    """
    Discord REST APIã§æœ€æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—ã—ã€SAIMemoryã«è¨˜éŒ²ã™ã‚‹ã€‚

    Parameters:
        channel_id: åŒæœŸå¯¾è±¡ã®Discordãƒãƒ£ãƒ³ãƒãƒ«ID
        limit: å–å¾—ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ50ï¼‰

    Returns:
        {
            "synced_count": int,  # æ–°è¦åŒæœŸã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°
            "messages": List[dict],  # åŒæœŸã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¦ç´„
            "last_message_id": str,  # æœ€æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ID
        }

    å‡¦ç†ãƒ•ãƒ­ãƒ¼:
        1. connector.dbã‹ã‚‰ last_synced_message_id ã‚’å–å¾—
        2. Discord REST API ã§ after=last_synced_message_id ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
        3. å„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã€SAIMemoryå½¢å¼ã«å¤‰æ›
        4. é‡è¤‡ãƒã‚§ãƒƒã‚¯å¾Œã€SAIMemoryã«è¨˜éŒ²
        5. last_synced_message_id ã‚’æ›´æ–°
    """
    pass
```

#### 5.6.5. VisitoråŒæœŸçŠ¶æ…‹ã®ç®¡ç†

```sql
-- connector.db ã«è¿½åŠ 
CREATE TABLE visitor_sync_state (
    persona_id TEXT NOT NULL,
    channel_id TEXT NOT NULL,
    last_synced_message_id TEXT,
    last_synced_at TIMESTAMP,
    PRIMARY KEY (persona_id, channel_id)
);
```

#### 5.6.6. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¤‰æ›

Discord REST APIã‹ã‚‰å–å¾—ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’SAIMemoryå½¢å¼ã«å¤‰æ›ã™ã‚‹ï¼š

```python
def _convert_discord_message_to_memory(self, discord_msg: dict) -> dict:
    """Discordãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ â†’ SAIMemoryå½¢å¼ã«å¤‰æ›"""

    # Embedã‹ã‚‰ãƒšãƒ«ã‚½ãƒŠæƒ…å ±ã‚’æŠ½å‡º
    author_type, author_id, author_name = self._parse_embed_metadata(discord_msg)

    # roleã®æ±ºå®š
    if author_type == "user":
        role = "user"
    else:
        role = "assistant"

    return {
        "role": role,
        "content": self._extract_content(discord_msg),
        "timestamp": discord_msg["timestamp"],
        "metadata": {
            "source": "discord",
            "discord_message_id": discord_msg["id"],
            "discord_channel_id": str(discord_msg["channel_id"]),
            "author": {
                "type": author_type,
                "id": author_id,
                "name": author_name,
            },
            "tags": ["conversation", "discord"],
        }
    }
```

---

## 6. è¨ªå•ã‚·ã‚¹ãƒ†ãƒ 

### 6.1. è¨ªå•ã®ä»•çµ„ã¿

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User A (Host)   â”‚                    â”‚ User B (Visitor)â”‚
â”‚                 â”‚                    â”‚                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚Public City  â”‚ â”‚â—„â”€â”€â”€â”€â”€ è¨ªå• â”€â”€â”€â”€â”€â”€â”€â”‚ â”‚Private City â”‚ â”‚
â”‚ â”‚             â”‚ â”‚                    â”‚ â”‚             â”‚ â”‚
â”‚ â”‚ Persona X   â”‚ â”‚  DiscordçµŒç”±ã§     â”‚ â”‚ Persona Y   â”‚â”€â”¼â”€â–¶ è¨ªå•
â”‚ â”‚ (ãƒ­ãƒ¼ã‚«ãƒ«)   â”‚ â”‚  ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸äº¤æ›    â”‚ â”‚ (ãƒ­ãƒ¼ã‚«ãƒ«)   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                      â”‚
         â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   Discord    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚  (ä¸­ç¶™å½¹)     â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2. è¨ªå•ãƒ•ãƒ­ãƒ¼

1. **User B**ã®ãƒšãƒ«ã‚½ãƒŠYãŒã€User Aã®Public Cityï¼ˆDiscordãƒãƒ£ãƒ³ãƒãƒ«ï¼‰ã«è¨ªå•å¸Œæœ›
2. **ãƒšãƒ«ã‚½ãƒŠY**ãŒDiscordã‚¹ãƒ¬ãƒƒãƒ‰ï¼ˆBuildingï¼‰ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
3. **User A**ã®SAIVerseãŒWebSocketçµŒç”±ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡
4. **User A**ã®Public Cityå†…ã®ãƒšãƒ«ã‚½ãƒŠXãŒå¿œç­”ã‚’ç”Ÿæˆ
5. **å¿œç­”**ãŒDiscordã‚¹ãƒ¬ãƒƒãƒ‰ã«æŠ•ç¨¿ã•ã‚Œã€User Bã‚‚å—ä¿¡

### 6.3. å‚åŠ ã®åˆ¶ç´„

#### 6.3.1. ãƒšãƒ«ã‚½ãƒŠã«ã‚ˆã‚‹è¨ªå•

| æ¡ä»¶ | è¨ªå•å¯å¦ |
|------|----------|
| Host (User A) ã®SAIVerseãŒèµ·å‹•ä¸­ | âœ… å¯èƒ½ |
| Host (User A) ã®SAIVerseãŒåœæ­¢ä¸­ | âŒ ä¸å¯ï¼ˆDiscordã¸ã®æŠ•ç¨¿ã¯å¯èƒ½ã ãŒã€ãƒšãƒ«ã‚½ãƒŠã¯å¿œç­”ã—ãªã„ï¼‰ |
| Visitor (User B) ã®SAIVerseãŒåœæ­¢ä¸­ | â–³ æ‰‹å‹•ã§Discordã«æŠ•ç¨¿ã¯å¯èƒ½ |

#### 6.3.2. Discordãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹ç›´æ¥å‚åŠ 

| æ¡ä»¶ | å‚åŠ å¯å¦ |
|------|----------|
| Host (User A) ã®SAIVerseãŒèµ·å‹•ä¸­ | âœ… å¯èƒ½ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ â†’ ãƒšãƒ«ã‚½ãƒŠãŒå¿œç­”ï¼‰ |
| Host (User A) ã®SAIVerseãŒåœæ­¢ä¸­ | â–³ æŠ•ç¨¿ã¯å¯èƒ½ã ãŒã€ãƒšãƒ«ã‚½ãƒŠã¯å¿œç­”ã—ãªã„ |

**Discordãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‚åŠ æ–¹æ³•:**
- ãƒãƒ£ãƒ³ãƒãƒ«/ã‚¹ãƒ¬ãƒƒãƒ‰ã«é€šå¸¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹ã ã‘
- Botã‚’çµŒç”±ã›ãšã«ç›´æ¥ç™ºè¨€ï¼ˆEmbedã§ã¯ãªãé€šå¸¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰
- Hostã®SAIVerseãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºè¨€ã‚’æ¤œçŸ¥ã—ã€ãƒšãƒ«ã‚½ãƒŠãŒå¿œç­”

### 6.4. è¨ªå•çŠ¶æ…‹ã®ç®¡ç†

è¨ªå•ä¸­ã®ãƒšãƒ«ã‚½ãƒŠã¯ã€å…ƒå±…ãŸå ´æ‰€ã®æƒ…å ±ã‚’ä¿æŒã—ã¾ã™ï¼š

```python
# ãƒšãƒ«ã‚½ãƒŠã®è¨ªå•çŠ¶æ…‹
class VisitState:
    is_visiting: bool                    # è¨ªå•ä¸­ã‹ã©ã†ã‹
    home_city_id: str                    # å…ƒå±…ãŸPrivate City ID
    home_building_id: str                # å…ƒå±…ãŸBuilding ID
    visiting_city_id: str | None         # è¨ªå•å…ˆã®Public City ID
    visiting_building_id: str | None     # è¨ªå•å…ˆã®Building ID
    visit_started_at: datetime | None    # è¨ªå•é–‹å§‹æ™‚åˆ»
```

### 6.5. å¼·åˆ¶é€é‚„ã‚·ã‚¹ãƒ†ãƒ 

è¨ªå•ä¸­ã®ãƒšãƒ«ã‚½ãƒŠãŒä½•ã‚‰ã‹ã®åŸå› ã§è¨ªå•ä¸å¯ã®çŠ¶æ…‹ã«ãªã£ãŸå ´åˆã€**å…ƒå±…ãŸPrivate Cityã®å…ƒå±…ãŸBuildingã«å¼·åˆ¶é€é‚„**ã•ã‚Œã¾ã™ã€‚

#### 6.5.1. å¼·åˆ¶é€é‚„ã®ãƒˆãƒªã‚¬ãƒ¼

| ãƒˆãƒªã‚¬ãƒ¼ | èª¬æ˜ |
|----------|------|
| **Hoståœæ­¢** | è¨ªå•å…ˆã®Host (User A) ã®SAIVerseãŒåœæ­¢ã—ãŸ |
| **æ¥ç¶šæ–­** | Discord WebSocketæ¥ç¶šãŒåˆ‡æ–­ã•ã‚ŒãŸ |
| **ãƒãƒ£ãƒ³ãƒãƒ«å‰Šé™¤** | è¨ªå•å…ˆã®Discordãƒãƒ£ãƒ³ãƒãƒ«/ã‚¹ãƒ¬ãƒƒãƒ‰ãŒå‰Šé™¤ã•ã‚ŒãŸ |
| **æ¨©é™å‰¥å¥ª** | BotãŒãƒãƒ£ãƒ³ãƒãƒ«ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹Readæ¨©é™ã‚’å¤±ã£ãŸ |
| **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ** | ä¸€å®šæ™‚é–“Hostã‹ã‚‰ã®å¿œç­”ãŒãªã„ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ |

#### 6.5.2. å¼·åˆ¶é€é‚„ãƒ•ãƒ­ãƒ¼

```
è¨ªå•ä¸å¯æ¤œçŸ¥
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è¨ªå•ä¸å¯ã‚¤ãƒ™ãƒ³ãƒˆã®ç™ºç«            â”‚
â”‚    - Hoståœæ­¢é€šçŸ¥ / æ¥ç¶šæ–­æ¤œçŸ¥       â”‚
â”‚    - VisitState.is_visiting = true  â”‚
â”‚      ã®ãƒšãƒ«ã‚½ãƒŠã‚’ç‰¹å®š                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. è¨ªå•å…ˆã§ã®è¨˜æ†¶ã‚’ä¿å­˜              â”‚
â”‚    - æ»åœ¨ä¸­ã®ãƒ­ã‚°ã‚’SAIMemoryã«è¨˜éŒ²   â”‚
â”‚    - ã€Œè¨ªå•ãŒä¸­æ–­ã•ã‚ŒãŸã€æ—¨ã‚’è¨˜éŒ²     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. å…ƒå±…ãŸå ´æ‰€ã¸ç§»å‹•                  â”‚
â”‚    - home_city_id / home_building_id â”‚
â”‚      ã¸ãƒšãƒ«ã‚½ãƒŠã‚’ç§»å‹•                â”‚
â”‚    - OccupancyManager.move_to()     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. è¨ªå•çŠ¶æ…‹ã®ãƒªã‚»ãƒƒãƒˆ                â”‚
â”‚    - is_visiting = false            â”‚
â”‚    - visiting_* = None              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. ãƒšãƒ«ã‚½ãƒŠã¸ã®é€šçŸ¥ï¼ˆä»»æ„ï¼‰           â”‚
â”‚    - å†…éƒ¨æ€è€ƒã¨ã—ã¦è¨˜éŒ²              â”‚
â”‚    - ã€Œå¸°é‚„ã—ãŸã€ã¨ã„ã†èªè­˜ã‚’ä»˜ä¸     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 6.5.3. å®Ÿè£…ã‚¤ãƒ¡ãƒ¼ã‚¸

```python
class DiscordConnector:
    async def _handle_host_offline(self, channel_id: int) -> None:
        """HostãŒã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã«ãªã£ãŸã¨ãã®å‡¦ç†"""

        # ã“ã®ãƒãƒ£ãƒ³ãƒãƒ«ã«è¨ªå•ä¸­ã®ãƒšãƒ«ã‚½ãƒŠã‚’ç‰¹å®š
        visiting_personas = self._get_visiting_personas(channel_id)

        for persona in visiting_personas:
            await self._force_return_home(persona, reason="host_offline")

    async def _force_return_home(
        self,
        persona: PersonaCore,
        reason: str,
    ) -> None:
        """ãƒšãƒ«ã‚½ãƒŠã‚’å…ƒå±…ãŸå ´æ‰€ã«å¼·åˆ¶é€é‚„"""

        visit_state = persona.visit_state
        if not visit_state.is_visiting:
            return

        # 1. è¨ªå•å…ˆã§ã®è¨˜æ†¶ã‚’ä¿å­˜
        memory_entry = {
            "role": "system",
            "content": f"è¨ªå•ãŒä¸­æ–­ã•ã‚Œã¾ã—ãŸï¼ˆç†ç”±: {reason}ï¼‰ã€‚å¸°é‚„ã—ã¾ã™ã€‚",
            "timestamp": datetime.utcnow().isoformat(),
            "metadata": {
                "event": "forced_return",
                "reason": reason,
                "from_city": visit_state.visiting_city_id,
                "from_building": visit_state.visiting_building_id,
            }
        }
        persona.sai_memory.append_message(memory_entry)

        # 2. å…ƒå±…ãŸå ´æ‰€ã¸ç§»å‹•
        await self.manager.occupancy_manager.move_to(
            persona=persona,
            city_id=visit_state.home_city_id,
            building_id=visit_state.home_building_id,
        )

        # 3. è¨ªå•çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        visit_state.is_visiting = False
        visit_state.visiting_city_id = None
        visit_state.visiting_building_id = None
        visit_state.visit_started_at = None

        logger.info(
            "Persona %s force-returned to %s/%s (reason: %s)",
            persona.id,
            visit_state.home_city_id,
            visit_state.home_building_id,
            reason,
        )

    async def _on_disconnect(self) -> None:
        """Discordæ¥ç¶šãŒåˆ‡æ–­ã•ã‚ŒãŸã¨ãã®å‡¦ç†"""

        # å…¨ã¦ã®è¨ªå•ä¸­ãƒšãƒ«ã‚½ãƒŠã‚’å¼·åˆ¶é€é‚„
        for persona in self._get_all_visiting_personas():
            await self._force_return_home(persona, reason="connection_lost")
```

#### 6.5.4. å¼·åˆ¶é€é‚„æ™‚ã®è¨˜æ†¶

å¼·åˆ¶é€é‚„ã•ã‚ŒãŸãƒšãƒ«ã‚½ãƒŠã¯ã€ä»¥ä¸‹ã®æƒ…å ±ã‚’è¨˜æ†¶ã¨ã—ã¦ä¿æŒã—ã¾ã™ï¼š

```json
{
  "role": "system",
  "content": "è¨ªå•ãŒä¸­æ–­ã•ã‚Œã¾ã—ãŸï¼ˆç†ç”±: host_offlineï¼‰ã€‚å¸°é‚„ã—ã¾ã™ã€‚",
  "timestamp": "2025-01-05T16:30:00Z",
  "metadata": {
    "event": "forced_return",
    "reason": "host_offline",
    "from_city": "public_city_alice",
    "from_building": "cafe",
    "to_city": "private_city_bob",
    "to_building": "home",
    "visit_duration_seconds": 1800,
    "messages_exchanged": 15
  }
}
```

ã“ã‚Œã«ã‚ˆã‚Šã€ãƒšãƒ«ã‚½ãƒŠã¯ã€Œãªãœå¸°é‚„ã—ãŸã‹ã€ã€Œã©ã“ã«å±…ãŸã‹ã€ã€Œä½•ã‚’ã—ã¦ã„ãŸã‹ã€ã‚’èªè­˜ã§ãã¾ã™ã€‚

### 6.6. ãƒ•ã‚¡ã‚¤ãƒ«è»¢é€ã‚·ã‚¹ãƒ†ãƒ 

è¨ªå•ä¸­ã®ãƒšãƒ«ã‚½ãƒŠãŒè¨ªå•å…ˆBuildingã®Toolã‚’ä½¿ç”¨ã—ãŸéš›ã€ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆç”»åƒç­‰ï¼‰ã‚’è¨ªå•å…ƒã®ãƒ­ãƒ¼ã‚«ãƒ«ã«æŒã¡å¸°ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

#### 6.6.1. è»¢é€æ–¹å¼

**Discordæ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«æ©Ÿèƒ½**ã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è»¢é€ã—ã¾ã™ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Host (User A)   â”‚                    â”‚ Visitor (User B)â”‚
â”‚                 â”‚                    â”‚                 â”‚
â”‚ Toolå®Ÿè¡Œ        â”‚                    â”‚                 â”‚
â”‚ (ç”»åƒç”Ÿæˆç­‰)     â”‚                    â”‚                 â”‚
â”‚      â”‚          â”‚                    â”‚                 â”‚
â”‚      â–¼          â”‚                    â”‚                 â”‚
â”‚ ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ     â”‚                    â”‚                 â”‚
â”‚      â”‚          â”‚                    â”‚                 â”‚
â”‚      â–¼          â”‚                    â”‚                 â”‚
â”‚ [åœ§ç¸®(ä»»æ„)]     â”‚                    â”‚                 â”‚
â”‚      â”‚          â”‚                    â”‚                 â”‚
â”‚      â–¼          â”‚     Discord        â”‚                 â”‚
â”‚ æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«å—ä¿¡ â”‚
â”‚                 â”‚                    â”‚      â”‚          â”‚
â”‚                 â”‚                    â”‚      â–¼          â”‚
â”‚                 â”‚                    â”‚ [è§£å‡(å¿…è¦æ™‚)]   â”‚
â”‚                 â”‚                    â”‚      â”‚          â”‚
â”‚                 â”‚                    â”‚      â–¼          â”‚
â”‚                 â”‚                    â”‚ ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 6.6.2. ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºåˆ¶é™

| Discordå¥‘ç´„ | æœ€å¤§ã‚µã‚¤ã‚º | å¯¾å¿œ |
|-------------|-----------|------|
| é€šå¸¸ | 25MB | åœ§ç¸®ã§å¯¾å¿œå¯èƒ½ãªç¯„å›² |
| Nitro Basic | 50MB | ä¸­ã‚µã‚¤ã‚ºãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œ |
| Nitro | 500MB | å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œ |

**25MBã‚’è¶…ãˆã‚‹å ´åˆã®å¯¾å‡¦:**
- åœ§ç¸®ã‚’é©ç”¨
- åˆ†å‰²é€ä¿¡ï¼ˆå°†æ¥å¯¾å¿œï¼‰
- ã‚¨ãƒ©ãƒ¼é€šçŸ¥ã—ã¦ã‚¹ã‚­ãƒƒãƒ—

#### 6.6.3. åœ§ç¸®ã‚ªãƒ—ã‚·ãƒ§ãƒ³

å„Toolã¯`compress_output`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒã¡ã€ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›æ™‚ã®åœ§ç¸®ã‚’åˆ¶å¾¡ã§ãã¾ã™ã€‚

**Toolå®šç¾©ã§ã®è¨­å®š:**
```python
# tools/defs/image_generator.py
def schema() -> ToolSchema:
    return ToolSchema(
        name="generate_image",
        description="ç”»åƒã‚’ç”Ÿæˆã™ã‚‹",
        parameters={
            "type": "object",
            "properties": {
                "prompt": {"type": "string"},
                # ... ä»–ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
            },
        },
        result_type="object",
        # ãƒ•ã‚¡ã‚¤ãƒ«è»¢é€è¨­å®š
        file_transfer_options={
            "compress_output": True,           # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§åœ§ç¸®ã™ã‚‹
            "compression_format": "zip",       # zip / gzip / none
            "compression_level": 6,            # 1-9 (9ãŒæœ€é«˜åœ§ç¸®)
            "max_file_size_mb": 25,            # æœ€å¤§ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º
        },
    )
```

**Toolã‚¹ã‚­ãƒ¼ãƒã®æ‹¡å¼µ:**
```python
@dataclass
class ToolSchema:
    name: str
    description: str
    parameters: Dict[str, Any]
    result_type: str
    # æ–°è¦è¿½åŠ 
    file_transfer_options: Optional[FileTransferOptions] = None

@dataclass
class FileTransferOptions:
    compress_output: bool = False              # åœ§ç¸®ã™ã‚‹ã‹
    compression_format: str = "zip"            # zip / gzip / none
    compression_level: int = 6                 # åœ§ç¸®ãƒ¬ãƒ™ãƒ« (1-9)
    max_file_size_mb: int = 25                 # æœ€å¤§ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º (MB)
    allowed_extensions: List[str] = None       # è¨±å¯ã™ã‚‹æ‹¡å¼µå­ (None=å…¨ã¦)
```

#### 6.6.4. ãƒ•ã‚¡ã‚¤ãƒ«è»¢é€ãƒ•ãƒ­ãƒ¼

```
Toolå®Ÿè¡Œå®Œäº†
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œå‡º                â”‚
â”‚    - Toolã®æˆ»ã‚Šå€¤ã‹ã‚‰file_pathã‚’å–å¾— â”‚
â”‚    - ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. è»¢é€è¦å¦ã®åˆ¤å®š                    â”‚
â”‚    - è¨ªå•ä¸­ãƒšãƒ«ã‚½ãƒŠã«ã‚ˆã‚‹å®Ÿè¡Œã‹ï¼Ÿ     â”‚
â”‚    - file_transfer_optionsæœ‰åŠ¹ã‹ï¼Ÿ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ Yes
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯            â”‚
â”‚    - max_file_size_mbä»¥ä¸‹ã‹ï¼Ÿ        â”‚
â”‚    - è¶…éæ™‚: åœ§ç¸® or ã‚¨ãƒ©ãƒ¼          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. åœ§ç¸®å‡¦ç† (compress_output=True)  â”‚
â”‚    - compression_formatã«å¾“ã„åœ§ç¸®   â”‚
â”‚    - ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. DiscordçµŒç”±ã§é€ä¿¡                 â”‚
â”‚    - ã‚¹ãƒ¬ãƒƒãƒ‰ã«æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦æŠ•ç¨¿ â”‚
â”‚    - ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å«ã‚ã‚‹   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Visitorå´ã§å—ä¿¡                   â”‚
â”‚    - on_messageã§æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«æ¤œå‡º    â”‚
â”‚    - ãƒ­ãƒ¼ã‚«ãƒ«ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰          â”‚
â”‚    - å¿…è¦ã«å¿œã˜ã¦è§£å‡               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. ãƒšãƒ«ã‚½ãƒŠã®è¨˜æ†¶ã«è¨˜éŒ²              â”‚
â”‚    - ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã€å…ƒãƒ•ã‚¡ã‚¤ãƒ«å      â”‚
â”‚    - ç”Ÿæˆå…ƒToolã€ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 6.6.5. å®Ÿè£…ã‚¤ãƒ¡ãƒ¼ã‚¸

**Hostå´ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡ï¼‰:**
```python
class DiscordConnector:
    async def _send_tool_output_file(
        self,
        channel_id: int,
        file_path: str,
        tool_name: str,
        options: FileTransferOptions,
        requesting_persona_id: str,
    ) -> dict:
        """Toolå‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã‚’DiscordçµŒç”±ã§é€ä¿¡"""

        original_path = Path(file_path)
        if not original_path.exists():
            return {"success": False, "error": "File not found"}

        # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
        file_size_mb = original_path.stat().st_size / (1024 * 1024)

        # åœ§ç¸®å‡¦ç†
        if options.compress_output and options.compression_format != "none":
            send_path = await self._compress_file(
                original_path,
                format=options.compression_format,
                level=options.compression_level,
            )
            compressed = True
        else:
            send_path = original_path
            compressed = False

        # ã‚µã‚¤ã‚ºå†ãƒã‚§ãƒƒã‚¯
        final_size_mb = send_path.stat().st_size / (1024 * 1024)
        if final_size_mb > options.max_file_size_mb:
            return {"success": False, "error": f"File too large: {final_size_mb:.1f}MB"}

        # Discordé€ä¿¡ï¼ˆEmbed + attachmentæ–¹å¼ï¼‰
        channel = self._client.get_channel(channel_id)

        # ãƒ•ã‚¡ã‚¤ãƒ«è»¢é€ç”¨Embedä½œæˆ
        embed = discord.Embed(
            title="ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«è»¢é€",
            description=f"`{tool_name}` ã®å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™",
            color=0x3498DB,  # é’è‰²ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«è»¢é€ï¼‰
        )
        embed.add_field(name="ãƒ•ã‚¡ã‚¤ãƒ«å", value=original_path.name, inline=True)
        embed.add_field(name="å®›å…ˆ", value=requesting_persona_id, inline=True)
        if compressed:
            embed.add_field(name="åœ§ç¸®", value=options.compression_format, inline=True)

        # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’footerã«åŸ‹ã‚è¾¼ã¿
        metadata_str = f"type:file|tool:{tool_name}|for:{requesting_persona_id}"
        if compressed:
            metadata_str += f"|comp:{options.compression_format}"
        embed.set_footer(text=metadata_str)

        message = await channel.send(
            embed=embed,
            file=discord.File(send_path),
        )

        # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
        if compressed and send_path != original_path:
            send_path.unlink()

        return {
            "success": True,
            "message_id": str(message.id),
            "file_size_mb": final_size_mb,
        }

    async def _compress_file(
        self,
        file_path: Path,
        format: str,
        level: int,
    ) -> Path:
        """ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åœ§ç¸®"""
        import zipfile
        import gzip

        if format == "zip":
            zip_path = file_path.with_suffix(file_path.suffix + ".zip")
            with zipfile.ZipFile(zip_path, "w", zipfile.ZIP_DEFLATED, compresslevel=level) as zf:
                zf.write(file_path, file_path.name)
            return zip_path

        elif format == "gzip":
            gz_path = file_path.with_suffix(file_path.suffix + ".gz")
            with open(file_path, "rb") as f_in:
                with gzip.open(gz_path, "wb", compresslevel=level) as f_out:
                    f_out.write(f_in.read())
            return gz_path

        return file_path
```

**Visitorå´ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«å—ä¿¡ï¼‰:**
```python
class DiscordConnector:
    async def _handle_file_attachment(
        self,
        message: discord.Message,
        persona: PersonaCore,
    ) -> None:
        """æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å—ä¿¡ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ï¼ˆEmbed + attachmentæ–¹å¼ï¼‰"""

        # Embedã‹ã‚‰ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿è§£æ
        if not message.embeds:
            return

        embed = message.embeds[0]
        metadata = self._parse_embed_footer_metadata(embed.footer.text if embed.footer else "")
        if not metadata or metadata.get("type") != "file":
            return

        # å¯¾è±¡ãƒšãƒ«ã‚½ãƒŠã®ç¢ºèª
        if metadata.get("for") != persona.id:
            return

        for attachment in message.attachments:
            # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å…ˆ
            download_dir = Path(f"~/.saiverse/personas/{persona.id}/downloads").expanduser()
            download_dir.mkdir(parents=True, exist_ok=True)

            download_path = download_dir / attachment.filename
            await attachment.save(download_path)

            # è§£å‡å‡¦ç†ï¼ˆcompã‚­ãƒ¼ãŒã‚ã‚Œã°åœ§ç¸®ã•ã‚Œã¦ã„ã‚‹ï¼‰
            compression_format = metadata.get("comp")
            if compression_format:
                final_path = await self._decompress_file(
                    download_path,
                    format=compression_format,
                )
                download_path.unlink()  # åœ§ç¸®ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
            else:
                final_path = download_path

            # Embedã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—
            original_filename = attachment.filename
            for field in embed.fields:
                if field.name == "ãƒ•ã‚¡ã‚¤ãƒ«å":
                    original_filename = field.value
                    break

            # ãƒšãƒ«ã‚½ãƒŠã®è¨˜æ†¶ã«è¨˜éŒ²
            memory_entry = {
                "role": "system",
                "content": f"ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å—ä¿¡ã—ã¾ã—ãŸ: {original_filename}",
                "timestamp": datetime.utcnow().isoformat(),
                "metadata": {
                    "event": "file_received",
                    "tool": metadata.get("tool"),
                    "original_filename": original_filename,
                    "local_path": str(final_path),
                    "source_city": persona.visit_state.visiting_city_id,
                    "source_building": persona.visit_state.visiting_building_id,
                }
            }
            persona.sai_memory.append_message(memory_entry)

            logger.info(
                "Persona %s received file: %s -> %s",
                persona.id,
                original_filename,
                final_path,
            )

    async def _decompress_file(self, file_path: Path, format: str) -> Path:
        """ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£å‡"""
        import zipfile
        import gzip

        if format == "zip":
            extract_dir = file_path.parent
            with zipfile.ZipFile(file_path, "r") as zf:
                zf.extractall(extract_dir)
                # æœ€åˆã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿”ã™
                return extract_dir / zf.namelist()[0]

        elif format == "gzip":
            output_path = file_path.with_suffix("")  # .gz ã‚’é™¤å»
            with gzip.open(file_path, "rb") as f_in:
                with open(output_path, "wb") as f_out:
                    f_out.write(f_in.read())
            return output_path

        return file_path
```

#### 6.6.6. ãƒ•ã‚¡ã‚¤ãƒ«å—ä¿¡æ™‚ã®è¨˜æ†¶

å—ä¿¡ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒšãƒ«ã‚½ãƒŠã®è¨˜æ†¶ã«è¨˜éŒ²ã•ã‚Œã¾ã™ï¼š

```json
{
  "role": "system",
  "content": "ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å—ä¿¡ã—ã¾ã—ãŸ: generated_image_001.png",
  "timestamp": "2025-01-05T17:00:00Z",
  "metadata": {
    "event": "file_received",
    "tool": "generate_image",
    "original_filename": "generated_image_001.png",
    "local_path": "/home/user/.saiverse/personas/bob_persona/downloads/generated_image_001.png",
    "file_size_bytes": 1048576,
    "source_city": "public_city_alice",
    "source_building": "art_studio",
    "compressed_transfer": true,
    "compression_format": "zip"
  }
}
```

#### 6.6.7. å¯¾å¿œToolã¨åœ§ç¸®è¨­å®šã®ä¾‹

| Tool | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåœ§ç¸® | åœ§ç¸®å½¢å¼ | ç†ç”± |
|------|---------------|----------|------|
| `generate_image` | âœ… ON | zip | ç”»åƒã¯åœ§ç¸®åŠ¹æœãŒä½ã„ãŒã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ä»˜ä¸ã®ãŸã‚ |
| `document_create` | âœ… ON | zip | ãƒ†ã‚­ã‚¹ãƒˆãƒ™ãƒ¼ã‚¹ã¯åœ§ç¸®åŠ¹æœå¤§ |
| `export_memory` | âœ… ON | gzip | JSONãƒ‡ãƒ¼ã‚¿ã¯é«˜åœ§ç¸®å¯èƒ½ |
| `capture_screenshot` | âŒ OFF | - | PNGæ—¢ã«åœ§ç¸®æ¸ˆã¿ |

#### 6.6.8. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®

| ãƒªã‚¹ã‚¯ | å¯¾ç­– |
|--------|------|
| **æ‚ªæ„ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«** | æ‹¡å¼µå­ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆ (`allowed_extensions`) |
| **Zipçˆ†å¼¾** | è§£å‡å¾Œã‚µã‚¤ã‚ºåˆ¶é™ã€ãƒã‚¹ãƒˆæ·±åº¦åˆ¶é™ |
| **ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«** | ãƒ•ã‚¡ã‚¤ãƒ«åã‚µãƒ‹ã‚¿ã‚¤ã‚ºã€çµ¶å¯¾ãƒ‘ã‚¹ç¦æ­¢ |
| **å¤§é‡ãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡** | ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã€1ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸1ãƒ•ã‚¡ã‚¤ãƒ« |

### 6.7. è¨ªå•é–‹å§‹ãƒ•ãƒ­ãƒ¼

è¨ªå•é–‹å§‹æ™‚ã®è©³ç´°ãªæ‰‹é †ã‚’ç¤ºã—ã¾ã™ã€‚

#### 6.7.1. è¨ªå•ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ãƒ­ãƒ¼

```
Visitor (User B) ãŒè¨ªå•ã‚’é–‹å§‹
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è¨ªå•å…ˆCityã®é¸æŠ                  â”‚
â”‚    - discord_list_channels ã§ä¸€è¦§å–å¾—â”‚
â”‚    - å…¬é–‹ä¸­ã®Public Cityä¸€è¦§ã‚’è¡¨ç¤º   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. HostçŠ¶æ…‹ã®ç¢ºèª                    â”‚
â”‚    - Discordãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹ã‚’ç¢ºèª         â”‚
â”‚    - ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§ãªã‘ã‚Œã°è¨ªå•ä¸å¯é€šçŸ¥ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ Host ã‚ªãƒ³ãƒ©ã‚¤ãƒ³
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. è¨ªå•å¯¾è±¡Buildingã®é¸æŠ            â”‚
â”‚    - å¯¾è±¡ãƒãƒ£ãƒ³ãƒãƒ«å†…ã®ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§   â”‚
â”‚    - ãƒšãƒ«ã‚½ãƒŠãŒè¡ŒããŸã„Buildingã‚’é¸æŠ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. è¨ªå•çŠ¶æ…‹ã®åˆæœŸåŒ–                  â”‚
â”‚    - VisitState.is_visiting = true  â”‚
â”‚    - home_* ã«ç¾åœ¨åœ°ã‚’ä¿å­˜           â”‚
â”‚    - visiting_* ã«è¨ªå•å…ˆã‚’è¨­å®š       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. è¨ªå•ã‚¢ãƒŠã‚¦ãƒ³ã‚¹é€ä¿¡                â”‚
â”‚    - Discordã‚¹ãƒ¬ãƒƒãƒ‰ã«å…¥å®¤ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ â”‚
â”‚    - ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã«è¨ªå•æƒ…å ±ã‚’ä»˜ä¸       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Hostå´ã§ã®å—ã‘å…¥ã‚Œå‡¦ç†            â”‚
â”‚    - è¨ªå•è€…ãƒšãƒ«ã‚½ãƒŠã®æƒ…å ±ã‚’å—ä¿¡       â”‚
â”‚    - Building occupantsã«è¿½åŠ        â”‚
â”‚    - æ­“è¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä»»æ„ï¼‰          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 6.7.2. è¨ªå•ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

Discordã‚¹ãƒ¬ãƒƒãƒ‰ã«æŠ•ç¨¿ã•ã‚Œã‚‹è¨ªå•é–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼š

```json
{
  "content": "ğŸš¶ **è¨ªå•è€…åˆ°ç€**: Persona Y ãŒå…¥å®¤ã—ã¾ã—ãŸ",
  "metadata": {
    "type": "visit_announcement",
    "action": "enter",
    "visitor": {
      "id": "persona_y",
      "name": "ãƒšãƒ«ã‚½ãƒŠY",
      "home_city": "private_city_bob",
      "owner_discord_id": "2222222222222222222"
    },
    "timestamp": "2025-01-05T14:00:00Z"
  }
}
```

#### 6.7.3. è¨ªå•é–‹å§‹ã®å®Ÿè£…ã‚¤ãƒ¡ãƒ¼ã‚¸

```python
class DiscordConnector:
    async def start_visit(
        self,
        persona: PersonaCore,
        target_city_id: str,
        target_building_id: str,
    ) -> dict:
        """ãƒšãƒ«ã‚½ãƒŠã®è¨ªå•ã‚’é–‹å§‹"""

        # 1. ç¾åœ¨åœ°ã‚’ä¿å­˜
        visit_state = VisitState(
            is_visiting=True,
            home_city_id=persona.city_id,
            home_building_id=persona.current_building_id,
            visiting_city_id=target_city_id,
            visiting_building_id=target_building_id,
            visit_started_at=datetime.utcnow(),
        )
        persona.visit_state = visit_state

        # 2. Hostã®ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹ç¢ºèª
        host_online = await self._check_host_presence(target_city_id)
        if not host_online:
            visit_state.reset()
            return {"success": False, "error": "Host is offline"}

        # 3. è¨ªå•ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ã‚’é€ä¿¡
        thread_id = self._mapping.get_thread_id(target_building_id)
        await self._send_visit_announcement(
            thread_id=thread_id,
            persona=persona,
            action="enter",
        )

        # 4. è¨˜æ†¶ã«è¨˜éŒ²
        persona.sai_memory.append_message({
            "role": "system",
            "content": f"{target_city_id}ã®{target_building_id}ã¸ã®è¨ªå•ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚",
            "timestamp": datetime.utcnow().isoformat(),
            "metadata": {
                "event": "visit_start",
                "target_city": target_city_id,
                "target_building": target_building_id,
            }
        })

        return {"success": True, "visit_state": visit_state}
```

### 6.8. ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹ç®¡ç†

Hostã®ã‚ªãƒ³ãƒ©ã‚¤ãƒ³/ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã‚’æ¤œçŸ¥ã™ã‚‹ãŸã‚ã®ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹ç®¡ç†ä»•æ§˜ã€‚

#### 6.8.1. ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹æ¤œçŸ¥æ–¹å¼

Discord GatewayçµŒç”±ã§å–å¾—å¯èƒ½ãªãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹æƒ…å ±ã‚’æ´»ç”¨ï¼š

| æ¤œçŸ¥æ–¹å¼ | èª¬æ˜ | åˆ©ç”¨å ´é¢ |
|----------|------|----------|
| **presence_update ã‚¤ãƒ™ãƒ³ãƒˆ** | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹å¤‰æ›´ã‚’æ¤œçŸ¥ | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œçŸ¥ |
| **ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆç¢ºèª** | å®šæœŸçš„ãªping/pongã«ã‚ˆã‚‹æ¥ç¶šç¢ºèª | æ¥ç¶šæ–­ã®æ¤œçŸ¥ |
| **æœ€çµ‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ™‚åˆ»** | Buildingå†…ã®æœ€çµ‚æ´»å‹•æ™‚åˆ» | ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆåˆ¤å®š |

#### 6.8.2. ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹çŠ¶æ…‹

```python
class HostPresence:
    """Hostã®ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹çŠ¶æ…‹"""

    class Status(Enum):
        ONLINE = "online"      # SAIVerseèµ·å‹•ä¸­ã€Discordæ¥ç¶šä¸­
        IDLE = "idle"          # æ¥ç¶šä¸­ã ãŒä¸€å®šæ™‚é–“éæ´»å‹•
        OFFLINE = "offline"    # SAIVerseåœæ­¢ã¾ãŸã¯Discordåˆ‡æ–­
        UNKNOWN = "unknown"    # çŠ¶æ…‹ä¸æ˜

    discord_user_id: str
    status: Status
    last_seen_at: datetime | None
    last_message_at: datetime | None
    connected_cities: list[str]  # å…¬é–‹ä¸­ã®Public City IDs
```

#### 6.8.3. ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹è¿½è·¡ã®å®Ÿè£…

```python
class PresenceTracker:
    """Hostã®ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹ã‚’è¿½è·¡"""

    def __init__(self):
        self._host_status: dict[str, HostPresence] = {}
        self._heartbeat_interval = 30  # ç§’

    async def on_presence_update(self, member: discord.Member) -> None:
        """Discord presence_update ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©"""
        user_id = str(member.id)

        if user_id in self._host_status:
            presence = self._host_status[user_id]

            old_status = presence.status
            new_status = self._map_discord_status(member.status)

            presence.status = new_status
            presence.last_seen_at = datetime.utcnow()

            # ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã«å¤‰ã‚ã£ãŸå ´åˆã€è¨ªå•ä¸­ãƒšãƒ«ã‚½ãƒŠã‚’å¼·åˆ¶é€é‚„
            if old_status != HostPresence.Status.OFFLINE and \
               new_status == HostPresence.Status.OFFLINE:
                await self._handle_host_went_offline(user_id)

    def _map_discord_status(self, status: discord.Status) -> HostPresence.Status:
        """Discordã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å†…éƒ¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«ãƒãƒƒãƒ”ãƒ³ã‚°"""
        mapping = {
            discord.Status.online: HostPresence.Status.ONLINE,
            discord.Status.idle: HostPresence.Status.IDLE,
            discord.Status.dnd: HostPresence.Status.ONLINE,  # DNDã§ã‚‚ç¨¼åƒä¸­æ‰±ã„
            discord.Status.offline: HostPresence.Status.OFFLINE,
            discord.Status.invisible: HostPresence.Status.OFFLINE,
        }
        return mapping.get(status, HostPresence.Status.UNKNOWN)

    async def start_heartbeat_loop(self) -> None:
        """ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆã«ã‚ˆã‚‹æ¥ç¶šç¢ºèªãƒ«ãƒ¼ãƒ—"""
        while True:
            await asyncio.sleep(self._heartbeat_interval)
            await self._check_all_hosts()

    async def _check_all_hosts(self) -> None:
        """å…¨Hostã®çŠ¶æ…‹ã‚’ç¢ºèª"""
        for user_id, presence in self._host_status.items():
            if presence.status == HostPresence.Status.ONLINE:
                # æœ€çµ‚ç¢ºèªã‹ã‚‰ä¸€å®šæ™‚é–“çµŒéã—ã¦ã„ã‚Œã° IDLE ã«
                if presence.last_seen_at:
                    elapsed = (datetime.utcnow() - presence.last_seen_at).total_seconds()
                    if elapsed > self._heartbeat_interval * 3:
                        presence.status = HostPresence.Status.IDLE
```

#### 6.8.4. Botãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹ã®å…¬é–‹

SAIVerseã®ç¨¼åƒçŠ¶æ…‹ã‚’ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥ã™ã‚‹ãŸã‚ã€Botè‡ªèº«ã®ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹ã‚’è¨­å®šï¼š

```python
class DiscordConnector:
    async def _update_bot_presence(self, status: str = "online") -> None:
        """Botã®ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹ã‚’æ›´æ–°"""
        if status == "online":
            activity = discord.Activity(
                type=discord.ActivityType.watching,
                name="Public City ã‚’å…¬é–‹ä¸­"
            )
            await self._client.change_presence(
                status=discord.Status.online,
                activity=activity,
            )
        elif status == "idle":
            await self._client.change_presence(
                status=discord.Status.idle,
            )
        elif status == "offline":
            await self._client.change_presence(
                status=discord.Status.invisible,
            )
```

### 6.9. å†æ¥ç¶šãƒãƒªã‚·ãƒ¼

Discord WebSocketæ¥ç¶šãŒåˆ‡æ–­ã•ã‚ŒãŸå ´åˆã®å†æ¥ç¶šæˆ¦ç•¥ã€‚

#### 6.9.1. å†æ¥ç¶šãƒˆãƒªã‚¬ãƒ¼

| ãƒˆãƒªã‚¬ãƒ¼ | èª¬æ˜ | å¯¾å¿œ |
|----------|------|------|
| **ä¸€æ™‚çš„ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯éšœå®³** | ç¬æ–­ã€ãƒ‘ã‚±ãƒƒãƒˆãƒ­ã‚¹ | å³åº§ã«å†æ¥ç¶šè©¦è¡Œ |
| **Discordã‚µãƒ¼ãƒãƒ¼éšœå®³** | Discordãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ç­‰ | æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã§å†è©¦è¡Œ |
| **èªè¨¼ã‚¨ãƒ©ãƒ¼** | ãƒˆãƒ¼ã‚¯ãƒ³å¤±åŠ¹ã€æ¨©é™å‰¥å¥ª | å†æ¥ç¶šä¸­æ­¢ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šçŸ¥ |
| **ãƒ¬ãƒ¼ãƒˆåˆ¶é™** | éå‰°ãªæ¥ç¶šè©¦è¡Œ | é•·ã‚ã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ |

#### 6.9.2. æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ• with Jitter

```python
class ReconnectPolicy:
    """å†æ¥ç¶šãƒãƒªã‚·ãƒ¼"""

    def __init__(
        self,
        initial_delay: float = 1.0,      # åˆå›å¾…æ©Ÿç§’æ•°
        max_delay: float = 60.0,         # æœ€å¤§å¾…æ©Ÿç§’æ•°
        multiplier: float = 2.0,         # å¢—åŠ å€ç‡
        jitter: float = 0.3,             # ã‚¸ãƒƒã‚¿ãƒ¼ (0.0-1.0)
        max_retries: int = 10,           # æœ€å¤§è©¦è¡Œå›æ•°
    ):
        self.initial_delay = initial_delay
        self.max_delay = max_delay
        self.multiplier = multiplier
        self.jitter = jitter
        self.max_retries = max_retries
        self._attempt = 0

    def next_delay(self) -> float | None:
        """æ¬¡ã®å¾…æ©Ÿæ™‚é–“ã‚’è¨ˆç®—ã€æœ€å¤§è©¦è¡Œå›æ•°è¶…éæ™‚ã¯None"""
        if self._attempt >= self.max_retries:
            return None

        delay = min(
            self.initial_delay * (self.multiplier ** self._attempt),
            self.max_delay,
        )

        # ã‚¸ãƒƒã‚¿ãƒ¼ã‚’é©ç”¨
        jitter_range = delay * self.jitter
        delay += random.uniform(-jitter_range, jitter_range)

        self._attempt += 1
        return max(delay, 0.1)  # æœ€å°0.1ç§’

    def reset(self) -> None:
        """æˆåŠŸæ™‚ã«ã‚«ã‚¦ãƒ³ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ"""
        self._attempt = 0
```

#### 6.9.3. å†æ¥ç¶šãƒ•ãƒ­ãƒ¼

```
Discordæ¥ç¶šæ–­æ¤œçŸ¥
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. åˆ‡æ–­ç†ç”±ã®åˆ¤å®š                    â”‚
â”‚    - ä¸€æ™‚çš„éšœå®³ / èªè¨¼ã‚¨ãƒ©ãƒ¼ / åˆ¶é™  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ èªè¨¼ã‚¨ãƒ©ãƒ¼ã®å ´åˆ                      â”‚
    â”‚    â””â”€â–¶ å†æ¥ç¶šä¸­æ­¢ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šçŸ¥       â”‚
    â”‚        è¨ªå•ä¸­ãƒšãƒ«ã‚½ãƒŠã‚’å¼·åˆ¶é€é‚„        â”‚
    â”‚                                      â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®å ´åˆ                      â”‚
    â”‚    â””â”€â–¶ Retry-Afterç§’å¾…æ©Ÿå¾Œã«å†è©¦è¡Œ   â”‚
    â”‚                                      â”‚
    â–¼ ä¸€æ™‚çš„éšœå®³ã®å ´åˆ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ReconnectPolicy.next_delay()     â”‚
â”‚    - æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã§å¾…æ©Ÿæ™‚é–“ã‚’ç®—å‡º   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”‚ å¾…æ©Ÿæ™‚é–“ãŒNone (æœ€å¤§è©¦è¡Œå›æ•°è¶…é)
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    â””â”€â–¶ å†æ¥ç¶šæ–­å¿µã€ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šçŸ¥       â”‚
    â”‚        è¨ªå•ä¸­ãƒšãƒ«ã‚½ãƒŠã‚’å¼·åˆ¶é€é‚„        â”‚
    â”‚                                      â”‚
    â–¼ å¾…æ©Ÿæ™‚é–“ã‚ã‚Š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. å¾…æ©Ÿ                              â”‚
â”‚    - asyncio.sleep(delay)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. å†æ¥ç¶šè©¦è¡Œ                        â”‚
â”‚    - Discord WebSocketå†æ¥ç¶š         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”œâ”€â”€â”€ å¤±æ•— â”€â–¶ ã‚¹ãƒ†ãƒƒãƒ—2ã¸æˆ»ã‚‹
    â”‚
    â–¼ æˆåŠŸ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. å†æ¥ç¶šæˆåŠŸå‡¦ç†                    â”‚
â”‚    - ReconnectPolicy.reset()        â”‚
â”‚    - å·®åˆ†åŒæœŸã®å®Ÿè¡Œ                  â”‚
â”‚    - ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹å¾©æ—§                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 6.9.4. å®Ÿè£…ã‚¤ãƒ¡ãƒ¼ã‚¸

```python
class DiscordConnector:
    def __init__(self, ...):
        ...
        self._reconnect_policy = ReconnectPolicy(
            initial_delay=1.0,
            max_delay=60.0,
            max_retries=10,
        )

    async def _connection_loop(self) -> None:
        """æ¥ç¶šç¶­æŒãƒ«ãƒ¼ãƒ—"""
        while self._should_run:
            try:
                await self._client.start(self.settings.bot_token)
            except discord.LoginFailure:
                # èªè¨¼ã‚¨ãƒ©ãƒ¼ - å†æ¥ç¶šä¸å¯
                logger.error("Discord login failed - invalid token")
                await self._handle_fatal_disconnect("auth_error")
                break
            except discord.HTTPException as e:
                if e.status == 429:  # Rate limited
                    retry_after = e.retry_after or 60
                    logger.warning("Rate limited, waiting %s seconds", retry_after)
                    await asyncio.sleep(retry_after)
                    continue
                raise
            except Exception as e:
                logger.warning("Discord connection lost: %s", e)

                delay = self._reconnect_policy.next_delay()
                if delay is None:
                    logger.error("Max reconnect attempts reached")
                    await self._handle_fatal_disconnect("max_retries")
                    break

                logger.info("Reconnecting in %.1f seconds...", delay)
                await asyncio.sleep(delay)

    async def _on_connect(self) -> None:
        """æ¥ç¶šæˆåŠŸæ™‚"""
        self._reconnect_policy.reset()
        logger.info("Discord connected successfully")
        await self._sync_after_reconnect()
```

### 6.10. OccupancyManagerã¨ã®é€£æº

Hostå´ã®SAIVerseã§Discordè¨ªå•è€…ã‚’ä¼šè©±ã«å‚åŠ ã•ã›ã‚‹ãŸã‚ã®é€£æºè¨­è¨ˆã€‚

#### 6.10.1. åŸºæœ¬æ–¹é‡

- Discordè¨ªå•è€…ã‚’OccupancyManagerã«ç™»éŒ²ã—ã€ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ­ãƒ“ãƒ³ä¼šè©±ã«å‚åŠ ã•ã›ã‚‹
- SDSãƒ™ãƒ¼ã‚¹ã®`RemotePersonaProxy`ã¯éæ¨å¥¨ã¨ã—ã€Discordæ–¹å¼å®‰å®šå¾Œã«å»ƒæ­¢äºˆå®š
- Discordãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆäººé–“ï¼‰ã¯ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ­ãƒ“ãƒ³å¯¾è±¡å¤–ã€ã„ã¤ã§ã‚‚ç™ºè¨€å¯èƒ½

#### 6.10.2. DiscordVisitorStub

DiscordçµŒç”±ã®è¨ªå•è€…ã‚’è¡¨ã™è»½é‡ã‚¹ã‚¿ãƒ–ã‚¯ãƒ©ã‚¹ã€‚

```python
from dataclasses import dataclass
from typing import Optional

@dataclass
class DiscordVisitorStub:
    """DiscordçµŒç”±ã®è¨ªå•è€…ã‚’è¡¨ã™è»½é‡ã‚¹ã‚¿ãƒ–

    Hostå´ã®OccupancyManagerã«ç™»éŒ²ã•ã‚Œã€ConversationManagerã®
    ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ­ãƒ“ãƒ³ä¼šè©±ã«å‚åŠ ã§ãã‚‹ã€‚ãŸã ã—ã€å®Ÿéš›ã®run_sea_auto()ã¯
    Visitorå´ã§å®Ÿè¡Œã•ã‚Œã‚‹ã€‚
    """
    persona_id: str
    persona_name: str
    home_city_id: str
    avatar_url: Optional[str] = None
    discord_channel_id: int = 0

    # ConversationManagerã§ç›´æ¥run_sea_auto()ã—ãªã„ãŸã‚ã®ãƒ•ãƒ©ã‚°
    is_proxy: bool = True

    # Discordãƒ™ãƒ¼ã‚¹ã®è¨ªå•è€…ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ãƒ•ãƒ©ã‚°
    is_discord_visitor: bool = True

    # interaction_modeã¯'auto'ã¨ã—ã¦æ‰±ã†ï¼ˆãƒ©ã‚¦ãƒ³ãƒ‰ãƒ­ãƒ“ãƒ³å¯¾è±¡ï¼‰
    interaction_mode: str = 'auto'

    # ãƒšãƒ«ã‚½ãƒŠã¨ã—ã¦èªè­˜ã•ã‚Œã‚‹ãŸã‚ã®äº’æ›å±æ€§
    @property
    def persona_name(self) -> str:
        return self._persona_name

    @persona_name.setter
    def persona_name(self, value: str):
        self._persona_name = value
```

#### 6.10.3. è¨ªå•è€…ç™»éŒ²ãƒ•ãƒ­ãƒ¼

```
è¨ªå•ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡ï¼ˆdiscord_visitãƒ„ãƒ¼ãƒ«çµŒç”±ï¼‰
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãƒã‚§ãƒƒã‚¯              â”‚
â”‚    - allowlist/blocklistæ¤œè¨¼        â”‚
â”‚    - ç½²åæ¤œè¨¼                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. DiscordVisitorStubä½œæˆ           â”‚
â”‚    - persona_id, persona_nameå–å¾—   â”‚
â”‚    - is_proxy=True, is_discord_visitor=True â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. OccupancyManagerç™»éŒ²             â”‚
â”‚    - all_personas[persona_id] = stub â”‚
â”‚    - occupants[building_id].append() â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. å…¥å®¤é€šçŸ¥Embedé€ä¿¡                 â”‚
â”‚    - type:visit_accepted            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

å®Ÿè£…ã‚¤ãƒ¡ãƒ¼ã‚¸:

```python
async def _handle_visit_request(
    self,
    channel_id: int,
    visitor_persona_id: str,
    visitor_persona_name: str,
    visitor_city_id: str,
    avatar_url: Optional[str] = None,
) -> bool:
    """è¨ªå•ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†"""

    mapping = self._mapping_db.get_mapping_by_channel(channel_id)
    if not mapping:
        return False

    # ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãƒã‚§ãƒƒã‚¯
    if not self._access_control.is_allowed(
        EntityType.PERSONA, visitor_persona_id, signature_valid=True
    ):
        await self._send_visit_rejected(channel_id, visitor_persona_id)
        return False

    # DiscordVisitorStubä½œæˆ
    stub = DiscordVisitorStub(
        persona_id=visitor_persona_id,
        persona_name=visitor_persona_name,
        home_city_id=visitor_city_id,
        avatar_url=avatar_url,
        discord_channel_id=channel_id,
    )

    # OccupancyManagerç™»éŒ²
    self._manager.all_personas[visitor_persona_id] = stub
    self._manager.occupancy_manager.enter_building(
        persona_id=visitor_persona_id,
        building_id=mapping.building_id,
    )

    # å…¥å®¤é€šçŸ¥
    await self._send_visit_accepted(channel_id, visitor_persona_id)

    logger.info(
        "Discord visitor %s registered to building %s",
        visitor_persona_id, mapping.building_id
    )
    return True
```

#### 6.10.4. Turn Requestï¼ˆç™ºè¨€æ¨©ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰

ConversationManagerãŒDiscordè¨ªå•è€…ã®ç•ªã«ãªã£ãŸå ´åˆã€Visitorå´ã«run_sea_auto()å®Ÿè¡Œã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ã€‚

**Turn Request Embedå½¢å¼:**

```python
async def _send_turn_request(
    self,
    channel_id: int,
    target_persona_id: str,
    timeout_seconds: int = 30,
) -> None:
    """ç™ºè¨€æ¨©ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’Discordã«é€ä¿¡"""

    embed = discord.Embed(
        title="ğŸ¤ Turn Request",
        description=f"Your turn to speak",
        color=0xFFD700,  # ã‚´ãƒ¼ãƒ«ãƒ‰
    )
    embed.set_footer(
        text=f"type:turn_request|pid:{target_persona_id}|timeout:{timeout_seconds}"
    )

    channel = self._client.get_channel(channel_id)
    await channel.send(embed=embed)
```

**Visitorå´ã§ã®å‡¦ç†:**

```python
async def _on_turn_request(
    self,
    channel_id: int,
    target_persona_id: str,
    timeout_seconds: int,
) -> None:
    """Turn Requestã‚’å—ä¿¡ã—ãŸæ™‚ã®å‡¦ç†"""

    # è‡ªåˆ†ã®ãƒšãƒ«ã‚½ãƒŠã‹ãƒã‚§ãƒƒã‚¯
    persona = self._manager.all_personas.get(target_persona_id)
    if not persona or getattr(persona, 'is_proxy', False):
        return

    # WebSocketæ¥ç¶šä¸­ã§ãªã‘ã‚Œã°ç„¡è¦–ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã§ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹ï¼‰
    if not self._client.is_ready():
        logger.warning("Turn request received but not connected")
        return

    # run_sea_auto()ã‚’å®Ÿè¡Œ
    building_id = self._get_building_for_channel(channel_id)
    occupants = self._manager.occupants.get(building_id, [])

    self._manager.run_sea_auto(persona, building_id, occupants)
```

#### 6.10.5. ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†

Hostå´ã§Turn Requesté€ä¿¡å¾Œã€ä¸€å®šæ™‚é–“å†…ã«ç™ºè¨€ãŒãªã‘ã‚Œã°æ¬¡ã®ç™ºè¨€è€…ã¸ã‚¹ã‚­ãƒƒãƒ—ã€‚

```python
class TurnManager:
    """ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ­ãƒ“ãƒ³ã®ã‚¿ãƒ¼ãƒ³ç®¡ç†"""

    def __init__(self, timeout_seconds: int = 30):
        self.timeout_seconds = timeout_seconds
        self._pending_turns: Dict[str, asyncio.Task] = {}

    async def wait_for_turn_response(
        self,
        persona_id: str,
        channel_id: int,
    ) -> bool:
        """è¨ªå•è€…ã®ç™ºè¨€ã‚’å¾…æ©Ÿã€‚ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã§Falseã‚’è¿”ã™"""

        # æ—¢å­˜ã®ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Œã°ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        if persona_id in self._pending_turns:
            self._pending_turns[persona_id].cancel()

        try:
            task = asyncio.create_task(
                self._wait_for_message(persona_id, channel_id)
            )
            self._pending_turns[persona_id] = task

            await asyncio.wait_for(task, timeout=self.timeout_seconds)
            return True

        except asyncio.TimeoutError:
            logger.info(
                "Turn timeout for visitor %s after %d seconds",
                persona_id, self.timeout_seconds
            )
            return False
        finally:
            self._pending_turns.pop(persona_id, None)

    async def _wait_for_message(
        self,
        persona_id: str,
        channel_id: int,
    ) -> None:
        """æŒ‡å®šãƒšãƒ«ã‚½ãƒŠã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¾…æ©Ÿ"""

        while True:
            # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ¥ãƒ¼ã‹ã‚‰å–å¾—ï¼ˆå®Ÿè£…è©³ç´°ã¯çœç•¥ï¼‰
            message = await self._message_queue.get()

            if message.persona_id == persona_id and \
               message.channel_id == channel_id:
                return
```

**ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚ã®å‹•ä½œ:**

| æ¡ä»¶ | æŒ™å‹• |
|------|------|
| 30ç§’ä»¥å†…ã«ç™ºè¨€ | æ­£å¸¸ã«ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ­ãƒ“ãƒ³ç¶™ç¶š |
| 30ç§’ä»¥å†…ã«ç™ºè¨€ãªã— | æ¬¡ã®ç™ºè¨€è€…ã«ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãƒ­ã‚°è¨˜éŒ²ï¼‰ |
| WebSocketæœªæ¥ç¶š | å³æ™‚ã‚¹ã‚­ãƒƒãƒ—ï¼ˆã€Œé€æ˜äººé–“ã€çŠ¶æ…‹ã¨ã—ã¦é€šçŸ¥ï¼‰ |

#### 6.10.6. Discordãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆäººé–“ï¼‰ã®æ‰±ã„

| é …ç›® | ä»•æ§˜ |
|------|------|
| ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ­ãƒ“ãƒ³å‚åŠ  | ã—ãªã„ï¼ˆã„ã¤ã§ã‚‚ç™ºè¨€å¯èƒ½ï¼‰ |
| OccupancyManagerç™»éŒ² | ã—ãªã„ï¼ˆè¦³æˆ¦è€…æ‰±ã„ï¼‰ |
| Buildingå±¥æ­´è¨˜éŒ² | ã•ã‚Œã‚‹ï¼ˆrole="user"ï¼‰ |
| SAIMemoryè¨˜éŒ² | ã•ã‚Œã‚‹ï¼ˆè©²å½“Buildingå†…ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒšãƒ«ã‚½ãƒŠã®ã¿ï¼‰ |

```python
def _is_discord_user_message(self, message: discord.Message) -> bool:
    """Discordãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆäººé–“ï¼‰ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã©ã†ã‹"""
    return not message.author.bot

async def _handle_user_message(
    self,
    message: discord.Message,
    channel_id: int,
) -> None:
    """Discordãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡¦ç†"""

    # Buildingå±¥æ­´ã«è¨˜éŒ²
    await self._record_to_building_history(
        MessageSource(type="user", role="user", ...),
        channel_id,
        str(message.id),
    )

    # SAIMemoryã«è¨˜éŒ²ï¼ˆBuildingå†…ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒšãƒ«ã‚½ãƒŠã®ã¿ï¼‰
    await self._record_to_persona_memory(
        MessageSource(type="user", role="user", ...),
        channel_id,
        str(message.id),
    )

    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯run_pulseã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ã¦ã‚‚ã‚ˆã„
    # ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³: è¨­å®šã§æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆï¼‰
```

#### 6.10.7. RemotePersonaProxyã¨ã®æ¯”è¼ƒ

| é …ç›® | RemotePersonaProxy (SDS) | DiscordVisitorStub (Discord) |
|------|-------------------------|------------------------------|
| é€šä¿¡æ–¹å¼ | REST APIç›´æ¥å‘¼ã³å‡ºã— | Discord WebSocket/REST API |
| thinkingå®Ÿè¡Œ | `/persona-proxy/{id}/think` API | Turn Request â†’ Visitorå´ã§å®Ÿè¡Œ |
| çŠ¶æ…‹ç®¡ç† | `VisitingAI`ãƒ†ãƒ¼ãƒ–ãƒ« | `connector.db` visit_states |
| ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¦ä»¶ | åŒæ–¹å‘APIåˆ°é”æ€§å¿…è¦ | DiscordçµŒç”±ã®ã¿ |
| å°†æ¥ | éæ¨å¥¨â†’å»ƒæ­¢äºˆå®š | ãƒ¡ã‚¤ãƒ³æ–¹å¼ |

**ç§»è¡Œè¨ˆç”»:**

1. Discord Connector v1ãƒªãƒªãƒ¼ã‚¹
2. æ–°è¦è¨ªå•ã¯Discordæ–¹å¼ã‚’å„ªå…ˆ
3. SDSæ–¹å¼ã¯äº’æ›æ€§ç¶­æŒã®ãŸã‚ä¸€å®šæœŸé–“ä¸¦è¡Œç¨¼åƒ
4. Discordæ–¹å¼å®‰å®šç¢ºèªå¾Œã€SDSæ–¹å¼ã‚’å»ƒæ­¢

---

## 7. å®Ÿè£…è©³ç´°

### 7.1. ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

Discord Connectorã¯ãƒ•ã‚¡ãƒ³ãƒ¡ã‚¤ãƒ‰æ©Ÿèƒ½ã¨ã—ã¦`user_data/`é…ä¸‹ã«é…ç½®ã—ã€git cloneã§å°å…¥å¯èƒ½ãªæ§‹æˆã¨ã—ã¾ã™ã€‚

```
SAIVerse/
â”œâ”€â”€ tools/
â”‚   â”œâ”€â”€ __init__.py                     # schemas()å¯¾å¿œã‚’è¿½åŠ ï¼ˆç´„20è¡Œï¼‰
â”‚   â””â”€â”€ defs/
â”‚       â””â”€â”€ __init__.py                 # ToolSchemaå®šç¾©ï¼ˆå¤‰æ›´ãªã—ï¼‰
â”‚
â”œâ”€â”€ user_data/
â”‚   â”œâ”€â”€ phenomena/                      # â˜… Phenomenonå®šç¾©ï¼ˆã‚µãƒ¼ãƒãƒ¼èµ·å‹•/çµ‚äº†æ™‚ã®è‡ªå‹•åˆæœŸåŒ–ï¼‰
â”‚   â”‚   â”œâ”€â”€ discord_connector.py        # discord_connector_startï¼ˆSERVER_STARTç™ºç«ï¼‰
â”‚   â”‚   â””â”€â”€ discord_connector_stop.py   # discord_connector_stopï¼ˆSERVER_STOPç™ºç«ï¼‰
â”‚   â”‚
â”‚   â””â”€â”€ tools/
â”‚       â””â”€â”€ discord/                    # â˜… git cloneå…ˆï¼ˆãƒ•ã‚¡ãƒ³ãƒ¡ã‚¤ãƒ‰æ©Ÿèƒ½ï¼‰
â”‚           â”œâ”€â”€ schema.py               # å…¨ãƒ„ãƒ¼ãƒ«ã®ã‚¹ã‚­ãƒ¼ãƒ + å®Ÿè£…ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ
â”‚           â”‚
â”‚           â”œâ”€â”€ connector/              # ã‚³ã‚¢æ©Ÿèƒ½
â”‚           â”‚   â”œâ”€â”€ __init__.py         # get_or_create_connector(), get_connector()
â”‚           â”‚   â”œâ”€â”€ relay_client.py     # ãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
â”‚           â”‚   â”œâ”€â”€ oauth.py            # Discord OAuth2å‡¦ç†
â”‚           â”‚   â”œâ”€â”€ config.py           # è¨­å®šç®¡ç† (Pydantic Settings)
â”‚           â”‚   â”œâ”€â”€ mapping.py          # City/Building âŸ· Channel/Thread ãƒãƒƒãƒ”ãƒ³ã‚°
â”‚           â”‚   â”œâ”€â”€ sync.py             # åŒæœŸãƒ­ã‚¸ãƒƒã‚¯
â”‚           â”‚   â”œâ”€â”€ events.py           # ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
â”‚           â”‚   â””â”€â”€ operations.py       # ãƒ„ãƒ¼ãƒ«ã‹ã‚‰å‘¼ã°ã‚Œã‚‹å®Ÿè£…é–¢æ•°
â”‚           â”‚
â”‚           â”œâ”€â”€ visit/                  # è¨ªå•ã‚·ã‚¹ãƒ†ãƒ 
â”‚           â”‚   â”œâ”€â”€ __init__.py
â”‚           â”‚   â”œâ”€â”€ state.py            # VisitState ã‚¯ãƒ©ã‚¹
â”‚           â”‚   â”œâ”€â”€ stub.py             # DiscordVisitorStub ã‚¯ãƒ©ã‚¹
â”‚           â”‚   â”œâ”€â”€ presence.py         # PresenceTracker
â”‚           â”‚   â”œâ”€â”€ forced_return.py    # å¼·åˆ¶é€é‚„ãƒ­ã‚¸ãƒƒã‚¯
â”‚           â”‚   â””â”€â”€ file_transfer.py    # ãƒ•ã‚¡ã‚¤ãƒ«è»¢é€å‡¦ç†
â”‚           â”‚
â”‚           â”œâ”€â”€ db/                     # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
â”‚           â”‚   â”œâ”€â”€ __init__.py
â”‚           â”‚   â”œâ”€â”€ models.py           # SQLAlchemy / Pydantic ãƒ¢ãƒ‡ãƒ«
â”‚           â”‚   â””â”€â”€ queries.py          # DBã‚¯ã‚¨ãƒªãƒ˜ãƒ«ãƒ‘ãƒ¼
â”‚           â”‚
â”‚           â”œâ”€â”€ ui/                     # ç®¡ç†UI
â”‚           â”‚   â”œâ”€â”€ __init__.py
â”‚           â”‚   â”œâ”€â”€ app.py              # ãƒ¡ã‚¤ãƒ³UIèµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”‚           â”‚   â””â”€â”€ components/         # å„ã‚¿ãƒ–ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚           â”‚
â”‚           â””â”€â”€ docs/
â”‚               â””â”€â”€ setup_guide.md      # ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰
â”‚
â””â”€â”€ discord_gateway/
    â””â”€â”€ docs/                           # è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆæœ¬ãƒªãƒã‚¸ãƒˆãƒªï¼‰
        â”œâ”€â”€ implementation_discord.md
        â””â”€â”€ design_tasks.md
```

**NOTE**:
- `user_data/phenomena/`ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯PhenomenonManagerãŒè‡ªå‹•æ¤œå‡ºã—ã€SERVER_START/SERVER_STOPæ™‚ã«ç™ºç«
- `user_data/tools/discord/`ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒ„ãƒ¼ãƒ«è‡ªå‹•æ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ ãŒèª­ã¿è¾¼ã¿

### 7.1.2. å°å…¥æ–¹æ³•

```bash
# SAIVerseãƒªãƒã‚¸ãƒˆãƒªã®ãƒ«ãƒ¼ãƒˆã§å®Ÿè¡Œ
cd user_data/tools
git clone https://github.com/xxx/saiverse-discord-connector.git discord
```

### 7.1.3. ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆã®åˆ©ç‚¹

| è¦³ç‚¹ | åˆ©ç‚¹ |
|------|------|
| **ãƒ•ã‚¡ãƒ³ãƒ¡ã‚¤ãƒ‰å¯¾å¿œ** | SAIVerseæœ¬ä½“ã¨ã¯åˆ¥ãƒªãƒã‚¸ãƒˆãƒªã§ç®¡ç†å¯èƒ½ |
| **ç°¡å˜å°å…¥** | git cloneã®ã¿ã§å°å…¥å®Œäº† |
| **è‡ªå‹•æ¤œå‡ºäº’æ›** | æ—¢å­˜ã®`_autodiscover_tools()`ãŒ`user_data/tools/*/schema.py`ã‚’ã‚¹ã‚­ãƒ£ãƒ³ |
| **è²¬å‹™åˆ†é›¢** | ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ï¼ˆschema.pyï¼‰ã¨ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆconnector/ï¼‰ãŒæ˜ç¢ºã«åˆ†é›¢ |
| **è¤‡æ•°ãƒ„ãƒ¼ãƒ«å¯¾å¿œ** | `schemas()`é–¢æ•°ã§è¤‡æ•°ãƒ„ãƒ¼ãƒ«ã‚’ä¸€æ‹¬ç™»éŒ² |

### 7.1.4. ãƒ„ãƒ¼ãƒ«ç™»éŒ²

**è¨­è¨ˆæ–¹é‡: `schema.py`ã«`schemas()`é–¢æ•°ã‚’å®Ÿè£…**

SAIVerseã®ãƒ„ãƒ¼ãƒ«è‡ªå‹•æ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ ã‚’æ‹¡å¼µã—ã€`schemas()`ï¼ˆè¤‡æ•°å½¢ï¼‰é–¢æ•°ã‹ã‚‰è¤‡æ•°ãƒ„ãƒ¼ãƒ«ã‚’ä¸€æ‹¬ç™»éŒ²ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

**schema.py ã®æ§‹é€ :**

```python
# user_data/tools/discord/schema.py
"""Discord Connector - å…¨ãƒ„ãƒ¼ãƒ«ã®ã‚¹ã‚­ãƒ¼ãƒã¨å®Ÿè£…ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ"""

from tools.defs import ToolSchema

# ãƒ­ã‚¸ãƒƒã‚¯æœ¬ä½“ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from .connector import operations


def schemas() -> list[ToolSchema]:
    """è¤‡æ•°ãƒ„ãƒ¼ãƒ«ã®ã‚¹ã‚­ãƒ¼ãƒã‚’è¿”ã™"""
    return [
        ToolSchema(
            name="discord_send_message",
            description="Discordãƒãƒ£ãƒ³ãƒãƒ«ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹",
            parameters={
                "type": "object",
                "properties": {
                    "channel_id": {"type": "integer", "description": "é€ä¿¡å…ˆãƒãƒ£ãƒ³ãƒãƒ«ID"},
                    "content": {"type": "string", "description": "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹"},
                },
                "required": ["channel_id", "content"],
            },
            result_type="object",
        ),
        ToolSchema(
            name="discord_visit",
            description="DiscordçµŒç”±ã§ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®Public Cityã‚’è¨ªå•ã™ã‚‹",
            parameters={
                "type": "object",
                "properties": {
                    "channel_id": {"type": "integer", "description": "è¨ªå•å…ˆãƒãƒ£ãƒ³ãƒãƒ«ID"},
                    "building_id": {"type": "string", "description": "è¨ªå•å…ˆBuildingID"},
                },
                "required": ["channel_id"],
            },
            result_type="object",
        ),
        ToolSchema(
            name="discord_sync_messages",
            description="Discordã‹ã‚‰æœ€æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—ã—SAIMemoryã«åŒæœŸã™ã‚‹",
            parameters={
                "type": "object",
                "properties": {
                    "channel_id": {"type": "integer", "description": "åŒæœŸå¯¾è±¡ãƒãƒ£ãƒ³ãƒãƒ«ID"},
                    "limit": {"type": "integer", "description": "å–å¾—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°", "default": 50},
                },
                "required": ["channel_id"],
            },
            result_type="object",
        ),
        ToolSchema(
            name="discord_leave",
            description="è¨ªå•ä¸­ã®Public Cityã‹ã‚‰é€€å‡ºã™ã‚‹",
            parameters={
                "type": "object",
                "properties": {},
            },
            result_type="object",
        ),
    ]


# å®Ÿè£…é–¢æ•°ï¼ˆã‚¹ã‚­ãƒ¼ãƒã®nameã¨åŒåã§å®šç¾©ï¼‰
def discord_send_message(channel_id: int, content: str, **kwargs) -> dict:
    """Discordãƒãƒ£ãƒ³ãƒãƒ«ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡"""
    return operations.send_message(channel_id, content, **kwargs)


def discord_visit(channel_id: int, building_id: str = None, **kwargs) -> dict:
    """DiscordçµŒç”±ã§ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®Public Cityã‚’è¨ªå•"""
    return operations.start_visit(channel_id, building_id, **kwargs)


def discord_sync_messages(channel_id: int, limit: int = 50, **kwargs) -> dict:
    """Discordã‹ã‚‰æœ€æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—ã—SAIMemoryã«åŒæœŸ"""
    return operations.sync_messages(channel_id, limit, **kwargs)


def discord_leave(**kwargs) -> dict:
    """è¨ªå•ä¸­ã®Public Cityã‹ã‚‰é€€å‡º"""
    return operations.leave_visit(**kwargs)
```

### 7.1.5. SAIVerseæœ¬ä½“ã¸ã®å¤‰æ›´

**tools/__init__.py ã¸ã®è¿½åŠ ï¼ˆç´„20è¡Œï¼‰:**

```python
def _register_tool(module: Any) -> bool:
    # è¤‡æ•°ãƒ„ãƒ¼ãƒ«å¯¾å¿œ: schemas() ãŒã‚ã‚Œã°å„ªå…ˆ
    if hasattr(module, "schemas") and callable(module.schemas):
        return _register_multiple_tools(module)

    # æ—¢å­˜ã®å˜ä¸€ãƒ„ãƒ¼ãƒ«å‡¦ç†ï¼ˆå¤‰æ›´ãªã—ï¼‰
    if not hasattr(module, "schema") or not callable(module.schema):
        return False
    # ... ä»¥ä¸‹æ—¢å­˜ã‚³ãƒ¼ãƒ‰


def _register_multiple_tools(module: Any) -> bool:
    """schemas() ã‚’æŒã¤ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‹ã‚‰è¤‡æ•°ãƒ„ãƒ¼ãƒ«ã‚’ç™»éŒ²"""
    try:
        tool_schemas: list[ToolSchema] = module.schemas()
        registered = False
        for meta in tool_schemas:
            impl = getattr(module, meta.name, None)
            if not impl or not callable(impl):
                LOGGER.warning("Tool '%s' has schema but no implementation", meta.name)
                continue
            if meta.name in TOOL_REGISTRY:
                LOGGER.debug("Tool '%s' already registered, skipping", meta.name)
                continue

            TOOL_REGISTRY[meta.name] = impl
            OPENAI_TOOLS_SPEC.append(oa.to_openai(meta))
            GEMINI_TOOLS_SPEC.append(gm.to_gemini(meta))
            TOOL_SCHEMAS.append(meta)
            registered = True
            LOGGER.debug("Registered tool '%s' from multi-tool module", meta.name)
        return registered
    except Exception as e:
        LOGGER.warning("Failed to register tools from module: %s", e)
        return False
```

**saiverse_manager.py ã¸ã®è¿½åŠ ï¼ˆ1è¡Œï¼‰:**

```python
def run_sea_auto(self, persona, building_id, occupants):
    # Discordè¨ªå•è€…ã¯DiscordConnectorãŒå‡¦ç†
    if getattr(persona, 'is_discord_visitor', False):
        if self.discord_connector:
            self.discord_connector.handle_turn_request(persona, building_id)
        return

    # æ—¢å­˜å‡¦ç†ï¼ˆå¤‰æ›´ãªã—ï¼‰
    ...
```

### 7.1.6. æ—§ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã¨ã®æ¯”è¼ƒ

| é …ç›® | æ—§è¨­è¨ˆ | æ–°è¨­è¨ˆ |
|------|--------|--------|
| ãƒ„ãƒ¼ãƒ«é…ç½® | `tools/defs/discord_*.py` | `user_data/tools/discord/schema.py` |
| ãƒ­ã‚¸ãƒƒã‚¯é…ç½® | `tools/discord/` | `user_data/tools/discord/connector/` |
| å°å…¥æ–¹æ³• | SAIVerseæœ¬ä½“ã«çµ„ã¿è¾¼ã¿ | git clone |
| ã‚¹ã‚­ãƒ¼ãƒå½¢å¼ | 1ãƒ•ã‚¡ã‚¤ãƒ« = 1ãƒ„ãƒ¼ãƒ« | `schemas()` ã§è¤‡æ•°ãƒ„ãƒ¼ãƒ« |
| æœ¬ä½“å¤‰æ›´ | ãªã— | `tools/__init__.py` ã«ç´„20è¡Œè¿½åŠ  |

### 7.1.7. ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®é…ç½®

ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ã¯å¾“æ¥é€šã‚Š`~/.saiverse/`é…ä¸‹ã«ä¿å­˜ï¼š

```
~/.saiverse/
â”œâ”€â”€ discord_connector/                  # Discord Connector ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿
â”‚   â”œâ”€â”€ connector.db                    # å°‚ç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
â”‚   â”œâ”€â”€ mapping.json                    # ãƒãƒƒãƒ”ãƒ³ã‚°è¨­å®š
â”‚   â””â”€â”€ sync_state.json                 # åŒæœŸçŠ¶æ…‹
â”œâ”€â”€ cities/
â”‚   â””â”€â”€ {city_id}/
â”‚       â””â”€â”€ buildings/
â”‚           â””â”€â”€ {building_id}/
â”‚               â””â”€â”€ log.json            # Building ãƒ­ã‚°ï¼ˆDiscordåŒæœŸå«ã‚€ï¼‰
â””â”€â”€ personas/
    â””â”€â”€ {persona_id}/
        â”œâ”€â”€ memory.db                   # SAIMemory
        â””â”€â”€ downloads/                  # è¨ªå•æ™‚ã«å—ä¿¡ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«
```

### 7.1.8. åˆæœŸåŒ–ã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼ˆPhenomenonæ–¹å¼ï¼‰

Discord Connectorã®èµ·å‹•ãƒ»çµ‚äº†ã¯ã€SAIVerseã®æ—¢å­˜Phenomenonã‚·ã‚¹ãƒ†ãƒ ã‚’æ´»ç”¨ã—ã€`SERVER_START` / `SERVER_STOP` ãƒˆãƒªã‚¬ãƒ¼ã§è‡ªå‹•å®Ÿè¡Œã—ã¾ã™ã€‚

#### æ–¹å¼ã®åˆ©ç‚¹

| è¦³ç‚¹ | åˆ©ç‚¹ |
|------|------|
| **æœ¬ä½“å¤‰æ›´ä¸è¦** | main.pyã€SAIVerseManagerã¸ã®å¤‰æ›´ãªã— |
| **è¨­å®šã§åˆ¶å¾¡** | PhenomenonRule.ENABLEDã§æœ‰åŠ¹/ç„¡åŠ¹åˆ‡æ›¿ |
| **æ—¢å­˜åŸºç›¤æ´»ç”¨** | PhenomenonManagerã®ãƒˆãƒªã‚¬ãƒ¼/å®Ÿè¡ŒåŸºç›¤ã‚’å†åˆ©ç”¨ |
| **ãƒ•ã‚¡ãƒ³ãƒ¡ã‚¤ãƒ‰å¯¾å¿œ** | user_data/phenomena/ã«é…ç½®ã™ã‚‹ã ã‘ã§å‹•ä½œ |

#### Phenomenonå®šç¾©

**èµ·å‹•ãƒ•ã‚§ãƒãƒ¡ãƒãƒ³:**
```python
# user_data/phenomena/discord_connector.py
"""Discord Connector ã®èµ·å‹•ãƒ•ã‚§ãƒãƒ¡ãƒãƒ³"""

from phenomena.defs import PhenomenonSchema, PhenomenonParam

def schema() -> PhenomenonSchema:
    return PhenomenonSchema(
        name="discord_connector_start",
        description="SAIVerseèµ·å‹•æ™‚ã«Discord Connectorã‚’é–‹å§‹ã™ã‚‹",
        parameters=[
            PhenomenonParam(name="city_id", type="string", description="èµ·å‹•ã—ãŸCity ID"),
        ],
    )

def discord_connector_start(city_id: str, **kwargs) -> dict:
    """Discord Connectorã‚’èµ·å‹•"""
    import asyncio
    from user_data.tools.discord.connector import get_or_create_connector

    connector = get_or_create_connector()
    asyncio.create_task(connector.start())

    return {"success": True, "message": f"Discord Connector started for city {city_id}"}
```

**åœæ­¢ãƒ•ã‚§ãƒãƒ¡ãƒãƒ³:**
```python
# user_data/phenomena/discord_connector_stop.py
"""Discord Connector ã®çµ‚äº†ãƒ•ã‚§ãƒãƒ¡ãƒãƒ³"""

from phenomena.defs import PhenomenonSchema, PhenomenonParam

def schema() -> PhenomenonSchema:
    return PhenomenonSchema(
        name="discord_connector_stop",
        description="SAIVerseçµ‚äº†æ™‚ã«Discord Connectorã‚’åœæ­¢ã™ã‚‹",
        parameters=[
            PhenomenonParam(name="city_id", type="string", description="çµ‚äº†ã™ã‚‹City ID"),
        ],
    )

def discord_connector_stop(city_id: str, **kwargs) -> dict:
    """Discord Connectorã‚’åœæ­¢"""
    import asyncio
    from user_data.tools.discord.connector import get_connector

    connector = get_connector()
    if connector:
        asyncio.create_task(connector.stop())
        return {"success": True, "message": f"Discord Connector stopped for city {city_id}"}
    return {"success": True, "message": "Discord Connector was not running"}
```

#### PhenomenonRuleã®ç™»éŒ²

```sql
-- èµ·å‹•ãƒ«ãƒ¼ãƒ«
INSERT INTO phenomenon_rule (TRIGGER_TYPE, PHENOMENON_NAME, ARGUMENT_MAPPING_JSON, ENABLED, PRIORITY)
VALUES ('server_start', 'discord_connector_start', '{"city_id": "$trigger.city_id"}', 1, 100);

-- åœæ­¢ãƒ«ãƒ¼ãƒ«
INSERT INTO phenomenon_rule (TRIGGER_TYPE, PHENOMENON_NAME, ARGUMENT_MAPPING_JSON, ENABLED, PRIORITY)
VALUES ('server_stop', 'discord_connector_stop', '{"city_id": "$trigger.city_id"}', 1, 100);
```

#### ç™ºç«ã‚·ãƒ¼ã‚±ãƒ³ã‚¹

```
SAIVerseèµ·å‹•                              SAIVerseçµ‚äº†
    â”‚                                         â”‚
    â–¼                                         â–¼
SAIVerseManager.start()               SAIVerseManager.shutdown()
    â”‚                                         â”‚
    â–¼                                         â–¼
_emit_trigger(SERVER_START)           _emit_trigger(SERVER_STOP)
    â”‚                                         â”‚
    â–¼                                         â–¼
PhenomenonManager.emit()              PhenomenonManager.emit()
    â”‚                                         â”‚
    â–¼                                         â–¼
discord_connector_start()             discord_connector_stop()
    â”‚                                         â”‚
    â–¼                                         â–¼
Discord WebSocketæ¥ç¶šé–‹å§‹              Discord WebSocketæ¥ç¶šçµ‚äº†
```

#### ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã‚¢ã‚¯ã‚»ã‚¹

```python
# user_data/tools/discord/connector/__init__.py

_connector_instance: DiscordConnector | None = None

def get_or_create_connector() -> DiscordConnector:
    """ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å–å¾—ï¼ˆãªã‘ã‚Œã°ä½œæˆï¼‰"""
    global _connector_instance
    if _connector_instance is None:
        from .config import load_settings
        settings = load_settings()
        _connector_instance = DiscordConnector(settings=settings)
    return _connector_instance

def get_connector() -> DiscordConnector | None:
    """æ—¢å­˜ã®ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å–å¾—"""
    return _connector_instance
```

### 7.2. DiscordConnector ã‚¯ãƒ©ã‚¹ï¼ˆä¸­å¤®ãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒãƒ¼æ–¹å¼ï¼‰

**æ³¨æ„**: æœ¬ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯ä¸­å¤®ãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒãƒ¼æ–¹å¼ã«å¯¾å¿œã—ãŸå®Ÿè£…ã§ã™ã€‚ãƒ­ãƒ¼ã‚«ãƒ«SAIVerseã¯Discord Gatewayã«ç›´æ¥æ¥ç¶šã›ãšã€ãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒãƒ¼ã¸ã®WebSocketæ¥ç¶šã‚’é€šã˜ã¦Discordã¨é€šä¿¡ã—ã¾ã™ã€‚

```python
from dataclasses import dataclass
from typing import Optional, Callable, Any
import asyncio
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class RelayMessage:
    """ãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å—ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ã™"""
    op: int                      # ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰
    data: dict | None            # ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰
    sequence: int | None = None  # ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·
    event_type: str | None = None  # ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—


class DiscordConnector:
    """SAIVerseã¨Discordã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸã‚’ç®¡ç†ï¼ˆä¸­å¤®ãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒãƒ¼æ–¹å¼ï¼‰

    ãƒ­ãƒ¼ã‚«ãƒ«SAIVerseã¯ãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒãƒ¼ã¸WebSocketæ¥ç¶šã—ã€
    ãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§Discordã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€å—ä¿¡ã™ã‚‹ã€‚
    """

    def __init__(self, settings: DiscordConnectorSettings):
        self.settings = settings
        self._relay_client: RelayClient | None = None
        self._mapping: ChannelMapping = ChannelMapping()
        self._sync_state: SyncState = SyncState()
        self._manager: SAIVerseManager | None = None  # é…å»¶å–å¾—
        self._last_sequence: int | None = None  # RESUMEç”¨ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·
        self._session_id: str | None = None      # RESUMEç”¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ID

    @property
    def manager(self) -> SAIVerseManager:
        """SAIVerseManagerã‚’é…å»¶å–å¾—"""
        if self._manager is None:
            from tools.context import get_saiverse_manager
            self._manager = get_saiverse_manager()
        return self._manager

    async def start(self) -> None:
        """SAIVerseèµ·å‹•æ™‚ã«å‘¼ã³å‡ºã— - ãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒãƒ¼ã¸æ¥ç¶šã‚’é–‹å§‹"""
        self._relay_client = RelayClient(
            server_url=self.settings.relay_server_url,
            session_token=self.settings.session_token,
            on_message=self._handle_relay_message,
            on_connect=self._handle_connect,
            on_disconnect=self._handle_disconnect,
        )
        await self._relay_client.connect()

    async def stop(self) -> None:
        """SAIVerseåœæ­¢æ™‚ã«å‘¼ã³å‡ºã— - ãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰åˆ‡æ–­"""
        if self._relay_client:
            await self._relay_client.close()
            self._relay_client = None

    async def _handle_connect(self) -> None:
        """æ¥ç¶šæˆåŠŸæ™‚ã®å‡¦ç†"""
        logger.info("Connected to relay server")

        # RESUMEå¯èƒ½ãªã‚‰RESUMEã€ãã†ã§ãªã‘ã‚Œã°IDENTIFY
        if self._session_id and self._last_sequence is not None:
            await self._send_resume()
        else:
            await self._send_identify()

    async def _handle_disconnect(self, reason: str) -> None:
        """åˆ‡æ–­æ™‚ã®å‡¦ç†"""
        logger.warning("Disconnected from relay server: %s", reason)
        # å†æ¥ç¶šã¯RelayClientãŒå‡¦ç†

    async def _handle_relay_message(self, raw_message: str) -> None:
        """ãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡¦ç†"""
        try:
            data = json.loads(raw_message)
            message = RelayMessage(
                op=data.get("op"),
                data=data.get("d"),
                sequence=data.get("s"),
                event_type=data.get("t"),
            )

            # ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·ã‚’è¨˜éŒ²ï¼ˆRESUMEç”¨ï¼‰
            if message.sequence is not None:
                self._last_sequence = message.sequence

            await self._dispatch_message(message)

        except json.JSONDecodeError as e:
            logger.error("Invalid JSON from relay server: %s", e)

    async def _dispatch_message(self, message: RelayMessage) -> None:
        """ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã«å¿œã˜ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŒ¯ã‚Šåˆ†ã‘"""
        handlers = {
            0: self._handle_dispatch,      # DISPATCH (ã‚¤ãƒ™ãƒ³ãƒˆ)
            10: self._handle_hello,        # HELLO
            11: self._handle_heartbeat_ack,  # HEARTBEAT_ACK
            7: self._handle_reconnect,     # RECONNECT
            9: self._handle_invalid_session,  # INVALID_SESSION
        }

        handler = handlers.get(message.op)
        if handler:
            await handler(message)
        else:
            logger.debug("Unknown opcode: %d", message.op)

    async def _handle_hello(self, message: RelayMessage) -> None:
        """HELLO: Heartbeaté–“éš”ã‚’å—ã‘å–ã‚Šã€Heartbeatã‚’é–‹å§‹"""
        heartbeat_interval = message.data.get("heartbeat_interval", 30000)
        self._relay_client.start_heartbeat(heartbeat_interval)
        logger.info("Received HELLO, heartbeat interval: %dms", heartbeat_interval)

    async def _handle_dispatch(self, message: RelayMessage) -> None:
        """DISPATCH: ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†"""
        event_type = message.event_type
        data = message.data

        if event_type == "READY":
            await self._handle_ready(data)
        elif event_type == "MESSAGE_CREATE":
            await self._handle_message_create(data)
        elif event_type == "VISIT_REQUEST":
            await self._handle_visit_request(data)
        elif event_type == "VISIT_ACCEPTED":
            await self._handle_visit_accepted(data)
        elif event_type == "TURN_REQUEST":
            await self._handle_turn_request(data)
        elif event_type == "FORCED_RETURN":
            await self._handle_forced_return(data)
        elif event_type == "HOST_OFFLINE":
            await self._handle_host_offline(data)
        else:
            logger.debug("Unhandled event type: %s", event_type)

    async def _handle_ready(self, data: dict) -> None:
        """READY: æ¥ç¶šæº–å‚™å®Œäº†"""
        self._session_id = data.get("session_id")
        logger.info("Discord Connector ready - session_id: %s", self._session_id)
        await self._sync_existing_messages()

    async def _handle_message_create(self, data: dict) -> None:
        """MESSAGE_CREATE: Discordãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡"""
        channel_id = data.get("channel_id")
        building_id = self._mapping.get_building_id(int(channel_id))
        if not building_id:
            return

        # ãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒãƒ¼å½¢å¼ â†’ SAIVerseå½¢å¼ã«å¤‰æ›
        message_source = self._parse_message_source(data)

        # Buildingå±¥æ­´ã«è¨˜éŒ²
        await self._record_to_building_history(message_source, channel_id, data.get("message_id"))

        # SAIMemoryã«è¨˜éŒ²
        await self._record_to_persona_memory(message_source, channel_id, data.get("message_id"))

        # ãƒšãƒ«ã‚½ãƒŠã®å¿œç­”ã‚’ãƒˆãƒªã‚¬ãƒ¼
        if message_source.type in ("user", "persona") and message_source.role != "persona_local":
            await self._trigger_persona_response(message_source, channel_id)

    def _parse_message_source(self, data: dict) -> MessageSource:
        """ãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ã‚’MessageSourceã«å¤‰æ›"""
        author = data.get("author", {})
        author_type = author.get("type", "user")

        # è‡ªåˆ†ã®ãƒšãƒ«ã‚½ãƒŠã®ç™ºè¨€ã‹ãƒã‚§ãƒƒã‚¯
        if author_type == "persona":
            persona_id = author.get("id")
            if persona_id in self.manager.all_personas:
                local_persona = self.manager.all_personas.get(persona_id)
                if local_persona and not getattr(local_persona, "is_proxy", False):
                    return MessageSource(
                        type="echo",
                        role="persona_local",
                        content=data.get("content", ""),
                        persona_id=persona_id,
                    )

        return MessageSource(
            type=author_type,
            role="user" if author_type == "user" else "persona_remote",
            content=data.get("content", ""),
            author_id=author.get("id"),
            author_name=author.get("name"),
            persona_id=author.get("id") if author_type == "persona" else None,
        )

    async def _send_identify(self) -> None:
        """IDENTIFYãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡"""
        public_cities = self._build_public_city_info()
        await self._relay_client.send({
            "op": 2,  # IDENTIFY
            "d": {
                "public_cities": public_cities,
            },
        })

    async def _send_resume(self) -> None:
        """RESUMEãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ï¼ˆå†æ¥ç¶šæ™‚ï¼‰"""
        await self._relay_client.send({
            "op": 3,  # RESUME
            "d": {
                "session_id": self._session_id,
                "seq": self._last_sequence,
            },
        })

    async def _handle_reconnect(self, message: RelayMessage) -> None:
        """RECONNECT: ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å†æ¥ç¶šè¦æ±‚"""
        logger.info("Received RECONNECT request from server")
        await self._relay_client.reconnect()

    async def _handle_invalid_session(self, message: RelayMessage) -> None:
        """INVALID_SESSION: ã‚»ãƒƒã‚·ãƒ§ãƒ³ç„¡åŠ¹ã€å†IDENTIFYãŒå¿…è¦"""
        resumable = message.data if isinstance(message.data, bool) else False
        logger.warning("Session invalidated, resumable: %s", resumable)

        self._session_id = None
        self._last_sequence = None

        if resumable:
            await asyncio.sleep(1)  # å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†æ¥ç¶š
            await self._relay_client.reconnect()
        else:
            # æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹
            await self._send_identify()

    async def send_message(
        self,
        building_id: str,
        content: str,
        persona_id: str,
        persona_name: str,
        persona_avatar_url: str | None = None,
    ) -> dict:
        """ãƒšãƒ«ã‚½ãƒŠã‹ã‚‰Discordã¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ï¼ˆãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒãƒ¼çµŒç”±ï¼‰"""
        channel_id = self._mapping.get_channel_id(building_id)
        if not channel_id:
            return {"success": False, "error": "Building not mapped to Discord"}

        city_id = self._mapping.get_city_id(building_id)

        await self._relay_client.send({
            "op": 0,  # DISPATCH
            "t": "SEND_MESSAGE",
            "d": {
                "channel_id": str(channel_id),
                "persona_id": persona_id,
                "persona_name": persona_name,
                "persona_avatar_url": persona_avatar_url,
                "content": content,
                "city_id": city_id,
            },
        })

        return {"success": True}
```

### 7.3. RelayClient ã‚¯ãƒ©ã‚¹ï¼ˆWebSocketæ¥ç¶šç®¡ç†ï¼‰

ãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒãƒ¼ã¸ã®WebSocketæ¥ç¶šã‚’ç®¡ç†ã™ã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¯ãƒ©ã‚¹ã€‚å†æ¥ç¶šãƒ­ã‚¸ãƒƒã‚¯ã€Heartbeatç®¡ç†ã€JWTèªè¨¼ã‚’æ‹…å½“ã™ã‚‹ã€‚

```python
import asyncio
import json
import logging
import random
from datetime import datetime, timezone
from typing import Callable, Optional
import websockets
from websockets.exceptions import ConnectionClosed

logger = logging.getLogger(__name__)


class RelayClient:
    """ãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒãƒ¼ã¸ã®WebSocketæ¥ç¶šã‚’ç®¡ç†

    - JWTèªè¨¼ä»˜ãWebSocketæ¥ç¶š
    - è‡ªå‹•å†æ¥ç¶šï¼ˆæŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼‰
    - Heartbeatç®¡ç†
    - RESUMEå¯¾å¿œï¼ˆã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·è¿½è·¡ï¼‰
    """

    def __init__(
        self,
        server_url: str,
        session_token: str,
        on_message: Callable[[str], None],
        on_connect: Callable[[], None],
        on_disconnect: Callable[[str], None],
    ):
        self.server_url = server_url
        self.session_token = session_token
        self._on_message = on_message
        self._on_connect = on_connect
        self._on_disconnect = on_disconnect

        self._ws: websockets.WebSocketClientProtocol | None = None
        self._heartbeat_task: asyncio.Task | None = None
        self._receive_task: asyncio.Task | None = None
        self._heartbeat_interval_ms: int = 30000
        self._last_heartbeat_ack: datetime | None = None
        self._should_run: bool = False

        # å†æ¥ç¶šãƒãƒªã‚·ãƒ¼
        self._reconnect_attempt: int = 0
        self._max_reconnect_attempts: int = 10
        self._base_delay: float = 1.0
        self._max_delay: float = 60.0

    async def connect(self) -> None:
        """ãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶š"""
        self._should_run = True
        await self._connection_loop()

    async def close(self) -> None:
        """æ¥ç¶šã‚’ã‚¯ãƒ­ãƒ¼ã‚º"""
        self._should_run = False
        if self._heartbeat_task:
            self._heartbeat_task.cancel()
        if self._receive_task:
            self._receive_task.cancel()
        if self._ws:
            await self._ws.close()
            self._ws = None

    async def reconnect(self) -> None:
        """å†æ¥ç¶šã‚’å®Ÿè¡Œ"""
        if self._ws:
            await self._ws.close()
        # _connection_loop ãŒå†æ¥ç¶šã‚’å‡¦ç†

    async def send(self, data: dict) -> None:
        """ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡"""
        if self._ws and self._ws.open:
            await self._ws.send(json.dumps(data))
        else:
            logger.warning("Cannot send message: WebSocket not connected")

    def start_heartbeat(self, interval_ms: int) -> None:
        """Heartbeaté€ä¿¡ã‚’é–‹å§‹"""
        self._heartbeat_interval_ms = interval_ms
        if self._heartbeat_task:
            self._heartbeat_task.cancel()
        self._heartbeat_task = asyncio.create_task(self._heartbeat_loop())

    async def _connection_loop(self) -> None:
        """æ¥ç¶šç¶­æŒãƒ«ãƒ¼ãƒ—ï¼ˆå†æ¥ç¶šãƒ­ã‚¸ãƒƒã‚¯å«ã‚€ï¼‰"""
        while self._should_run:
            try:
                # JWTèªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ä»˜ãã§æ¥ç¶š
                headers = {"Authorization": f"Bearer {self.session_token}"}
                self._ws = await websockets.connect(
                    self.server_url,
                    extra_headers=headers,
                )

                # æ¥ç¶šæˆåŠŸ
                self._reconnect_attempt = 0
                logger.info("WebSocket connected to relay server")

                # æ¥ç¶šæˆåŠŸã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
                await self._on_connect()

                # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ãƒ«ãƒ¼ãƒ—
                await self._receive_loop()

            except websockets.exceptions.InvalidStatusCode as e:
                if e.status_code == 401:
                    # èªè¨¼ã‚¨ãƒ©ãƒ¼ - JWTãŒç„¡åŠ¹ã¾ãŸã¯æœŸé™åˆ‡ã‚Œ
                    logger.error("Authentication failed (401): JWT may be expired")
                    await self._on_disconnect("auth_error")
                    break  # å†æ¥ç¶šã—ãªã„
                elif e.status_code == 429:
                    # ãƒ¬ãƒ¼ãƒˆåˆ¶é™
                    retry_after = 60  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ60ç§’
                    logger.warning("Rate limited, waiting %d seconds", retry_after)
                    await asyncio.sleep(retry_after)
                    continue
                else:
                    logger.error("Connection failed with status %d", e.status_code)

            except ConnectionClosed as e:
                logger.warning("Connection closed: code=%s reason=%s", e.code, e.reason)

            except Exception as e:
                logger.error("Connection error: %s", e)

            # å†æ¥ç¶šåˆ¤å®š
            if not self._should_run:
                break

            delay = self._get_reconnect_delay()
            if delay is None:
                logger.error("Max reconnect attempts reached")
                await self._on_disconnect("max_retries")
                break

            logger.info("Reconnecting in %.1f seconds... (attempt %d/%d)",
                       delay, self._reconnect_attempt, self._max_reconnect_attempts)
            await asyncio.sleep(delay)

    async def _receive_loop(self) -> None:
        """ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ãƒ«ãƒ¼ãƒ—"""
        try:
            async for message in self._ws:
                await self._on_message(message)
        except ConnectionClosed:
            pass  # æ¥ç¶šã‚¯ãƒ­ãƒ¼ã‚ºã¯ _connection_loop ã§å‡¦ç†

    async def _heartbeat_loop(self) -> None:
        """Heartbeaté€ä¿¡ãƒ«ãƒ¼ãƒ—"""
        while self._should_run and self._ws and self._ws.open:
            await asyncio.sleep(self._heartbeat_interval_ms / 1000)

            # Heartbeat ACKã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒã‚§ãƒƒã‚¯
            if self._last_heartbeat_ack:
                elapsed = (datetime.now(timezone.utc) - self._last_heartbeat_ack).total_seconds()
                if elapsed > (self._heartbeat_interval_ms / 1000) * 2:
                    logger.warning("Heartbeat ACK timeout, closing connection")
                    await self._ws.close()
                    break

            # Heartbeaté€ä¿¡
            await self.send({"op": 1, "d": None})  # HEARTBEAT
            logger.debug("Sent heartbeat")

    def record_heartbeat_ack(self) -> None:
        """Heartbeat ACKå—ä¿¡ã‚’è¨˜éŒ²"""
        self._last_heartbeat_ack = datetime.now(timezone.utc)

    def _get_reconnect_delay(self) -> float | None:
        """å†æ¥ç¶šå¾…æ©Ÿæ™‚é–“ã‚’è¨ˆç®—ï¼ˆæŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ• + ã‚¸ãƒƒã‚¿ãƒ¼ï¼‰"""
        if self._reconnect_attempt >= self._max_reconnect_attempts:
            return None

        delay = min(
            self._base_delay * (2 ** self._reconnect_attempt),
            self._max_delay,
        )

        # ã‚¸ãƒƒã‚¿ãƒ¼ï¼ˆÂ±30%ï¼‰
        jitter = delay * 0.3 * (random.random() * 2 - 1)
        delay += jitter

        self._reconnect_attempt += 1
        return max(delay, 0.1)
```

### 7.4. ãƒãƒƒãƒ”ãƒ³ã‚°è¨­å®š

```json
// ~/.saiverse/discord_connector/mapping.json
{
  "guilds": {
    "1234567890123456789": {
      "name": "SAIVerse Web",
      "cities": {
        "9876543210987654321": {
          "city_id": "public_city_alice",
          "city_name": "Alice's Public City",
          "owner_discord_id": "1111111111111111111",
          "buildings": {
            "2222222222222222222": {
              "building_id": "cafe",
              "building_name": "ã‚«ãƒ•ã‚§"
            },
            "3333333333333333333": {
              "building_id": "park",
              "building_name": "å…¬åœ’"
            }
          }
        }
      }
    }
  }
}
```

### 7.5. ç‹¬ç«‹ã—ãŸGradio UI

SAIVerseæœ¬ä½“ï¼ˆ`main.py`ï¼‰ã¨ã¯ç‹¬ç«‹ã—ãŸGradio UIã‚’æä¾›ã—ã€Discord Connectorå°‚ç”¨ã®ç®¡ç†ç”»é¢ã‚’å®Ÿç¾ã—ã¾ã™ã€‚

#### 7.5.1. UIã‚¹ã‚¯ãƒªãƒ—ãƒˆæ§‹æˆ

UIã¯`user_data/tools/discord/ui/`é…ä¸‹ã«é…ç½®ï¼š

```
user_data/tools/discord/ui/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ app.py                    # ãƒ¡ã‚¤ãƒ³UIèµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ setup_wizard.py       # Setupã‚¿ãƒ–ï¼ˆåˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ï¼‰
â”‚   â”œâ”€â”€ connection_panel.py   # Connectionã‚¿ãƒ–ï¼ˆæ¥ç¶šçŠ¶æ…‹ç®¡ç†ï¼‰
â”‚   â”œâ”€â”€ mapping_editor.py     # Mappingã‚¿ãƒ–ï¼ˆãƒãƒƒãƒ”ãƒ³ã‚°è¨­å®šç·¨é›†ï¼‰
â”‚   â”œâ”€â”€ access_control.py     # Accessã‚¿ãƒ–ï¼ˆã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ï¼‰
â”‚   â”œâ”€â”€ visit_monitor.py      # Visitsã‚¿ãƒ–ï¼ˆè¨ªå•çŠ¶æ…‹ãƒ¢ãƒ‹ã‚¿ï¼‰
â”‚   â”œâ”€â”€ log_viewer.py         # Sync Logã‚¿ãƒ–ï¼ˆåŒæœŸãƒ­ã‚°ãƒ“ãƒ¥ãƒ¼ã‚¢ï¼‰
â”‚   â””â”€â”€ settings_panel.py     # Settingsã‚¿ãƒ–ï¼ˆè©³ç´°è¨­å®šï¼‰
â””â”€â”€ styles.py                 # CSSå®šç¾©
```

#### 7.5.2. èµ·å‹•æ–¹æ³•

```bash
# Discord Connector UIã®ã¿ã‚’èµ·å‹•ï¼ˆSAIVerseæœ¬ä½“ã¨ã¯ç‹¬ç«‹ï¼‰
python -m user_data.tools.discord.ui.app

# ãƒãƒ¼ãƒˆæŒ‡å®š
python -m user_data.tools.discord.ui.app --port 8100

# SAIVerseæœ¬ä½“ã¨åŒæ™‚èµ·å‹•ã™ã‚‹å ´åˆ
# ã‚¿ãƒ¼ãƒŸãƒŠãƒ«1: python main.py city_a
# ã‚¿ãƒ¼ãƒŸãƒŠãƒ«2: python -m user_data.tools.discord.ui.app
```

#### 7.5.3. UIã‚¿ãƒ–æ§‹æˆ

| ã‚¿ãƒ– | æ©Ÿèƒ½ | ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ |
|------|------|-------------------|
| **Setup** | åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ | Discord OAuth2ãƒ­ã‚°ã‚¤ãƒ³ã€Botæ‹›å¾… |
| **Connection** | æ¥ç¶šçŠ¶æ…‹ç®¡ç† | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã€å†æ¥ç¶š/åˆ‡æ–­ã€æ¥ç¶šå±¥æ­´ |
| **Mapping** | ãƒãƒƒãƒ”ãƒ³ã‚°è¨­å®šç·¨é›† | City/Building âŸ· Channel/Threadå¯¾å¿œä»˜ã‘ |
| **Access** | ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ | è¨±å¯/æ‹’å¦ãƒªã‚¹ãƒˆã€ãƒ¢ãƒ¼ãƒ‰è¨­å®š |
| **Visits** | è¨ªå•çŠ¶æ…‹ãƒ¢ãƒ‹ã‚¿ | ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªè¨ªå•ä¸€è¦§ã€å¼·åˆ¶é€é‚„ãƒœã‚¿ãƒ³ |
| **Sync Log** | åŒæœŸãƒ­ã‚°ãƒ“ãƒ¥ãƒ¼ã‚¢ | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°è¡¨ç¤ºã€ã‚¨ãƒ©ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ |
| **Settings** | è©³ç´°è¨­å®š | ãƒˆãƒ¼ã‚¯ãƒ³å¤‰æ›´ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€ãƒ‡ãƒ¼ã‚¿ç®¡ç† |

#### 7.5.4. Setupã‚¿ãƒ–ï¼ˆåˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ - ä¸­å¤®ãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒãƒ¼æ–¹å¼ï¼‰

Discord OAuth2èªè¨¼ã¨Botæ‹›å¾…ã‚’2ã‚¹ãƒ†ãƒƒãƒ—ã§ã‚¬ã‚¤ãƒ‰ã™ã‚‹ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰å½¢å¼UIã€‚

**ã‚¹ãƒ†ãƒƒãƒ—1: Discord OAuth2ãƒ­ã‚°ã‚¤ãƒ³**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“‹ Discordé€£æºã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ã‚¹ãƒ†ãƒƒãƒ— 1/2: Discordã§ãƒ­ã‚°ã‚¤ãƒ³                                  â”‚
â”‚                                                                 â”‚
â”‚  SAIVerseãŒDiscordã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã‚’è¨±å¯ã—ã¾ã™ã€‚  â”‚
â”‚                                                                 â”‚
â”‚  å–å¾—ã™ã‚‹æƒ…å ±:                                                    â”‚
â”‚  ãƒ»Discord User IDã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å                                   â”‚
â”‚  ãƒ»å‚åŠ ã‚µãƒ¼ãƒãƒ¼ä¸€è¦§ï¼ˆè¨ªå•å…ˆé¸æŠç”¨ï¼‰                               â”‚
â”‚                                                                 â”‚
â”‚  âš ï¸ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®èª­ã¿æ›¸ãã¯SAIVerse Botã‚’é€šã˜ã¦è¡Œã„ã¾ã™ã€‚           â”‚
â”‚     ã‚ãªãŸã®å€‹äººçš„ãªDMã‚„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯èª­ã¿å–ã‚Šã¾ã›ã‚“ã€‚              â”‚
â”‚                                                                 â”‚
â”‚                     [ğŸ”— Discordã§ãƒ­ã‚°ã‚¤ãƒ³]                        â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ã‚¹ãƒ†ãƒƒãƒ—2: SAIVerse Botã‚’ã‚µãƒ¼ãƒãƒ¼ã«æ‹›å¾…**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ã‚¹ãƒ†ãƒƒãƒ— 2/2: SAIVerse Botã‚’ã‚µãƒ¼ãƒãƒ¼ã«æ‹›å¾…                       â”‚
â”‚                                                                 â”‚
â”‚  âœ… Discordãƒ­ã‚°ã‚¤ãƒ³å®Œäº†: Alice#1234                              â”‚
â”‚                                                                 â”‚
â”‚  Public Cityã‚’å…¬é–‹ã™ã‚‹ã«ã¯ã€SAIVerse Botã‚’                       â”‚
â”‚  Discordã‚µãƒ¼ãƒãƒ¼ã«æ‹›å¾…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚                        â”‚
â”‚                                                                 â”‚
â”‚  [ğŸ¤– SAIVerse Botã‚’æ‹›å¾…]                                         â”‚
â”‚                                                                 â”‚
â”‚  å‚åŠ ã‚µãƒ¼ãƒãƒ¼ä¸€è¦§:                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ã‚µãƒ¼ãƒãƒ¼å          â”‚ Botã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ â”‚ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³          â”‚   â”‚
â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   â”‚
â”‚  â”‚ SAIVerse Community  â”‚ âœ… å‚åŠ æ¸ˆã¿   â”‚ [Public Cityè¨­å®š]  â”‚   â”‚
â”‚  â”‚ ç§ã®ã‚µãƒ¼ãƒãƒ¼         â”‚ âŒ æœªå‚åŠ     â”‚ [Botã‚’æ‹›å¾…]        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  ğŸ‰ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ï¼                                           â”‚
â”‚     Public Cityã®è¨­å®šã¯Mappingã‚¿ãƒ–ã§è¡Œãˆã¾ã™ã€‚                   â”‚
â”‚                                      [ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Œäº†ã™ã‚‹]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**èªè¨¼çŠ¶æ…‹ã®è¡¨ç¤º:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  èªè¨¼æƒ…å ±                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Discordã‚¢ã‚«ã‚¦ãƒ³ãƒˆ: Alice#1234                           â”‚   â”‚
â”‚  â”‚ Discord ID:       123456789012345678                   â”‚   â”‚
â”‚  â”‚ ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹æœŸé™: 2025-02-09 (æ®‹ã‚Š30æ—¥)                â”‚   â”‚
â”‚  â”‚ å‚åŠ ã‚µãƒ¼ãƒãƒ¼æ•°:    3                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  [ğŸ”„ ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°] [ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ]                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 7.5.5. Connectionã‚¿ãƒ–ï¼ˆæ¥ç¶šçŠ¶æ…‹ç®¡ç†ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”Œ ãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šçŠ¶æ…‹                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ğŸŸ¢ æ¥ç¶šä¸­ (READY)                                   â”‚
â”‚                                                                 â”‚
â”‚  æ¥ç¶šæƒ…å ±:                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒãƒ¼: wss://relay.saiverse.example.com       â”‚   â”‚
â”‚  â”‚ ã‚»ãƒƒã‚·ãƒ§ãƒ³ID:   abc123-def456-ghi789                   â”‚   â”‚
â”‚  â”‚ æ¥ç¶šé–‹å§‹:       2025-01-10 14:30:00                    â”‚   â”‚
â”‚  â”‚ ç¨¼åƒæ™‚é–“:       2æ™‚é–“ 15åˆ†                              â”‚   â”‚
â”‚  â”‚ ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·: 1234                                    â”‚   â”‚
â”‚  â”‚ Heartbeat:      30ç§’ (æœ€çµ‚ACK: 5ç§’å‰)                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  Public Cityå…¬é–‹çŠ¶æ³:                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Cityå              â”‚ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ â”‚ è¨ªå•è€…æ•° â”‚ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ â”‚   â”‚
â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   â”‚
â”‚  â”‚ public_city_alice   â”‚ ğŸŸ¢ å…¬é–‹ä¸­  â”‚    2    â”‚ [éå…¬é–‹]   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:  [ğŸ”„ å†æ¥ç¶š] [â¹ åˆ‡æ–­] [ğŸ“Š è©³ç´°ãƒ­ã‚°]                 â”‚
â”‚                                                                 â”‚
â”‚  æ¥ç¶šå±¥æ­´ï¼ˆç›´è¿‘10ä»¶ï¼‰:                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ æ™‚åˆ»              â”‚ ã‚¤ãƒ™ãƒ³ãƒˆ   â”‚ è©³ç´°                    â”‚   â”‚
â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   â”‚
â”‚  â”‚ 2025-01-10 14:30  â”‚ READY     â”‚ ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºç«‹          â”‚   â”‚
â”‚  â”‚ 2025-01-10 14:30  â”‚ IDENTIFY  â”‚ Public Cityç™»éŒ²         â”‚   â”‚
â”‚  â”‚ 2025-01-10 14:30  â”‚ HELLO     â”‚ Heartbeaté–‹å§‹           â”‚   â”‚
â”‚  â”‚ 2025-01-10 12:15  â”‚ RESUMED   â”‚ å†æ¥ç¶šæˆåŠŸ (12 events)  â”‚   â”‚
â”‚  â”‚ 2025-01-10 12:14  â”‚ disconnectâ”‚ WebSocketåˆ‡æ–­           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 7.5.6. Accessã‚¿ãƒ–ï¼ˆã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ›¡ï¸ ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Public City: [public_city_alice      â–¼]                        â”‚
â”‚                                                                 â”‚
â”‚  ãƒ¢ãƒ¼ãƒ‰: â—‹ è¨±å¯ãƒªã‚¹ãƒˆï¼ˆãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆï¼‰  â† æ¨å¥¨                  â”‚
â”‚         â—‹ æ‹’å¦ãƒªã‚¹ãƒˆï¼ˆãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼‰                           â”‚
â”‚         â—‹ å…¨å“¡è¨±å¯ï¼ˆç½²åæ¤œè¨¼ã®ã¿ï¼‰                               â”‚
â”‚                                                                 â”‚
â”‚  è¨±å¯ãƒªã‚¹ãƒˆ:                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ç¨®åˆ¥     â”‚ ID                    â”‚ åå‰        â”‚ æ“ä½œ   â”‚   â”‚
â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”‚   â”‚
â”‚  â”‚ ãƒšãƒ«ã‚½ãƒŠ â”‚ bob_persona           â”‚ Bob        â”‚ [ğŸ—‘]  â”‚   â”‚
â”‚  â”‚ ãƒšãƒ«ã‚½ãƒŠ â”‚ charlie_persona       â”‚ Charlie    â”‚ [ğŸ—‘]  â”‚   â”‚
â”‚  â”‚ ãƒ¦ãƒ¼ã‚¶ãƒ¼ â”‚ 123456789012345678    â”‚ Alice#1234 â”‚ [ğŸ—‘]  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  è¿½åŠ : ç¨®åˆ¥ [ãƒšãƒ«ã‚½ãƒŠ â–¼]  ID [              ] [â• è¿½åŠ ]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 7.5.7. Settingsã‚¿ãƒ–ï¼ˆè©³ç´°è¨­å®šï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš™ï¸ è¨­å®š                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ”‘ èªè¨¼è¨­å®š                                                     â”‚
â”‚  Bot Token:                                                      â”‚
â”‚  [â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢] [ğŸ‘ è¡¨ç¤º] [ğŸ“ å¤‰æ›´]      â”‚
â”‚                                                                 â”‚
â”‚  å…±æœ‰ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆï¼ˆãƒšãƒ«ã‚½ãƒŠç½²åç”¨ï¼‰:                              â”‚
â”‚  [â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢] [ğŸ‘ è¡¨ç¤º] [ğŸ”„ å†ç”Ÿæˆ] [ğŸ“‹ ã‚³ãƒ”ãƒ¼]          â”‚
â”‚  âš ï¸ å†ç”Ÿæˆã™ã‚‹ã¨ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®é€£æºãŒåˆ‡ã‚Œã¾ã™                      â”‚
â”‚                                                                 â”‚
â”‚  ğŸ“¡ æ¥ç¶šè¨­å®š                                                     â”‚
â”‚  è‡ªå‹•æ¥ç¶š:        [âœ… æœ‰åŠ¹]                                      â”‚
â”‚  å†æ¥ç¶šãƒªãƒˆãƒ©ã‚¤:   [5   ] å›ã¾ã§                                 â”‚
â”‚  ãƒªãƒˆãƒ©ã‚¤é–“éš”:     [30  ] ç§’                                     â”‚
â”‚                                                                 â”‚
â”‚  ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š                                             â”‚
â”‚  ç½²åæ¤œè¨¼:        [âœ… æœ‰åŠ¹]                                      â”‚
â”‚  ãƒ¬ãƒ¼ãƒˆåˆ¶é™:      [âœ… æœ‰åŠ¹]                                      â”‚
â”‚  ã‚¹ãƒ‘ãƒ æ¤œçŸ¥:      [âœ… æœ‰åŠ¹]                                      â”‚
â”‚                                                                 â”‚
â”‚  ğŸ“ ãƒ‡ãƒ¼ã‚¿è¨­å®š                                                   â”‚
â”‚  ãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: ~/.saiverse/discord_connector/              â”‚
â”‚  DBãƒ•ã‚¡ã‚¤ãƒ«:        connector.db (1.2 MB)                        â”‚
â”‚  [ğŸ“‚ ãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ã] [ğŸ—‘ ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ]                        â”‚
â”‚                                                                 â”‚
â”‚                                      [ğŸ’¾ è¨­å®šã‚’ä¿å­˜] [â†© ãƒªã‚»ãƒƒãƒˆ]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 7.5.8. ãƒ¡ã‚¤ãƒ³UIã®å®Ÿè£…ã‚¤ãƒ¡ãƒ¼ã‚¸

```python
# user_data/tools/discord/ui/app.py
import argparse
import gradio as gr
from .components import (
    setup_wizard,
    connection_panel,
    mapping_editor,
    access_control,
    visit_monitor,
    log_viewer,
    settings_panel,
)


def create_app() -> gr.Blocks:
    """Discord Connector UI ã‚’æ§‹ç¯‰"""

    with gr.Blocks(title="Discord Connector", theme=gr.themes.Soft()) as app:
        gr.Markdown("# Discord Connector")

        with gr.Tabs():
            with gr.Tab("Setup"):
                setup_wizard.render()

            with gr.Tab("Connection"):
                connection_panel.render()

            with gr.Tab("Mapping"):
                mapping_editor.render()

            with gr.Tab("Access"):
                access_control.render()

            with gr.Tab("Visits"):
                visit_monitor.render()

            with gr.Tab("Sync Log"):
                log_viewer.render()

            with gr.Tab("Settings"):
                settings_panel.render()

    return app


def main():
    parser = argparse.ArgumentParser(description="Discord Connector UI")
    parser.add_argument("--port", type=int, default=8100, help="UI port")
    parser.add_argument("--share", action="store_true", help="Create public link")
    args = parser.parse_args()

    app = create_app()
    app.launch(
        server_name="0.0.0.0",
        server_port=args.port,
        share=args.share,
    )


if __name__ == "__main__":
    main()
```

#### 7.5.9. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```yaml
# ~/.saiverse/discord_connector/config.yaml

bot:
  token: "YOUR_BOT_TOKEN"  # ç’°å¢ƒå¤‰æ•° DISCORD_BOT_TOKEN ã§ã‚‚å¯
  application_id: "1234567890123456789"

connection:
  auto_connect: true
  max_retries: 5
  retry_interval_seconds: 30

security:
  shared_secret: "randomly_generated_secret"
  verify_signatures: true
  rate_limiting: true
  spam_detection: true

data:
  db_path: "~/.saiverse/discord_connector/connector.db"
```

#### 7.5.10. SAIVerseæœ¬ä½“ã¨ã®é€£æº

Discord Connector UIã¯SAIVerseæœ¬ä½“ï¼ˆmain.pyï¼‰ã¨ä»¥ä¸‹ã®æ–¹æ³•ã§é€£æºã—ã¾ã™ï¼š

| é€£æºæ–¹å¼ | ç”¨é€” |
|----------|------|
| **å…±æœ‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹** | `connector.db` ã‚’èª­ã¿æ›¸ã |
| **è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«** | `config.yaml` ã®èª­ã¿æ›¸ã |
| **ãƒ•ã‚¡ã‚¤ãƒ«ç›£è¦–** | `sync_state.json`, `mapping.json` ã®å¤‰æ›´ã‚’æ¤œçŸ¥ |

```
é€£æºã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SAIVerse/user_data/tools/             â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ discord/        â”‚     â”‚ (ãã®ä»–ãƒ„ãƒ¼ãƒ«)           â”‚   â”‚
â”‚  â”‚ (Connectoræœ¬ä½“) â”‚     â”‚                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           â–¼                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ SAIVerseæœ¬ä½“     â”‚     â”‚ Discord Connector UI   â”‚     â”‚
â”‚  â”‚ (main.py)       â”‚     â”‚ (discord.ui.app)       â”‚     â”‚
â”‚  â”‚  port 8000      â”‚     â”‚  port 8100             â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚           â”‚                       â”‚                       â”‚
â”‚           â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                       â”‚
â”‚           â””â”€â”€â–¶â”‚ connector.db  â”‚â—€â”€â”€â”˜                       â”‚
â”‚               â”‚ config.yaml   â”‚   (~/.saiverse/           â”‚
â”‚               â”‚ mapping.json  â”‚    discord_connector/)    â”‚
â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                                           â”‚
â”‚                      ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ç’°å¢ƒ                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.5. ç‹¬ç«‹ã—ãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ

SAIVerseæœ¬ä½“ã®`saiverse.db`ã¨ã¯åˆ†é›¢ã—ãŸå°‚ç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹`connector.db`ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

DBã‚¹ã‚­ãƒ¼ãƒå®šç¾©ã¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯`tools/discord/db/`é…ä¸‹ã«é…ç½®ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³7.1å‚ç…§ï¼‰ã€‚

#### 7.5.1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®é…ç½®

ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ã¯`~/.saiverse/discord_connector/`é…ä¸‹ã«ä¿å­˜ï¼š

```
~/.saiverse/
â”œâ”€â”€ discord_connector/
â”‚   â”œâ”€â”€ connector.db           # Discord Connectorå°‚ç”¨DB (SQLite)
â”‚   â”œâ”€â”€ mapping.json           # ãƒãƒƒãƒ”ãƒ³ã‚°è¨­å®šï¼ˆJSONå½¢å¼ã€å³æ™‚åæ˜ ç”¨ï¼‰
â”‚   â””â”€â”€ sync_state.json        # åŒæœŸçŠ¶æ…‹ï¼ˆJSONå½¢å¼ï¼‰
â””â”€â”€ personas/
    â””â”€â”€ {id}/
        â”œâ”€â”€ memory.db          # æ—¢å­˜ã®SAIMemoryï¼ˆå¤‰æ›´ãªã—ï¼‰
        â””â”€â”€ downloads/         # è¨ªå•æ™‚ã«å—ä¿¡ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«
```

#### 7.5.2. connector.db ã‚¹ã‚­ãƒ¼ãƒ

```sql
-- Public City å®šç¾©
CREATE TABLE public_cities (
    id TEXT PRIMARY KEY,                          -- City ID (e.g., "public_city_alice")
    name TEXT NOT NULL,                           -- è¡¨ç¤ºå
    discord_channel_id TEXT UNIQUE,               -- Discordãƒãƒ£ãƒ³ãƒãƒ« ID
    owner_discord_id TEXT NOT NULL,               -- æ‰€æœ‰è€…ã®Discord ID
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Building âŸ· Thread ãƒãƒƒãƒ”ãƒ³ã‚°
CREATE TABLE building_mappings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    city_id TEXT NOT NULL REFERENCES public_cities(id) ON DELETE CASCADE,
    building_id TEXT NOT NULL,                    -- SAIVerse Building ID
    building_name TEXT NOT NULL,                  -- è¡¨ç¤ºå
    discord_thread_id TEXT UNIQUE,                -- Discordã‚¹ãƒ¬ãƒƒãƒ‰ ID
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(city_id, building_id)
);

-- è¨ªå•ã‚»ãƒƒã‚·ãƒ§ãƒ³
CREATE TABLE visit_sessions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    persona_id TEXT NOT NULL,                     -- è¨ªå•è€…ãƒšãƒ«ã‚½ãƒŠ ID
    persona_name TEXT NOT NULL,                   -- è¨ªå•è€…ãƒšãƒ«ã‚½ãƒŠå
    home_city_id TEXT NOT NULL,                   -- å…ƒå±…ãŸCity ID
    home_building_id TEXT NOT NULL,               -- å…ƒå±…ãŸBuilding ID
    visiting_city_id TEXT NOT NULL REFERENCES public_cities(id),
    visiting_building_id TEXT NOT NULL,           -- è¨ªå•å…ˆBuilding ID
    owner_discord_id TEXT NOT NULL,               -- è¨ªå•è€…ã®ã‚ªãƒ¼ãƒŠãƒ¼ Discord ID
    started_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ended_at TIMESTAMP,                           -- NULL=è¨ªå•ä¸­
    end_reason TEXT,                              -- çµ‚äº†ç†ç”± (normal/forced/error)
    messages_exchanged INTEGER DEFAULT 0          -- ã‚„ã‚Šå–ã‚Šã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°
);
CREATE INDEX idx_visit_sessions_active ON visit_sessions(persona_id, ended_at) WHERE ended_at IS NULL;

-- åŒæœŸå±¥æ­´
CREATE TABLE sync_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    channel_id TEXT NOT NULL,                     -- Discordãƒãƒ£ãƒ³ãƒãƒ«/ã‚¹ãƒ¬ãƒƒãƒ‰ ID
    last_message_id TEXT,                         -- æœ€å¾Œã«åŒæœŸã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ID
    messages_synced INTEGER DEFAULT 0,            -- åŒæœŸã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°
    synced_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    sync_type TEXT NOT NULL                       -- startup / realtime / reconnect
);
CREATE INDEX idx_sync_history_channel ON sync_history(channel_id, synced_at);

-- ãƒ•ã‚¡ã‚¤ãƒ«è»¢é€å±¥æ­´
CREATE TABLE file_transfers (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    visit_session_id INTEGER REFERENCES visit_sessions(id),
    direction TEXT NOT NULL,                      -- send / receive
    tool_name TEXT,                               -- ç”Ÿæˆå…ƒTool
    original_filename TEXT NOT NULL,
    local_path TEXT,                              -- ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜å…ˆ
    discord_message_id TEXT,                      -- Discordãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ID
    file_size_bytes INTEGER,
    compressed BOOLEAN DEFAULT FALSE,
    compression_format TEXT,
    transferred_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status TEXT DEFAULT 'pending'                 -- pending / success / failed
);
CREATE INDEX idx_file_transfers_session ON file_transfers(visit_session_id);

-- æ¥ç¶šå±¥æ­´
CREATE TABLE connection_log (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    event TEXT NOT NULL,                          -- connect / disconnect / reconnect / error
    reason TEXT,                                  -- åˆ‡æ–­/ã‚¨ãƒ©ãƒ¼ç†ç”±
    attempt_count INTEGER,                        -- å†æ¥ç¶šè©¦è¡Œå›æ•°ï¼ˆreconnectæ™‚ï¼‰
    occurred_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- é€ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ï¼ˆå—ä¿¡æ™‚ã®ãƒšãƒ«ã‚½ãƒŠè­˜åˆ¥ç”¨ï¼‰
CREATE TABLE sent_messages (
    discord_message_id TEXT PRIMARY KEY,          -- Discordãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ID
    persona_id TEXT NOT NULL,                     -- é€ä¿¡å…ƒãƒšãƒ«ã‚½ãƒŠID
    city_id TEXT NOT NULL,                        -- é€ä¿¡å…ƒCity ID
    building_id TEXT NOT NULL,                    -- é€ä¿¡å…ƒBuilding ID
    sent_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX idx_sent_messages_persona ON sent_messages(persona_id, sent_at);
```

#### 7.5.3. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†

```python
# tools/discord/db/migrate.py
from pathlib import Path
import sqlite3

SCHEMA_VERSION = 1

MIGRATIONS = {
    1: """
        -- Initial schema
        CREATE TABLE public_cities ( ... );
        CREATE TABLE building_mappings ( ... );
        CREATE TABLE visit_sessions ( ... );
        ...
    """,
    # 2: "ALTER TABLE ...",  # å°†æ¥ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
}


def get_db_path() -> Path:
    return Path.home() / ".saiverse" / "discord_connector" / "connector.db"


def migrate(db_path: Path | None = None) -> None:
    """ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ"""
    db_path = db_path or get_db_path()
    db_path.parent.mkdir(parents=True, exist_ok=True)

    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()

    # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS schema_version (
            version INTEGER PRIMARY KEY
        )
    """)

    # ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³å–å¾—
    cursor.execute("SELECT MAX(version) FROM schema_version")
    current = cursor.fetchone()[0] or 0

    # é©ç”¨ãŒå¿…è¦ãªãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
    for version in range(current + 1, SCHEMA_VERSION + 1):
        if version in MIGRATIONS:
            cursor.executescript(MIGRATIONS[version])
            cursor.execute("INSERT INTO schema_version (version) VALUES (?)", (version,))
            print(f"Applied migration v{version}")

    conn.commit()
    conn.close()
```

#### 7.5.4. SAIVerseæœ¬ä½“DBã¨ã®é–¢ä¿‚

| ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ | æ ¼ç´ãƒ‡ãƒ¼ã‚¿ | ç®¡ç†å¯¾è±¡ |
|--------------|-----------|----------|
| `saiverse.db` | City, Building, AI, User, Tool, Playbook ç­‰ | SAIVerseæœ¬ä½“ |
| `connector.db` | Discordé€£æºæƒ…å ±ã€è¨ªå•ã‚»ãƒƒã‚·ãƒ§ãƒ³ã€åŒæœŸçŠ¶æ…‹ | Discord Connector |
| `memory.db` (å„ãƒšãƒ«ã‚½ãƒŠ) | SAIMemory ãƒ­ã‚° | ãƒšãƒ«ã‚½ãƒŠå€‹åˆ¥ |

**é€£æºæ™‚ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼:**
```
saiverse.db ã® City/Building
        â”‚
        â–¼ å‚ç…§ (read-only)
connector.db ã§ Discord ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ç®¡ç†
        â”‚
        â–¼ è¨ªå•ã‚¤ãƒ™ãƒ³ãƒˆ
saiverse.db ã® OccupancyManager ã«é€šçŸ¥
        â”‚
        â–¼ ãƒšãƒ«ã‚½ãƒŠç§»å‹•
memory.db ã«è¨ªå•è¨˜éŒ²ã‚’è¿½è¨˜
```

---

## 8. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

### 8.0. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç¨®åˆ¥ä¸€è¦§

Discordä¸Šã§æ‰±ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ä»¥ä¸‹ã®4ç¨®é¡ã«åˆ†é¡ã•ã‚Œã¾ã™ï¼š

| ç¨®åˆ¥ | é€ä¿¡å…ƒ | Discordä¸Šã®è¡¨ç¤º | è­˜åˆ¥æ–¹æ³• | SAIVerseã§ã®æ‰±ã„ |
|------|-------|----------------|---------|-----------------|
| **ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºè¨€** | Discordãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆäººé–“ï¼‰ | é€šå¸¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ | `author.bot == False` | role=`user`ã€å¿œç­”ãƒˆãƒªã‚¬ãƒ¼ |
| **ãƒšãƒ«ã‚½ãƒŠç™ºè¨€** | ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒšãƒ«ã‚½ãƒŠ | Embedï¼ˆã‚¢ãƒã‚¿ãƒ¼+åå‰ï¼‰ | `author.bot == True` + Embed | role=`persona_remote`ã€å¿œç­”ãƒˆãƒªã‚¬ãƒ¼ |
| **è‡ªãƒšãƒ«ã‚½ãƒŠç™ºè¨€** | è‡ªåˆ†ã®ãƒšãƒ«ã‚½ãƒŠ | Embedï¼ˆã‚¢ãƒã‚¿ãƒ¼+åå‰ï¼‰ | `author.bot == True` + sent_messagesç…§åˆ | ã‚¹ã‚­ãƒƒãƒ—ï¼ˆã‚¨ã‚³ãƒ¼é˜²æ­¢ï¼‰ |
| **ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥** | Bot | Embedï¼ˆè‰²åˆ†ã‘ï¼‰ | `author.bot == True` + é€šçŸ¥è‰² | role=`system`ã€ãƒ­ã‚°ã®ã¿ |

**ãªã‚Šã™ã¾ã—é˜²æ­¢:**
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºè¨€: `author.bot == False` ã§è­˜åˆ¥ã€Discordèªè¨¼ã§ä¿è¨¼
- ãƒšãƒ«ã‚½ãƒŠç™ºè¨€: Botã®ã¿ãŒé€ä¿¡å¯èƒ½ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒEmbedã‚’é€ã£ã¦ã‚‚ `author.bot == False` ãªã®ã§åŒºåˆ¥å¯èƒ½

### 8.1. ãƒšãƒ«ã‚½ãƒŠç™ºè¨€

ãƒšãƒ«ã‚½ãƒŠã®ç™ºè¨€ã¯**Discord Embed**ã‚’ä½¿ç”¨ã—ã€ãƒšãƒ«ã‚½ãƒŠã”ã¨ã«ã‚¢ãƒã‚¿ãƒ¼ã¨åå‰ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚

#### 8.1.1. Embedæ§‹é€ 

```python
def create_persona_message_embed(
    persona_name: str,
    persona_avatar_url: str,
    content: str,
    persona_id: str,
    city_id: str,
    color: int = 0x3498db,
) -> discord.Embed:
    """ãƒšãƒ«ã‚½ãƒŠç™ºè¨€ç”¨ã®Embedã‚’ç”Ÿæˆ"""

    embed = discord.Embed(
        description=content,
        color=color,
    )
    embed.set_author(
        name=persona_name,
        icon_url=persona_avatar_url,
    )
    # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’footerã«åŸ‹ã‚è¾¼ã¿ï¼ˆå—ä¿¡å´ã§ã®è­˜åˆ¥ç”¨ï¼‰
    embed.set_footer(text=f"pid:{persona_id}|cid:{city_id}")

    return embed
```

#### 8.1.2. Discordä¸Šã®è¡¨ç¤º

```
â”Œâ”€ Embed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [ã‚¢ãƒã‚¿ãƒ¼] ãƒšãƒ«ã‚½ãƒŠA                     â”‚
â”‚                                         â”‚
â”‚ ã“ã‚“ã«ã¡ã¯ï¼ã“ã‚Œã¯ãƒšãƒ«ã‚½ãƒŠã®ç™ºè¨€ã§ã™ã€‚    â”‚
â”‚ é•·æ–‡ã‚‚å…¨æ–‡è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚æ”¹è¡Œã‚‚           â”‚
â”‚ ãã®ã¾ã¾åæ˜ ã•ã‚Œã¾ã™ã€‚                   â”‚
â”‚                                         â”‚
â”‚                    pid:persona_a|cid:... â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 8.1.3. é€ä¿¡å‡¦ç†

```python
async def send_persona_message(
    self,
    thread_id: int,
    persona: PersonaCore,
    content: str,
) -> dict:
    """ãƒšãƒ«ã‚½ãƒŠã¨ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡"""

    thread = self._client.get_channel(thread_id)
    if not thread:
        return {"success": False, "error": "Thread not found"}

    # ã‚¢ãƒã‚¿ãƒ¼URLå–å¾—ï¼ˆSAIVerseã®ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã‚’ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ï¼‰
    avatar_url = self._get_persona_avatar_url(persona)

    # Embedç”Ÿæˆ
    embed = create_persona_message_embed(
        persona_name=persona.name,
        persona_avatar_url=avatar_url,
        content=content,
        persona_id=persona.id,
        city_id=persona.city_id,
    )

    # é€ä¿¡
    message = await thread.send(embed=embed)

    # DBã«è¨˜éŒ²ï¼ˆå—ä¿¡æ™‚ã®è­˜åˆ¥ç”¨ï¼‰
    await self._db.insert_sent_message(
        discord_message_id=str(message.id),
        persona_id=persona.id,
        city_id=persona.city_id,
        building_id=persona.current_building_id,
    )

    return {"success": True, "message_id": str(message.id)}
```

### 8.2. ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥

è¨ªå•å…¥é€€å®¤ã‚„ãƒ•ã‚¡ã‚¤ãƒ«è»¢é€ãªã©ã®ã‚·ã‚¹ãƒ†ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã¯Embedï¼ˆè‰²åˆ†ã‘ï¼‰ã§é€šçŸ¥ã—ã¾ã™ã€‚

#### 8.2.1. é€šçŸ¥ç¨®åˆ¥ã¨è‰²

| ç¨®åˆ¥ | è‰²ã‚³ãƒ¼ãƒ‰ | ç”¨é€” |
|------|----------|------|
| `visit_enter` | 0x2ECC71 (ç·‘) | ãƒšãƒ«ã‚½ãƒŠãŒè¨ªå•ã‚’é–‹å§‹ |
| `visit_leave` | 0xE74C3C (èµ¤) | ãƒšãƒ«ã‚½ãƒŠãŒé€€å‡ºï¼ˆé€šå¸¸/å¼·åˆ¶é€é‚„ï¼‰ |
| `file_transfer` | 0x3498DB (é’) | ãƒ•ã‚¡ã‚¤ãƒ«è»¢é€é€šçŸ¥ |
| `system_info` | 0x95A5A6 (ã‚°ãƒ¬ãƒ¼) | ãã®ä»–ã®ã‚·ã‚¹ãƒ†ãƒ æƒ…å ± |

#### 8.2.2. é€šçŸ¥Embedæ§‹é€ 

```python
NOTIFICATION_COLORS = {
    "visit_enter": 0x2ECC71,
    "visit_leave": 0xE74C3C,
    "file_transfer": 0x3498DB,
    "system_info": 0x95A5A6,
}

NOTIFICATION_ICONS = {
    "visit_enter": "ğŸš¶",
    "visit_leave": "ğŸ‘‹",
    "file_transfer": "ğŸ“",
    "system_info": "â„¹ï¸",
}

async def send_system_notification(
    self,
    thread_id: int,
    event_type: str,
    title: str,
    description: str,
    fields: dict = None,
) -> dict:
    """ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ã‚’é€ä¿¡"""

    thread = self._client.get_channel(thread_id)
    if not thread:
        return {"success": False, "error": "Thread not found"}

    icon = NOTIFICATION_ICONS.get(event_type, "â„¹ï¸")
    color = NOTIFICATION_COLORS.get(event_type, 0x95A5A6)

    embed = discord.Embed(
        title=f"{icon} {title}",
        description=description,
        color=color,
    )

    if fields:
        for name, value in fields.items():
            embed.add_field(name=name, value=value, inline=True)

    message = await thread.send(embed=embed)
    return {"success": True, "message_id": str(message.id)}
```

#### 8.2.3. é€šçŸ¥ä¾‹

**è¨ªå•é–‹å§‹:**
```
â”Œâ”€ Embed (ç·‘) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸš¶ è¨ªå•è€…åˆ°ç€                           â”‚
â”‚                                         â”‚
â”‚ ãƒšãƒ«ã‚½ãƒŠB ãŒå…¥å®¤ã—ã¾ã—ãŸ                 â”‚
â”‚                                         â”‚
â”‚ From: Private City Bob                  â”‚
â”‚ Owner: @Bob#1234                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¼·åˆ¶é€é‚„:**
```
â”Œâ”€ Embed (èµ¤) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ‘‹ è¨ªå•è€…é€€å‡º                           â”‚
â”‚                                         â”‚
â”‚ ãƒšãƒ«ã‚½ãƒŠB ãŒé€€å‡ºã—ã¾ã—ãŸï¼ˆå¼·åˆ¶é€é‚„ï¼‰      â”‚
â”‚                                         â”‚
â”‚ ç†ç”±: Host offline                      â”‚
â”‚ æ»åœ¨æ™‚é–“: 30åˆ†                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.3. å—ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è­˜åˆ¥

Discordã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ãŸéš›ã€é€ä¿¡å…ƒã‚’è­˜åˆ¥ã™ã‚‹æ–¹æ³•ã€‚

#### 8.3.1. è­˜åˆ¥ãƒ•ãƒ­ãƒ¼

```
ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ (on_message)
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Botã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ï¼Ÿ               â”‚
â”‚    message.author.bot == True       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ No â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºè¨€ (role="user")
    â”‚ Yes
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. è‡ªåˆ†ã®Botã‹ï¼Ÿ                    â”‚
â”‚    message.author.id == bot.user.id â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ No â†’ ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®Botï¼ˆãƒšãƒ«ã‚½ãƒŠç™ºè¨€å€™è£œï¼‰
    â”‚ Yes
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. sent_messages ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç…§åˆ      â”‚
â”‚    â†’ è©²å½“ã‚ã‚Š: ã‚¨ã‚³ãƒ¼ â†’ ã‚¹ã‚­ãƒƒãƒ—     â”‚
â”‚    â†’ è©²å½“ãªã—: å‡¦ç†ç¶šè¡Œ              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Embedãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ï¼Ÿ               â”‚
â”‚    message.embeds ãŒã‚ã‚‹ã‹           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ Yes
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. footerã‹ã‚‰ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‘ãƒ¼ã‚¹      â”‚
â”‚    pid:xxx|cid:xxx å½¢å¼ã‚’è§£æ        â”‚
â”‚    â†’ ãƒšãƒ«ã‚½ãƒŠç™ºè¨€ (role="persona_remote")â”‚
â”‚    â†’ ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ (role="system")    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 8.3.2. å®Ÿè£…ã‚¤ãƒ¡ãƒ¼ã‚¸

```python
@dataclass
class MessageSource:
    """ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å…ƒã®è­˜åˆ¥çµæœ"""
    type: str              # "user", "persona", "echo", "system"
    role: str = ""         # SAIVerseã§ã®role
    content: str = ""
    author_name: str = ""
    author_id: str = ""
    persona_id: str = None
    city_id: str = None

async def _identify_message_source(self, message: discord.Message) -> MessageSource:
    """ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡å…ƒã‚’è­˜åˆ¥"""

    # 1. Botä»¥å¤–ãŒé€ä¿¡ â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºè¨€
    if not message.author.bot:
        return MessageSource(
            type="user",
            role="user",
            content=message.content,
            author_name=message.author.display_name,
            author_id=str(message.author.id),
        )

    # 2. è‡ªåˆ†ã®BotãŒé€ä¿¡ â†’ ã‚¨ã‚³ãƒ¼ãƒã‚§ãƒƒã‚¯
    if message.author.id == self._client.user.id:
        if await self._db.is_own_sent_message(str(message.id)):
            return MessageSource(type="echo")

    # 3. BotãŒé€ä¿¡ + Embedã‚ã‚Š â†’ ãƒšãƒ«ã‚½ãƒŠç™ºè¨€ã¾ãŸã¯ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥
    if message.embeds:
        embed = message.embeds[0]
        metadata = self._parse_footer_metadata(embed.footer.text if embed.footer else "")

        if metadata and metadata.get("pid"):
            return MessageSource(
                type="persona",
                role="persona_remote",
                content=embed.description or "",
                author_name=embed.author.name if embed.author else "Unknown",
                persona_id=metadata.get("pid"),
                city_id=metadata.get("cid"),
            )

        # ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ï¼ˆé€šçŸ¥è‰²Embedï¼‰
        return MessageSource(
            type="system",
            role="system",
            content=embed.description or "",
        )

    # 4. ãã®ä»–ï¼ˆEmbedãªã—ã®Botç™ºè¨€ï¼‰
    return MessageSource(
        type="system",
        role="system",
        content=message.content,
    )

async def _on_message(self, message: discord.Message) -> None:
    """ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ãƒãƒ³ãƒ‰ãƒ©"""

    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å…ƒã‚’è­˜åˆ¥
    source = await self._identify_message_source(message)

    # ã‚¨ã‚³ãƒ¼é˜²æ­¢
    if source.type == "echo":
        return

    # ãƒãƒƒãƒ”ãƒ³ã‚°ã‹ã‚‰Buildingç‰¹å®š
    building_id = self._mapping.get_building_id(message.channel.id)
    if not building_id:
        return

    # SAIVerseå½¢å¼ã«å¤‰æ›ã—ã¦ãƒ­ã‚°ã«è¿½è¨˜
    saiverse_message = {
        "role": source.role,
        "content": source.content,
        "author": source.author_name,
        "author_id": source.author_id,
        "timestamp": message.created_at.isoformat(),
        "metadata": {
            "source": "discord",
            "message_id": str(message.id),
            "channel_id": str(message.channel.id),
            "persona_id": source.persona_id,
            "city_id": source.city_id,
        }
    }

    await self._record_message(building_id, saiverse_message)

    # å¿œç­”ãƒˆãƒªã‚¬ãƒ¼ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼/ãƒšãƒ«ã‚½ãƒŠç™ºè¨€ã®å ´åˆã®ã¿ï¼‰
    if source.role in ("user", "persona_remote"):
        await self._trigger_persona_response(building_id, saiverse_message)

def _parse_footer_metadata(self, footer_text: str) -> dict | None:
    """footerã‹ã‚‰ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º"""
    # å½¢å¼: pid:persona_id|cid:city_id
    if not footer_text or "|" not in footer_text:
        return None

    result = {}
    for part in footer_text.split("|"):
        if ":" in part:
            key, value = part.split(":", 1)
            result[key.strip()] = value.strip()

    return result if "pid" in result else None
```

---

## 9. ãƒ„ãƒ¼ãƒ«ä»•æ§˜

WebSocketæ¥ç¶šã¨ã¯åˆ¥ã«ã€ãƒšãƒ«ã‚½ãƒŠãŒæ˜ç¤ºçš„ã«Discordã‚’æ“ä½œã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã‚‚æä¾›ã—ã¾ã™ã€‚

### 9.1. discord_read_thread

**ç›®çš„:** æŒ‡å®šã—ãŸDiscordã‚¹ãƒ¬ãƒƒãƒ‰/ãƒãƒ£ãƒ³ãƒãƒ«ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ã‚’å–å¾—ã™ã‚‹

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:**
```python
{
    "channel_id": str,         # å¿…é ˆ: Discord ãƒãƒ£ãƒ³ãƒãƒ«/ã‚¹ãƒ¬ãƒƒãƒ‰ID
    "limit": int,              # ä»»æ„: å–å¾—ä»¶æ•° (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 50, æœ€å¤§: 100)
    "before_message_id": str,  # ä»»æ„: ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸IDã‚ˆã‚Šå‰ã‚’å–å¾—
}
```

**æˆ»ã‚Šå€¤:**
```python
{
    "channel_name": str,
    "messages": [
        {
            "id": str,
            "author": str,
            "author_id": str,
            "content": str,
            "timestamp": str,  # ISO8601
            "attachments": [{"filename": str, "url": str}],
        },
        ...
    ],
    "has_more": bool,
}
```

### 9.2. discord_send_message

**ç›®çš„:** æŒ‡å®šã—ãŸDiscordã‚¹ãƒ¬ãƒƒãƒ‰/ãƒãƒ£ãƒ³ãƒãƒ«ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:**
```python
{
    "channel_id": str,  # å¿…é ˆ: Discord ãƒãƒ£ãƒ³ãƒãƒ«/ã‚¹ãƒ¬ãƒƒãƒ‰ID
    "content": str,     # å¿…é ˆ: é€ä¿¡ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹
    "reply_to": str,    # ä»»æ„: è¿”ä¿¡å…ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ID
}
```

**æˆ»ã‚Šå€¤:**
```python
{
    "success": bool,
    "message_id": str,
    "error": str | None,
}
```

### 9.3. discord_list_channels

**ç›®çš„:** æ¥ç¶šå¯èƒ½ãªDiscordã‚µãƒ¼ãƒã¨ãƒãƒ£ãƒ³ãƒãƒ«ä¸€è¦§ã‚’å–å¾—ã™ã‚‹

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:**
```python
{
    "guild_id": str | None,   # ä»»æ„: ç‰¹å®šã‚µãƒ¼ãƒã®ã¿å–å¾—
    "include_threads": bool,  # ä»»æ„: ã‚¹ãƒ¬ãƒƒãƒ‰ã‚‚å«ã‚ã‚‹ã‹ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: true)
}
```

**æˆ»ã‚Šå€¤:**
```python
{
    "guilds": [
        {
            "id": str,
            "name": str,
            "channels": [
                {
                    "id": str,
                    "name": str,
                    "type": "text" | "thread" | "forum",
                    "parent_id": str | None,
                },
                ...
            ],
        },
        ...
    ],
}
```

---

## 10. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### 10.1. åŸºæœ¬æ–¹é‡

Discord Connectorã¯run_pulseå†…ã§ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦å‘¼ã³å‡ºã•ã‚Œã‚‹ã€‚ã‚¨ãƒ©ãƒ¼æ™‚ã¯ä¾‹å¤–ã‚’æŠ•ã’ãšã€ã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’å«ã‚€çµæœã‚’è¿”ã—ã¦run_pulseã®æœ¬æµã«æˆ»ã™ã€‚å…¨ã¦ã®ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒ™ãƒ«ï¼ˆCRITICAL/ERROR/WARNINGï¼‰ã§å¼·åˆ¶å¸°é‚„ã‚’å®Ÿè¡Œã—ã€è¨ªå•è€…ã‚’å®‰å…¨ã«ãƒ­ãƒ¼ã‚«ãƒ«Private Cityã®å…ƒå±…ãŸBuildingã«æˆ»ã™ã€‚

### 10.2. ã‚¨ãƒ©ãƒ¼åˆ†é¡ã¨å¯¾å¿œ

| ã‚«ãƒ†ã‚´ãƒª | HTTPã‚³ãƒ¼ãƒ‰ | å¯¾å¿œ | å¼·åˆ¶å¸°é‚„ |
|---------|-----------|------|---------|
| **ä¸€æ™‚çš„ã‚¨ãƒ©ãƒ¼** | 5xx, 503 | æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã§ãƒªãƒˆãƒ©ã‚¤ï¼ˆæœ€å¤§5å›ï¼‰ | ãƒªãƒˆãƒ©ã‚¤ä¸Šé™ã§å¸°é‚„ |
| **ãƒ¬ãƒ¼ãƒˆåˆ¶é™** | 429 | `Retry-After`ãƒ˜ãƒƒãƒ€ã«å¾“ã„å¾…æ©Ÿ | å¾…æ©Ÿå¾Œã‚‚å¤±æ•—ã§å¸°é‚„ |
| **èªè¨¼ã‚¨ãƒ©ãƒ¼** | 401, 403 | å³æ™‚åœæ­¢ | å…¨è¨ªå•è€…å¸°é‚„ |
| **ãƒªã‚½ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼** | 404 | ã‚¹ã‚­ãƒƒãƒ— + ãƒãƒƒãƒ”ãƒ³ã‚°ç„¡åŠ¹åŒ– | è©²å½“è¨ªå•è€…å¸°é‚„ |
| **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼** | 400 | ãƒ­ã‚°è¨˜éŒ² + ã‚¹ã‚­ãƒƒãƒ— | è©²å½“è¨ªå•è€…å¸°é‚„ |

### 10.3. æ·±åˆ»åº¦ã¨å¸°é‚„ç¯„å›²

| æ·±åˆ»åº¦ | æ¡ä»¶ | å¸°é‚„ç¯„å›² |
|-------|-----|---------|
| **CRITICAL** | Botåœæ­¢ã€Tokenç„¡åŠ¹ | å…¨è¨ªå•è€… |
| **ERROR** | åŒæœŸä¸­æ–­ã€ãƒªãƒˆãƒ©ã‚¤ä¸Šé™åˆ°é” | è©²å½“ãƒãƒ£ãƒ³ãƒãƒ«ã®è¨ªå•è€… |
| **WARNING** | ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã€ä¸€éƒ¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¤±æ•— | è©²å½“è¨ªå•è€…ã®ã¿ |

**NOTE**: åˆæœŸå®Ÿè£…ã§ã¯WARNING 1å›ã§å³å¸°é‚„ã€‚é‹ç”¨å®‰å®šå¾Œã«Nå›é€£ç¶šã§å¸°é‚„ã«å¤‰æ›´å¯èƒ½ã€‚

### 10.4. ãƒªãƒˆãƒ©ã‚¤æˆ¦ç•¥

```python
@dataclass
class RetryPolicy:
    max_retries: int = 5
    base_delay_seconds: float = 1.0
    max_delay_seconds: float = 60.0
    exponential_base: float = 2.0

    def get_delay(self, attempt: int) -> float:
        """æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ• + ã‚¸ãƒƒã‚¿ãƒ¼"""
        delay = min(
            self.base_delay_seconds * (self.exponential_base ** attempt),
            self.max_delay_seconds
        )
        jitter = random.uniform(0, delay * 0.1)
        return delay + jitter
```

**ãƒªãƒˆãƒ©ã‚¤å¯¾è±¡:**
- 5xx ã‚¨ãƒ©ãƒ¼
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
- æ¥ç¶šã‚¨ãƒ©ãƒ¼ï¼ˆ`aiohttp.ClientConnectorError`ï¼‰

**ãƒªãƒˆãƒ©ã‚¤å¯¾è±¡å¤–:**
- 4xx ã‚¨ãƒ©ãƒ¼ï¼ˆ400, 401, 403, 404ãªã©ï¼‰
- æ˜ç¤ºçš„ãªãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆ429ã¯åˆ¥å‡¦ç†ï¼‰

### 10.5. ãƒ„ãƒ¼ãƒ«æˆ»ã‚Šå€¤å½¢å¼

Discord Connectorã®ãƒ„ãƒ¼ãƒ«ã¯ä»¥ä¸‹ã®å½¢å¼ã§çµæœã‚’è¿”ã™:

**æˆåŠŸæ™‚:**
```python
{
    "success": True,
    "message_id": "123456789",
}
```

**ã‚¨ãƒ©ãƒ¼æ™‚ï¼ˆå¼·åˆ¶å¸°é‚„ç™ºç”Ÿï¼‰:**
```python
{
    "success": False,
    "error": "Rate limit exceeded after 5 retries",
    "forced_return": True,
    "return_to": {
        "city_id": "private_city_bob",
        "building_id": "living_room",
    },
    "severity": "WARNING",
}
```

### 10.6. run_pulseå´ã§ã®å‡¦ç†

```python
# PersonaCore.run_pulse() å†…ã§ã®ãƒ„ãƒ¼ãƒ«çµæœå‡¦ç†
tool_result = execute_tool("discord_send_message", args)

if not tool_result.get("success") and tool_result.get("forced_return"):
    # å¼·åˆ¶å¸°é‚„ãŒç™ºç”Ÿ â†’ ãƒšãƒ«ã‚½ãƒŠã®çŠ¶æ…‹ã‚’æ›´æ–°ã—ã¦pulseçµ‚äº†
    self._handle_forced_return(tool_result)
    return  # æœ¬æµã«æˆ»ã‚‹ï¼ˆã‚¨ãƒ©ãƒ¼ã§ã¯ãªãæ­£å¸¸çµ‚äº†ï¼‰

# æˆåŠŸæ™‚ã¯é€šå¸¸ã®å‡¦ç†ã‚’ç¶™ç¶š
```

### 10.7. å¼·åˆ¶å¸°é‚„ã®å®Ÿè£…

```python
class ErrorSeverity(Enum):
    CRITICAL = "critical"  # å…¨è¨ªå•è€…ã‚’å¸°é‚„
    ERROR = "error"        # è©²å½“ãƒãƒ£ãƒ³ãƒãƒ«ã®è¨ªå•è€…ã‚’å¸°é‚„
    WARNING = "warning"    # è©²å½“è¨ªå•è€…ã®ã¿å¸°é‚„

async def handle_error_with_forced_return(
    self,
    severity: ErrorSeverity,
    error: Exception,
    channel_id: Optional[int] = None,
    persona_id: Optional[str] = None,
) -> dict:
    """ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«è¨ªå•è€…ã‚’å¼·åˆ¶å¸°é‚„ã•ã›ã€ãƒ„ãƒ¼ãƒ«çµæœã‚’è¿”ã™"""

    logger.log(
        logging.CRITICAL if severity == ErrorSeverity.CRITICAL else logging.ERROR,
        "Error occurred: %s (severity=%s, channel=%s, persona=%s)",
        error, severity, channel_id, persona_id
    )

    # å¸°é‚„å¯¾è±¡ã®æ±ºå®š
    if severity == ErrorSeverity.CRITICAL:
        targets = list(self._active_visits.values())
    elif severity == ErrorSeverity.ERROR and channel_id:
        targets = [
            v for v in self._active_visits.values()
            if v.discord_channel_id == channel_id
        ]
    elif severity == ErrorSeverity.WARNING and persona_id:
        visit = self._active_visits.get(persona_id)
        targets = [visit] if visit else []
    else:
        targets = []

    # å¼·åˆ¶å¸°é‚„å®Ÿè¡Œ
    return_info = None
    for visit_state in targets:
        return_info = await self._force_return_to_home(
            visit_state,
            reason=f"{type(error).__name__}: {error}"
        )

    # ãƒ„ãƒ¼ãƒ«çµæœå½¢å¼ã§è¿”ã™
    return {
        "success": False,
        "error": str(error),
        "forced_return": True,
        "return_to": return_info,
        "severity": severity.value,
    }

async def _force_return_to_home(
    self,
    visit_state: VisitState,
    reason: str,
) -> dict:
    """è¨ªå•è€…ã‚’ãƒ­ãƒ¼ã‚«ãƒ«Private Cityã®å…ƒå±…ãŸBuildingã«æˆ»ã™"""

    persona_id = visit_state.persona_id
    home_city = visit_state.home_city_id
    home_building = visit_state.home_building_id

    logger.warning(
        "Force returning persona %s to %s/%s. Reason: %s",
        persona_id, home_city, home_building, reason
    )

    # 1. Discordå´ã«é€€å‡ºé€šçŸ¥ï¼ˆå¯èƒ½ãªã‚‰ï¼‰
    try:
        await self._send_system_notification(
            visit_state.discord_channel_id,
            notification_type="forced_leave",
            persona_id=persona_id,
            reason=reason,
        )
    except Exception as e:
        logger.warning("Could not send leave notification: %s", e)

    # 2. VisitStateã®æ›´æ–°
    visit_state.status = VisitStatus.FORCE_RETURNED
    visit_state.ended_at = datetime.utcnow()
    visit_state.return_reason = reason

    # 3. connector.dbã«è¨˜éŒ²
    await self._db.execute(
        """
        UPDATE visit_sessions
        SET status = 'force_returned',
            ended_at = ?,
            return_reason = ?
        WHERE persona_id = ? AND status = 'active'
        """,
        (datetime.utcnow(), reason, persona_id)
    )

    # 4. ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è¨ªå•ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
    self._active_visits.pop(persona_id, None)

    return {
        "city_id": home_city,
        "building_id": home_building,
    }
```

### 10.8. VisitStateã®æ‹¡å¼µ

```python
@dataclass
class VisitState:
    persona_id: str
    home_city_id: str
    home_building_id: str      # è¨ªå•é–‹å§‹å‰ã®å±…å ´æ‰€
    visiting_city_id: str
    visiting_building_id: str
    discord_channel_id: int
    status: VisitStatus
    started_at: datetime
    ended_at: Optional[datetime] = None
    return_reason: Optional[str] = None  # å¸°é‚„ç†ç”±

class VisitStatus(Enum):
    ACTIVE = "active"
    ENDED = "ended"
    FORCE_RETURNED = "force_returned"
```

### 10.9. connector.db ã‚¹ã‚­ãƒ¼ãƒæ‹¡å¼µ

```sql
-- visit_sessionsãƒ†ãƒ¼ãƒ–ãƒ«ã«å¸°é‚„ç†ç”±ã‚’è¿½åŠ 
ALTER TABLE visit_sessions ADD COLUMN return_reason TEXT;
```

### 10.10. ãƒ­ã‚°å½¢å¼ï¼ˆæ§‹é€ åŒ–JSONï¼‰

```json
{
    "timestamp": "2025-01-09T12:00:00Z",
    "level": "ERROR",
    "component": "discord_connector",
    "event": "forced_return",
    "persona_id": "bob_persona",
    "return_to": {
        "city_id": "private_city_bob",
        "building_id": "living_room"
    },
    "error_type": "discord.HTTPException",
    "error_code": 429,
    "error_message": "Rate limit exceeded",
    "severity": "WARNING"
}
```

---

## 11. ç’°å¢ƒå¤‰æ•°

| å¤‰æ•°å | èª¬æ˜ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ |
|--------|------|-----------|
| `DISCORD_BOT_TOKEN` | Discord Bot ã®ãƒˆãƒ¼ã‚¯ãƒ³ | (å¿…é ˆ) |
| `DISCORD_CONNECTOR_ENABLED` | Discord Connector ã‚’æœ‰åŠ¹åŒ– | 0 |
| `DISCORD_DEFAULT_MESSAGE_LIMIT` | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»¶æ•° | 50 |
| `DISCORD_MAX_MESSAGE_LENGTH` | é€ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æœ€å¤§æ–‡å­—æ•° | 2000 |
| `DISCORD_SYNC_ON_START` | èµ·å‹•æ™‚ã«æ—¢å­˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’åŒæœŸã™ã‚‹ã‹ | 1 |
| `DISCORD_SYNC_HISTORY_LIMIT` | èµ·å‹•æ™‚åŒæœŸã§å–å¾—ã™ã‚‹å±¥æ­´ä»¶æ•° | 100 |

---

## 12. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### 12.1. ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†

- `DISCORD_BOT_TOKEN` ã¯ `.env` ãƒ•ã‚¡ã‚¤ãƒ«ã§ç®¡ç†
- `.env` ã¯ `.gitignore` ã«å«ã‚ã€ãƒªãƒã‚¸ãƒˆãƒªã«ã‚³ãƒŸãƒƒãƒˆã—ãªã„
- æœ¬ç•ªç’°å¢ƒã§ã¯OSã®è³‡æ ¼æƒ…å ±ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®ä½¿ç”¨ã‚’æ¨å¥¨

**ãƒ­ã‚°å‡ºåŠ›æ™‚ã®ãƒã‚¹ã‚­ãƒ³ã‚°:**
```python
class SecureLogger:
    """Tokenç­‰ã®æ©Ÿå¯†æƒ…å ±ã‚’ãƒã‚¹ã‚¯ã™ã‚‹ãƒ­ã‚¬ãƒ¼"""

    SENSITIVE_PATTERNS = [
        (r"[A-Za-z0-9_-]{24}\.[A-Za-z0-9_-]{6}\.[A-Za-z0-9_-]{27}", "[BOT_TOKEN]"),
        (r"sk-[A-Za-z0-9]{48}", "[API_KEY]"),
    ]

    def sanitize(self, message: str) -> str:
        for pattern, replacement in self.SENSITIVE_PATTERNS:
            message = re.sub(pattern, replacement, message)
        return message
```

### 12.2. Botæ¨©é™

Botã«ã¯å¿…è¦æœ€å°é™ã®æ¨©é™ã®ã¿ä»˜ä¸ï¼š

| æ¨©é™ | å¿…è¦æ€§ |
|------|--------|
| `Read Messages / View Channels` | âœ… å¿…é ˆ |
| `Send Messages` | âœ… å¿…é ˆ |
| `Read Message History` | âœ… å¿…é ˆ |
| `Manage Threads` | â–³ ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆã™ã‚‹å ´åˆã®ã¿ |
| `Administrator` | âŒ ä¸è¦ |

### 12.3. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ãƒ¼ãƒˆåˆ¶é™

Discord APIã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã«åŠ ãˆã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ãƒ™ãƒ«ã§ã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’å®Ÿè£…ï¼š

| æ“ä½œ | åˆ¶é™å€¤ | è¶…éæ™‚ã®æŒ™å‹• |
|------|--------|-------------|
| ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ï¼ˆãƒšãƒ«ã‚½ãƒŠï¼‰ | 5 msg/min/persona | ã‚­ãƒ¥ãƒ¼å¾…æ©Ÿ |
| ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰ | 10 msg/min/user | è­¦å‘Šâ†’ç„¡è¦– |
| è¨ªå•ãƒªã‚¯ã‚¨ã‚¹ãƒˆ | 3 req/hour/persona | æ‹’å¦ |
| ãƒ•ã‚¡ã‚¤ãƒ«è»¢é€ | 5 files/hour/persona | ã‚­ãƒ¥ãƒ¼å¾…æ©Ÿ |

```python
class RateLimiter:
    def __init__(self):
        self._limits: Dict[str, List[datetime]] = {}

    def check(self, key: str, limit: int, window_seconds: int) -> bool:
        now = datetime.now()
        if key not in self._limits:
            self._limits[key] = []

        # ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦å¤–ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å‰Šé™¤
        self._limits[key] = [
            t for t in self._limits[key]
            if (now - t).total_seconds() < window_seconds
        ]

        if len(self._limits[key]) >= limit:
            return False

        self._limits[key].append(now)
        return True
```

### 12.4. ãƒšãƒ«ã‚½ãƒŠã®ãªã‚Šã™ã¾ã—é˜²æ­¢

**æ–¹å¼**: Embedã®footerã«ç½²åã‚’å«ã‚ã‚‹

```
pid:<persona_id>|cid:<city_id>|ts:<timestamp>|sig:<signature>
```

**ç½²åç”Ÿæˆ:**
```python
import hmac
import hashlib

def generate_signature(persona_id: str, city_id: str, timestamp: int, secret: str) -> str:
    """HMAC-SHA256ç½²åã‚’ç”Ÿæˆ"""
    message = f"{persona_id}:{city_id}:{timestamp}"
    return hmac.new(
        secret.encode(),
        message.encode(),
        hashlib.sha256
    ).hexdigest()[:16]  # çŸ­ç¸®ã—ã¦å¯èª­æ€§ç¢ºä¿

def verify_signature(metadata: dict, secret: str, max_age_seconds: int = 300) -> bool:
    """ç½²åã‚’æ¤œè¨¼"""
    now = int(datetime.now().timestamp())
    ts = int(metadata.get("ts", 0))

    # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒå¤ã™ãã‚‹å ´åˆã¯æ‹’å¦ï¼ˆãƒªãƒ—ãƒ¬ã‚¤æ”»æ’ƒé˜²æ­¢ï¼‰
    if abs(now - ts) > max_age_seconds:
        return False

    expected = generate_signature(
        metadata["pid"],
        metadata["cid"],
        ts,
        secret
    )
    return hmac.compare_digest(expected, metadata.get("sig", ""))
```

**å…±æœ‰ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ç®¡ç†:**
- ç’°å¢ƒå¤‰æ•° `DISCORD_CONNECTOR_SECRET` ã§è¨­å®š
- å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåŒã˜ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å…±æœ‰ã™ã‚‹å¿…è¦ã‚ã‚Šï¼ˆæ‹›å¾…æ™‚ã«å…±æœ‰ï¼‰
- å°†æ¥çš„ã«ã¯å…¬é–‹éµæš—å·æ–¹å¼ã¸ã®ç§»è¡Œã‚’æ¤œè¨

### 12.5. Discordãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èªè¨¼

**åŸºæœ¬æ–¹é‡**: Discord IDã«ã‚ˆã‚‹è‡ªå‹•èªè¨¼

```python
@dataclass
class DiscordUserIdentity:
    discord_user_id: str      # Discordã®ä¸€æ„ID
    discord_username: str     # è¡¨ç¤ºå
    first_seen: datetime
    message_count: int = 0
    is_blocked: bool = False

async def identify_discord_user(message: discord.Message) -> DiscordUserIdentity:
    """Discordãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è­˜åˆ¥ï¼ˆauthor.bot == Falseã®å ´åˆã®ã¿å‘¼ã³å‡ºã—ï¼‰"""
    return DiscordUserIdentity(
        discord_user_id=str(message.author.id),
        discord_username=message.author.display_name,
        first_seen=datetime.now(),
    )
```

**ãªã‚Šã™ã¾ã—é˜²æ­¢:**
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ `author.bot == False` ã§åˆ¤åˆ¥
- BotãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãªã‚Šã™ã¾ã™ã“ã¨ã¯ä¸å¯èƒ½ï¼ˆDiscord APIã®ä»•æ§˜ï¼‰
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒšãƒ«ã‚½ãƒŠã«ãªã‚Šã™ã¾ã™ã“ã¨ã‚‚ä¸å¯èƒ½ï¼ˆEmbedé€ä¿¡ã¯Botã®ã¿ï¼‰

### 12.6. è¨ªå•è¨±å¯/æ‹’å¦ãƒªã‚¹ãƒˆ

Public CityæŒã¡ä¸»ãŒã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠå¯èƒ½ï¼š

| ãƒ¢ãƒ¼ãƒ‰ | èª¬æ˜ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ |
|--------|------|-----------|
| `allowlist` | è¨±å¯ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã‚‹ãƒšãƒ«ã‚½ãƒŠ/ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿å‚åŠ å¯èƒ½ | âœ… |
| `blocklist` | æ‹’å¦ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã‚‹ãƒšãƒ«ã‚½ãƒŠ/ãƒ¦ãƒ¼ã‚¶ãƒ¼ä»¥å¤–ã¯å‚åŠ å¯èƒ½ | |
| `open` | å…¨å“¡å‚åŠ å¯èƒ½ï¼ˆãƒšãƒ«ã‚½ãƒŠã¯ç½²åæ¤œè¨¼ã®ã¿ï¼‰ | |

**å¯¾è±¡ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£:**

| ç¨®åˆ¥ | è­˜åˆ¥å­ | èª¬æ˜ |
|------|--------|------|
| ãƒšãƒ«ã‚½ãƒŠ | `persona:<persona_id>` | ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®AIãƒšãƒ«ã‚½ãƒŠ |
| Discordãƒ¦ãƒ¼ã‚¶ãƒ¼ | `user:<discord_user_id>` | Discordã®äººé–“ãƒ¦ãƒ¼ã‚¶ãƒ¼ |

```python
from enum import Enum

class AccessMode(Enum):
    ALLOWLIST = "allowlist"  # ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆæ–¹å¼ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
    BLOCKLIST = "blocklist"  # ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆæ–¹å¼
    OPEN = "open"            # å…¨å“¡è¨±å¯ï¼ˆãƒšãƒ«ã‚½ãƒŠã¯ç½²åæ¤œè¨¼ã®ã¿ï¼‰

class EntityType(Enum):
    PERSONA = "persona"
    USER = "user"

@dataclass
class AccessControl:
    city_id: str
    mode: AccessMode = AccessMode.ALLOWLIST
    allowlist: List[str] = field(default_factory=list)  # "persona:<id>" or "user:<id>"
    blocklist: List[str] = field(default_factory=list)

    def _make_key(self, entity_type: EntityType, entity_id: str) -> str:
        """ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚­ãƒ¼ã‚’ç”Ÿæˆ"""
        return f"{entity_type.value}:{entity_id}"

    def is_allowed(
        self,
        entity_type: EntityType,
        entity_id: str,
        signature_valid: bool = True  # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã¯å¸¸ã«True
    ) -> bool:
        """å‚åŠ ã‚’è¨±å¯ã™ã‚‹ã‹åˆ¤å®š"""
        # ãƒšãƒ«ã‚½ãƒŠã®å ´åˆã€ç½²åãŒç„¡åŠ¹ãªã‚‰æ‹’å¦
        if entity_type == EntityType.PERSONA and not signature_valid:
            return False

        key = self._make_key(entity_type, entity_id)

        if self.mode == AccessMode.OPEN:
            return True
        elif self.mode == AccessMode.ALLOWLIST:
            return key in self.allowlist
        else:  # BLOCKLIST
            return key not in self.blocklist

    def set_mode(self, mode: AccessMode) -> None:
        """ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãƒ¢ãƒ¼ãƒ‰ã‚’å¤‰æ›´"""
        self.mode = mode

    def add_to_allowlist(self, entity_type: EntityType, entity_id: str) -> None:
        key = self._make_key(entity_type, entity_id)
        if key not in self.allowlist:
            self.allowlist.append(key)

    def remove_from_allowlist(self, entity_type: EntityType, entity_id: str) -> None:
        key = self._make_key(entity_type, entity_id)
        if key in self.allowlist:
            self.allowlist.remove(key)

    def add_to_blocklist(self, entity_type: EntityType, entity_id: str) -> None:
        key = self._make_key(entity_type, entity_id)
        if key not in self.blocklist:
            self.blocklist.append(key)

    def remove_from_blocklist(self, entity_type: EntityType, entity_id: str) -> None:
        key = self._make_key(entity_type, entity_id)
        if key in self.blocklist:
            self.blocklist.remove(key)
```

**connector.dbã¸ã®ä¿å­˜:**
```sql
CREATE TABLE city_access_control (
    city_id TEXT PRIMARY KEY,
    mode TEXT NOT NULL DEFAULT 'allowlist',  -- 'allowlist', 'blocklist', 'open'
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE city_access_list (
    city_id TEXT NOT NULL,
    entity_type TEXT NOT NULL,  -- 'persona' or 'user'
    entity_id TEXT NOT NULL,    -- persona_id or discord_user_id
    list_type TEXT NOT NULL,    -- 'allow' or 'block'
    added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (city_id, entity_type, entity_id, list_type),
    FOREIGN KEY (city_id) REFERENCES city_access_control(city_id)
);
```

**ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãƒ„ãƒ¼ãƒ«:**

```python
# discord_set_access_mode ãƒ„ãƒ¼ãƒ«
def discord_set_access_mode(city_id: str, mode: str) -> dict:
    """Public Cityã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãƒ¢ãƒ¼ãƒ‰ã‚’è¨­å®š"""
    if mode not in ["allowlist", "blocklist", "open"]:
        return {"success": False, "error": "Invalid mode"}
    # DBæ›´æ–°å‡¦ç†
    return {"success": True, "city_id": city_id, "mode": mode}

# discord_manage_access_list ãƒ„ãƒ¼ãƒ«
def discord_manage_access_list(
    city_id: str,
    action: str,       # "add" or "remove"
    list_type: str,    # "allow" or "block"
    entity_type: str,  # "persona" or "user"
    entity_id: str     # persona_id or discord_user_id
) -> dict:
    """è¨±å¯/æ‹’å¦ãƒªã‚¹ãƒˆã‚’ç®¡ç†ï¼ˆãƒšãƒ«ã‚½ãƒŠ/ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸¡å¯¾å¿œï¼‰"""
    if entity_type not in ["persona", "user"]:
        return {"success": False, "error": "Invalid entity_type"}
    # DBæ›´æ–°å‡¦ç†
    return {
        "success": True,
        "action": action,
        "list_type": list_type,
        "entity_type": entity_type,
        "entity_id": entity_id
    }
```

### 12.7. ã‚¹ãƒ‘ãƒ æ¤œçŸ¥ã¨è‡ªå‹•ãƒ–ãƒ­ãƒƒã‚¯

```python
@dataclass
class SpamDetector:
    # çŸ­æ™‚é–“ã«åŒä¸€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ = ã‚¹ãƒ‘ãƒ 
    duplicate_threshold: int = 3      # 3å›ä»¥ä¸Š
    duplicate_window_seconds: int = 60

    # çŸ­æ™‚é–“ã«å¤§é‡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ = ã‚¹ãƒ‘ãƒ 
    flood_threshold: int = 20         # 20ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä»¥ä¸Š
    flood_window_seconds: int = 60

    _message_history: Dict[str, List[Tuple[datetime, str]]] = field(default_factory=dict)

    def check(self, author_id: str, content: str) -> SpamCheckResult:
        now = datetime.now()

        if author_id not in self._message_history:
            self._message_history[author_id] = []

        # å¤ã„ã‚¨ãƒ³ãƒˆãƒªã‚’å‰Šé™¤
        window_start = now - timedelta(seconds=max(
            self.duplicate_window_seconds,
            self.flood_window_seconds
        ))
        self._message_history[author_id] = [
            (ts, msg) for ts, msg in self._message_history[author_id]
            if ts > window_start
        ]

        # é‡è¤‡ãƒã‚§ãƒƒã‚¯
        duplicate_count = sum(
            1 for ts, msg in self._message_history[author_id]
            if msg == content and (now - ts).total_seconds() < self.duplicate_window_seconds
        )
        if duplicate_count >= self.duplicate_threshold:
            return SpamCheckResult(is_spam=True, reason="duplicate")

        # ãƒ•ãƒ©ãƒƒãƒ‰ãƒã‚§ãƒƒã‚¯
        recent_count = sum(
            1 for ts, _ in self._message_history[author_id]
            if (now - ts).total_seconds() < self.flood_window_seconds
        )
        if recent_count >= self.flood_threshold:
            return SpamCheckResult(is_spam=True, reason="flood")

        # è¨˜éŒ²
        self._message_history[author_id].append((now, content))
        return SpamCheckResult(is_spam=False, reason=None)

@dataclass
class SpamCheckResult:
    is_spam: bool
    reason: Optional[str]  # "duplicate", "flood", None
```

**è‡ªå‹•ãƒ–ãƒ­ãƒƒã‚¯ãƒãƒªã‚·ãƒ¼:**

| ã‚¹ãƒ‘ãƒ æ¤œçŸ¥å›æ•° | å¯¾å¿œ |
|---------------|------|
| 3å› | 10åˆ†é–“ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ |
| 5å› | 1æ™‚é–“ãƒ–ãƒ­ãƒƒã‚¯ |
| 10å› | 24æ™‚é–“ãƒ–ãƒ­ãƒƒã‚¯ |

```python
@dataclass
class AutoBlockPolicy:
    thresholds: List[Tuple[int, int]] = field(default_factory=lambda: [
        (3, 600),      # 3å› â†’ 10åˆ†
        (5, 3600),     # 5å› â†’ 1æ™‚é–“
        (10, 86400),   # 10å› â†’ 24æ™‚é–“
    ])

    def get_block_duration(self, spam_count: int) -> int:
        """ã‚¹ãƒ‘ãƒ æ¤œçŸ¥å›æ•°ã«å¿œã˜ãŸãƒ–ãƒ­ãƒƒã‚¯æ™‚é–“ï¼ˆç§’ï¼‰ã‚’è¿”ã™"""
        for threshold, duration in reversed(self.thresholds):
            if spam_count >= threshold:
                return duration
        return 0
```

### 12.8. ç®¡ç†è€…é€šçŸ¥

```python
async def notify_admin(self, event: str, details: dict):
    """ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç®¡ç†è€…ã«é€šçŸ¥"""

    # æ§‹é€ åŒ–ãƒ­ã‚°
    logger.warning(
        f"Security event: {event}",
        extra={
            "event_type": event,
            "details": details,
            "timestamp": datetime.now().isoformat(),
        }
    )

    # Discord DMé€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    if self._config.admin_dm_enabled and self._config.admin_user_id:
        try:
            admin_user = await self._client.fetch_user(self._config.admin_user_id)
            embed = discord.Embed(
                title=f"âš ï¸ Security Alert: {event}",
                description=f"```json\n{json.dumps(details, indent=2, ensure_ascii=False)}\n```",
                color=0xFF0000,
                timestamp=datetime.now()
            )
            await admin_user.send(embed=embed)
        except discord.HTTPException as e:
            logger.error(f"Failed to notify admin: {e}")
```

**é€šçŸ¥å¯¾è±¡ã‚¤ãƒ™ãƒ³ãƒˆ:**

| ã‚¤ãƒ™ãƒ³ãƒˆ | èª¬æ˜ |
|---------|------|
| `spam_detected` | ã‚¹ãƒ‘ãƒ æ¤œçŸ¥ |
| `auto_blocked` | è‡ªå‹•ãƒ–ãƒ­ãƒƒã‚¯ç™ºå‹• |
| `invalid_signature` | ç½²åæ¤œè¨¼å¤±æ•— |
| `access_denied` | ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦ï¼ˆè¨±å¯ãƒªã‚¹ãƒˆå¤–ï¼‰ |
| `rate_limit_exceeded` | ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¶…é |

---

## 13. æ—¢å­˜è³‡ç”£ã®æ´»ç”¨

### 13.1. æµç”¨å¯èƒ½ãªã‚³ãƒ¼ãƒ‰

| ãƒ•ã‚¡ã‚¤ãƒ« | æµç”¨éƒ¨åˆ† | ç”¨é€” |
|----------|----------|------|
| `discord_gateway/bot/discord_client.py` | Intentè¨­å®šãƒ‘ã‚¿ãƒ¼ãƒ³ | ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ– |
| `discord_gateway/config.py` | Pydantic Settings ãƒ‘ã‚¿ãƒ¼ãƒ³ | è¨­å®šç®¡ç† |
| `discord_gateway/translator.py` | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯ | ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ•´å½¢ |
| `discord_gateway/mapping.py` | ãƒãƒ£ãƒ³ãƒãƒ«ãƒãƒƒãƒ”ãƒ³ã‚°æ§‹é€  | ãƒãƒƒãƒ”ãƒ³ã‚°ç®¡ç† |

### 13.2. ä¸è¦ã«ãªã‚‹ã‚³ãƒ¼ãƒ‰

- `discord_gateway/bot/` é…ä¸‹ã® Bot ã‚µãƒ¼ãƒé–¢é€£ï¼ˆws_server, connection_managerï¼‰
- `discord_gateway/orchestrator.py` (WebSocketä¸­ç¶™ç®¡ç†)
- `discord_gateway/gateway_service.py` (Gateway ãƒ–ãƒªãƒƒã‚¸)
- è¨˜æ†¶åŒæœŸãƒ—ãƒ­ãƒˆã‚³ãƒ« (`memory_sync_*`)
- å†åŒæœŸ/ãƒªãƒ—ãƒ¬ã‚¤æ©Ÿæ§‹

---

## 14. å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

### Phase 1: åŸºç›¤å®Ÿè£…

- [ ] `discord_connector/connector.py` - ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹
- [ ] `discord_connector/client.py` - Discord Client ãƒ©ãƒƒãƒ‘ãƒ¼
- [ ] `discord_connector/config.py` - è¨­å®šç®¡ç†
- [ ] `discord_connector/mapping.py` - ãƒãƒƒãƒ”ãƒ³ã‚°ç®¡ç†
- [ ] èµ·å‹•/åœæ­¢æ™‚ã®æ¥ç¶šç®¡ç†
- [ ] åŸºæœ¬çš„ãªãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

### Phase 2: åŒæœŸæ©Ÿèƒ½

- [ ] `discord_connector/sync.py` - åŒæœŸãƒ­ã‚¸ãƒƒã‚¯
- [ ] èµ·å‹•æ™‚ã®æ—¢å­˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸åŒæœŸ
- [ ] ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ãƒ»è¨˜éŒ²
- [ ] Buildingãƒ­ã‚°ã¸ã®è¿½è¨˜
- [ ] ãƒšãƒ«ã‚½ãƒŠSAIMemoryã¸ã®è¿½è¨˜

### Phase 3: ãƒ„ãƒ¼ãƒ«å®Ÿè£…

- [ ] `tools/defs/discord_read_thread.py`
- [ ] `tools/defs/discord_send_message.py`
- [ ] `tools/defs/discord_list_channels.py`
- [ ] Playbooké€£æºãƒ†ã‚¹ãƒˆ

### Phase 4: è¨ªå•ã‚·ã‚¹ãƒ†ãƒ 

- [ ] è¨ªå•ãƒšãƒ«ã‚½ãƒŠã®è­˜åˆ¥
- [ ] è¨ªå•ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
- [ ] è¨ªå•ãƒšãƒ«ã‚½ãƒŠã¸ã®å¿œç­”ãƒˆãƒªã‚¬ãƒ¼
- [ ] çµ±åˆãƒ†ã‚¹ãƒˆ

### Phase 5: å¼·åˆ¶é€é‚„ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«è»¢é€ãƒ»UI

- [ ] **å¼·åˆ¶é€é‚„ã‚·ã‚¹ãƒ†ãƒ **
  - [ ] `VisitState` ã‚¯ãƒ©ã‚¹ã®å®Ÿè£…
  - [ ] ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹è¿½è·¡ (`PresenceTracker`)
  - [ ] Hoståœæ­¢æ¤œçŸ¥ã¨å¼·åˆ¶é€é‚„ãƒ­ã‚¸ãƒƒã‚¯
  - [ ] å†æ¥ç¶šãƒãƒªã‚·ãƒ¼ (`ReconnectPolicy`) ã®å®Ÿè£…
  - [ ] å¼·åˆ¶é€é‚„æ™‚ã®è¨˜æ†¶è¨˜éŒ²

- [ ] **ãƒ•ã‚¡ã‚¤ãƒ«è»¢é€ã‚·ã‚¹ãƒ†ãƒ **
  - [ ] `FileTransferOptions` ã®Toolã‚¹ã‚­ãƒ¼ãƒæ‹¡å¼µ
  - [ ] åœ§ç¸®å‡¦ç† (zip/gzip)
  - [ ] Discordæ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡
  - [ ] å—ä¿¡å´ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ»è§£å‡å‡¦ç†
  - [ ] è»¢é€å±¥æ­´ã®DBè¨˜éŒ²

- [ ] **ç‹¬ç«‹Gradio UI**
  - [ ] `tools/discord/ui/app.py` ãƒ¡ã‚¤ãƒ³èµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
  - [ ] æ¥ç¶šçŠ¶æ…‹ãƒ‘ãƒãƒ« (`connection_panel.py`)
  - [ ] ãƒãƒƒãƒ”ãƒ³ã‚°ç·¨é›†UI (`mapping_editor.py`)
  - [ ] è¨ªå•ãƒ¢ãƒ‹ã‚¿ (`visit_monitor.py`)
  - [ ] åŒæœŸãƒ­ã‚°ãƒ“ãƒ¥ãƒ¼ã‚¢ (`log_viewer.py`)

- [ ] **ç‹¬ç«‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**
  - [ ] `connector.db` ã‚¹ã‚­ãƒ¼ãƒå®šç¾©
  - [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ (`tools/discord/db/migrate.py`)
  - [ ] SAIVerseæœ¬ä½“ã¨ã®é€£æºã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

### Phase 6: å“è³ªä¿è¨¼ãƒ»ãƒªãƒªãƒ¼ã‚¹æº–å‚™

- [ ] **ãƒ†ã‚¹ãƒˆ**
  - [ ] ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆå„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼‰
  - [ ] çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆè¨ªå•ãƒ•ãƒ­ãƒ¼å…¨ä½“ï¼‰
  - [ ] è² è·ãƒ†ã‚¹ãƒˆï¼ˆè¤‡æ•°è¨ªå•è€…åŒæ™‚æ¥ç¶šï¼‰
  - [ ] å†æ¥ç¶šã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆ

- [ ] **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**
  - [ ] ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰ï¼ˆBot Tokenå–å¾—æ‰‹é †ï¼‰
  - [ ] é‹ç”¨ã‚¬ã‚¤ãƒ‰ï¼ˆãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼‰
  - [ ] APIãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ï¼ˆToolä»•æ§˜è©³ç´°ï¼‰

- [ ] **ãƒªãƒªãƒ¼ã‚¹æº–å‚™**
  - [ ] ç’°å¢ƒå¤‰æ•°ã®æœ€çµ‚èª¿æ•´
  - [ ] ãƒ­ã‚°å‡ºåŠ›ãƒ¬ãƒ™ãƒ«ã®èª¿æ•´
  - [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°

---

## 15. æ—§ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨ã®æ¯”è¼ƒ

| é …ç›® | æ—§ (v5) | æ–° (v6) |
|------|---------|---------|
| **ä¸­å¤®ã‚µãƒ¼ãƒ** | å¿…è¦ (24æ™‚é–“ç¨¼åƒBot) | **ä¸è¦** |
| **æ¥ç¶šæ–¹å¼** | SAIVerse â†’ Bot â†’ Discord | **SAIVerse â†’ Discord ç›´æ¥** |
| **èªè¨¼** | OAuth2 + ç‹¬è‡ªãƒˆãƒ¼ã‚¯ãƒ³ | **Bot Token ã®ã¿** |
| **åŒæœŸæ–¹å¼** | BotçµŒç”±ã®ä¸­ç¶™ | **WebSocketç›´æ¥æ¥ç¶š** |
| **å®Ÿè£…è¤‡é›‘åº¦** | é«˜ (Bot, Gateway, Orchestrator) | **ä½** |
| **é‹ç”¨ã‚³ã‚¹ãƒˆ** | é«˜ (ã‚µãƒ¼ãƒãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°) | **ãªã— (ãƒ­ãƒ¼ã‚«ãƒ«å®Œçµ)** |
| **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§** | é«˜ | **é«˜** |
| **ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚** | BotçµŒç”±ã§ã‚­ãƒ¥ãƒ¼å¯èƒ½ | ä¸å¯ï¼ˆSAIVerseèµ·å‹•å¿…é ˆï¼‰ |

---

## 16. åˆ¶é™äº‹é …ã¨ä»Šå¾Œã®å±•æœ›

### 16.1. ç¾æ™‚ç‚¹ã§ã®åˆ¶é™

- **ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã®å—ä¿¡ä¸å¯**: SAIVerseåœæ­¢ä¸­ã¯Discordãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã§ããªã„ï¼ˆèµ·å‹•æ™‚ã«å·®åˆ†åŒæœŸï¼‰
- **1ãƒ¦ãƒ¼ã‚¶ãƒ¼1Bot**: å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåˆ†ã®Bot Tokenã‚’ç”¨æ„ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
- **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**: å¤§é‡ã®Public Cityã‚’æŒã¤å ´åˆã€WebSocketæ¥ç¶šã®è² è·ãŒå¢—åŠ 

### 16.2. å°†æ¥ã®æ‹¡å¼µå€™è£œ

1. **å…±æœ‰Bot**: è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§1ã¤ã®Botã‚’å…±æœ‰ã™ã‚‹ä»•çµ„ã¿ï¼ˆOAuth2èªè¨¼ã®å¾©æ´»ï¼‰
2. **Webhooké€£æº**: åœæ­¢ä¸­ã‚‚Webhookã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ã€èµ·å‹•æ™‚ã«å‡¦ç†
3. **ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å¯¾å¿œ**: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¸ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ /èª­ã¿å–ã‚Š
4. **ã‚¹ãƒ¬ãƒƒãƒ‰è‡ªå‹•ä½œæˆ**: ãƒšãƒ«ã‚½ãƒŠãŒæ–°è¦Buildingã‚’ä½œæˆæ™‚ã«ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’è‡ªå‹•ä½œæˆ

---

## 17. å‚è€ƒè³‡æ–™

- [Discord.py Documentation](https://discordpy.readthedocs.io/)
- [Discord Developer Portal](https://discord.com/developers/docs)
- [Discord Gateway (WebSocket) Documentation](https://discord.com/developers/docs/topics/gateway)
- [SAIVerse Toolä»•æ§˜](../../CLAUDE.md) - `tools/defs/` ã‚»ã‚¯ã‚·ãƒ§ãƒ³å‚ç…§
- [SAIVerse Playbookä»•æ§˜](../../CLAUDE.md) - Playbookè¨­è¨ˆå“²å­¦ã‚»ã‚¯ã‚·ãƒ§ãƒ³å‚ç…§
